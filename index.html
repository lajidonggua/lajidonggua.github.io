<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.21">
<title>Messenger - Example Server Project</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
pre.pygments .hll { background-color: #ffffcc }
pre.pygments { background: #f8f8f8; }
pre.pygments .tok-c { color: #3D7B7B; font-style: italic } /* Comment */
pre.pygments .tok-err { border: 1px solid #FF0000 } /* Error */
pre.pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
pre.pygments .tok-o { color: #666666 } /* Operator */
pre.pygments .tok-ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
pre.pygments .tok-cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
pre.pygments .tok-cp { color: #9C6500 } /* Comment.Preproc */
pre.pygments .tok-cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
pre.pygments .tok-c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
pre.pygments .tok-cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
pre.pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
pre.pygments .tok-ge { font-style: italic } /* Generic.Emph */
pre.pygments .tok-gr { color: #E40000 } /* Generic.Error */
pre.pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
pre.pygments .tok-gi { color: #008400 } /* Generic.Inserted */
pre.pygments .tok-go { color: #717171 } /* Generic.Output */
pre.pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
pre.pygments .tok-gs { font-weight: bold } /* Generic.Strong */
pre.pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
pre.pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
pre.pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
pre.pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
pre.pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
pre.pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
pre.pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
pre.pygments .tok-kt { color: #B00040 } /* Keyword.Type */
pre.pygments .tok-m { color: #666666 } /* Literal.Number */
pre.pygments .tok-s { color: #BA2121 } /* Literal.String */
pre.pygments .tok-na { color: #687822 } /* Name.Attribute */
pre.pygments .tok-nb { color: #008000 } /* Name.Builtin */
pre.pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
pre.pygments .tok-no { color: #880000 } /* Name.Constant */
pre.pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
pre.pygments .tok-ni { color: #717171; font-weight: bold } /* Name.Entity */
pre.pygments .tok-ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
pre.pygments .tok-nf { color: #0000FF } /* Name.Function */
pre.pygments .tok-nl { color: #767600 } /* Name.Label */
pre.pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
pre.pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
pre.pygments .tok-nv { color: #19177C } /* Name.Variable */
pre.pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
pre.pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
pre.pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
pre.pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
pre.pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
pre.pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
pre.pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
pre.pygments .tok-sa { color: #BA2121 } /* Literal.String.Affix */
pre.pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
pre.pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
pre.pygments .tok-dl { color: #BA2121 } /* Literal.String.Delimiter */
pre.pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
pre.pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
pre.pygments .tok-se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
pre.pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
pre.pygments .tok-si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
pre.pygments .tok-sx { color: #008000 } /* Literal.String.Other */
pre.pygments .tok-sr { color: #A45A77 } /* Literal.String.Regex */
pre.pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
pre.pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
pre.pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
pre.pygments .tok-fm { color: #0000FF } /* Name.Function.Magic */
pre.pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
pre.pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
pre.pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
pre.pygments .tok-vm { color: #19177C } /* Name.Variable.Magic */
pre.pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Messenger - Example Server Project</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_services_infrastructure_and_requirements">1. Services, Infrastructure and Requirements</a>
<ul class="sectlevel2">
<li><a href="#_services">1.1. Services</a>
<ul class="sectlevel3">
<li><a href="#_methodology">1.1.1. Methodology</a></li>
<li><a href="#_for_this_project">1.1.2. For this project</a></li>
</ul>
</li>
<li><a href="#_infrastructure">1.2. Infrastructure</a>
<ul class="sectlevel3">
<li><a href="#_easy_scaling">1.2.1. Easy scaling</a></li>
<li><a href="#_centralized_logging">1.2.2. Centralized logging</a></li>
<li><a href="#_request_tracing">1.2.3. Request tracing</a></li>
<li><a href="#_metrics">1.2.4. Metrics</a></li>
<li><a href="#_health_check">1.2.5. Health check</a></li>
<li><a href="#_alarm">1.2.6. Alarm</a></li>
<li><a href="#_application_persistent_storage">1.2.7. Application Persistent Storage</a></li>
<li><a href="#_summary">1.2.8. Summary</a></li>
</ul>
</li>
<li><a href="#_programming_stack_reactive">1.3. Programming Stack &amp; Reactive</a>
<ul class="sectlevel3">
<li><a href="#_reactive_programming_with_kotlin_coroutines">1.3.1. Reactive Programming with Kotlin Coroutines</a></li>
<li><a href="#_kotlin">1.3.2. Kotlin</a></li>
<li><a href="#_programming_stack">1.3.3. Programming Stack</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_programming_principles">2. Programming Principles</a>
<ul class="sectlevel2">
<li><a href="#_dont_repeat_yourself_dry">2.1. Don&#8217;t repeat yourself (DRY)</a></li>
<li><a href="#_separation_of_concerns_soc">2.2. Separation of Concerns (SoC)</a></li>
<li><a href="#_service_statelessness">2.3. Service Statelessness</a></li>
</ul>
</li>
<li><a href="#_project_structure">3. Project Structure</a>
<ul class="sectlevel2">
<li><a href="#_gradle_modules">3.1. Gradle modules</a>
<ul class="sectlevel3">
<li><a href="#_microservices">3.1.1. Microservices</a></li>
<li><a href="#_library_artifacts">3.1.2. Library Artifacts</a></li>
<li><a href="#_other_modules">3.1.3. Other Modules</a></li>
<li><a href="#_summary_2">3.1.4. Summary</a></li>
</ul>
</li>
<li><a href="#_folder_structure">3.2. Folder Structure</a></li>
<li><a href="#_gradle_scripts_and_custom_plugins">3.3. Gradle scripts and custom plugins</a></li>
<li><a href="#_request_flow">3.4. Request Flow</a></li>
<li><a href="#_package_structure">3.5. Package Structure</a></li>
</ul>
</li>
<li><a href="#_local_environment">4. Local Environment</a>
<ul class="sectlevel2">
<li><a href="#_docker_compose_setup">4.1. Docker Compose Setup</a>
<ul class="sectlevel3">
<li><a href="#_application_and_storage">4.1.1. Application and Storage</a></li>
<li><a href="#_monitoring">4.1.2. Monitoring</a></li>
<li><a href="#_logging">4.1.3. Logging</a></li>
<li><a href="#_multiple_instances_for_a_service">4.1.4. Multiple Instances for a Service</a></li>
<li><a href="#_persistence">4.1.5. Persistence</a></li>
</ul>
</li>
<li><a href="#_launch_script">4.2. Launch Script</a></li>
</ul>
</li>
<li><a href="#_application_base_framework">5. Application Base Framework</a>
<ul class="sectlevel2">
<li><a href="#_application_server_request_response_logging">5.1. Application Server Request, Response Logging</a></li>
<li><a href="#_request_tracing_assigning_request_ids">5.2. Request Tracing (Assigning Request IDs)</a></li>
<li><a href="#_exception_handling">5.3. Exception Handling</a></li>
<li><a href="#_authorization">5.4. Authorization</a>
<ul class="sectlevel3">
<li><a href="#_design">5.4.1. Design</a></li>
<li><a href="#_implementation">5.4.2. Implementation</a></li>
<li><a href="#_more_about_jwt">5.4.3. More about JWT</a></li>
</ul>
</li>
<li><a href="#_resolving_common_parameters">5.5. Resolving Common Parameters</a></li>
<li><a href="#_parsing_x_forwarded_headers_to_obtain_real_ip_addresses">5.6. Parsing X-forwarded headers to obtain real IP addresses</a></li>
<li><a href="#_inter_microservice_http_calls_openfeign">5.7. Inter-microservice HTTP calls (OpenFeign)</a></li>
<li><a href="#_model_mapping_mapstruct">5.8. Model Mapping (MapStruct)</a></li>
<li><a href="#_tracing_and_metrics">5.9. Tracing and Metrics</a></li>
<li><a href="#_integration_with_either_mysql_or_mongodb_spring_data_r2dbc_mongodb">5.10. Integration with either MySQL or MongoDB (Spring Data R2DBC &amp; MongoDB)</a>
<ul class="sectlevel3">
<li><a href="#_gradle_configuration">5.10.1. Gradle Configuration</a></li>
<li><a href="#_mapping_annotations">5.10.2. Mapping Annotations</a></li>
<li><a href="#_decoupling_by_using_interface_and_dependency_injection">5.10.3. Decoupling by using Interface and Dependency Injection</a></li>
</ul>
</li>
<li><a href="#_base_schedule_tasks_distributed_locks">5.11. Base Schedule Tasks &amp; Distributed Locks</a></li>
<li><a href="#_other_common_stuffs">5.12. Other Common Stuffs</a>
<ul class="sectlevel3">
<li><a href="#_base_database_entities">5.12.1. Base Database Entities</a></li>
<li><a href="#_common_models_and_classes">5.12.2. Common models and classes</a></li>
<li><a href="#_configuration_properties">5.12.3. Configuration Properties</a></li>
</ul>
</li>
<li><a href="#_reactive_specific">5.13. Reactive Specific</a>
<ul class="sectlevel3">
<li><a href="#_context_propagation">5.13.1. Context propagation</a></li>
<li><a href="#_blocking_code_detector">5.13.2. Blocking Code Detector</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_relational_database_migrations">6. Relational Database Migrations</a>
<ul class="sectlevel2">
<li><a href="#_setup">6.1. Setup</a>
<ul class="sectlevel3">
<li><a href="#_migration_history_table">6.1.1. Migration History Table</a></li>
<li><a href="#_spring_boot_integration">6.1.2. Spring Boot Integration</a></li>
</ul>
</li>
<li><a href="#_writing_migrations">6.2. Writing migrations</a></li>
<li><a href="#_execution">6.3. Execution</a></li>
<li><a href="#_conclusion">6.4. Conclusion</a></li>
</ul>
</li>
<li><a href="#_api_gateway">7. API Gateway</a>
<ul class="sectlevel2">
<li><a href="#_routing">7.1. Routing</a></li>
<li><a href="#_tracing_and_metrics_2">7.2. Tracing and Metrics</a></li>
<li><a href="#_api_documentation_springdoc">7.3. API Documentation (Springdoc)</a></li>
</ul>
</li>
<li><a href="#_schedule_tasks">8. Schedule Tasks</a>
<ul class="sectlevel2">
<li><a href="#_race_condition_example">8.1. Race Condition Example</a></li>
<li><a href="#_execution_context">8.2. Execution Context</a></li>
<li><a href="#_distributed_locks">8.3. Distributed Locks</a>
<ul class="sectlevel3">
<li><a href="#_task_level_lock">8.3.1. Task-level Lock</a></li>
<li><a href="#_record_level_lock">8.3.2. Record-level Lock</a></li>
<li><a href="#_no_lock">8.3.3. No Lock</a></li>
</ul>
</li>
<li><a href="#_retries">8.4. Retries</a></li>
<li><a href="#_record_level_schedule_task_implementation">8.5. Record-level Schedule Task Implementation</a></li>
</ul>
</li>
<li><a href="#_automatic_testing">9. Automatic Testing</a>
<ul class="sectlevel2">
<li><a href="#_unit_test">9.1. Unit Test</a></li>
<li><a href="#_spring_boot_test">9.2. Spring Boot Test</a></li>
<li><a href="#_data_test">9.3. Data Test</a></li>
<li><a href="#_integration_test">9.4. Integration Test</a>
<ul class="sectlevel3">
<li><a href="#_end_to_end_tests">9.4.1. End-to-end tests</a></li>
<li><a href="#_concurrent_test">9.4.2. Concurrent Test</a></li>
<li><a href="#_testing_stack">9.4.3. Testing Stack</a></li>
<li><a href="#_dependencies_and_other_gradle_configuration">9.4.4. Dependencies and Other Gradle Configuration</a></li>
</ul>
</li>
<li><a href="#_load_test">9.5. Load Test</a></li>
<li><a href="#_stress_test">9.6. Stress Test</a></li>
<li><a href="#_recommendations_for_development_phase_tests">9.7. Recommendations for Development-phase Tests</a></li>
</ul>
</li>
<li><a href="#_getting_started">10. Getting Started</a>
<ul class="sectlevel2">
<li><a href="#_run_a_local_cluster">10.1. Run a local cluster</a></li>
<li><a href="#_run_unit_tests_spring_boot_tests">10.2. Run unit tests / Spring Boot tests</a></li>
<li><a href="#_run_integration_tests">10.3. Run integration tests</a></li>
<li><a href="#_run_all_the_tests">10.4. Run all the tests</a></li>
<li><a href="#_generate_documentation">10.5. Generate Documentation</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_services_infrastructure_and_requirements">1. Services, Infrastructure and Requirements</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s start by creating another chat application for work as an example project. We focus on the server-side.</p>
</div>
<div class="sect2">
<h3 id="_services">1.1. Services</h3>
<div class="sect3">
<h4 id="_methodology">1.1.1. Methodology</h4>
<div class="paragraph">
<p>In my opinion, microservices should be defined according to business functions and requirements. If one microservice is down, e.g. the login service, it should not affect already logged-in users to continue to use the application. If many people is expected to rush in for a lucky draw, for example, then we can scale out only the home service, the lucky draw service, and the login service.</p>
</div>
<div class="paragraph">
<p>If microservices are defined according to technical kinds, it is easy for these services to be highly coupled and creating a <a href="https://en.wikipedia.org/wiki/Single_point_of_failure">single point of failure</a>. The outcome has no difference with a monolith server.</p>
</div>
<div class="paragraph">
<p>Read all the business requirements, define the microservices needed, their responsibilities and components needed (e.g. database, cache servers) before the start of development.</p>
</div>
</div>
<div class="sect3">
<h4 id="_for_this_project">1.1.2. For this project</h4>
<div class="paragraph">
<p>In this example project, a few microservices are defined to be responsible for different roles as listed below.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Service</th>
<th class="tableblock halign-left valign-top">Responsibilities</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">API Gateway</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Entry point of all requests coming from external</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Profile Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Authentication, account, user profile</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Chat channel, message</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">File Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">File upload, file tracking, message attachment</p></td>
</tr>
</tbody>
</table>
<div class="imageblock">
<div class="content">
<img src="diag-mermaid-md5-44ea86e84ed0ef7caf1863d95acf4a05.png" alt="Diagram" width="627" height="141">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_infrastructure">1.2. Infrastructure</h3>
<div class="paragraph">
<p>There are some requirements on the infrastructure in order to establish a workable production environment for this project. Most of them are also frequently required in other projects.</p>
</div>
<div class="sect3">
<h4 id="_easy_scaling">1.2.1. Easy scaling</h4>
<div class="paragraph">
<p>To allow high server capacity to handle large volume of traffic, while releasing computing resources when the demand is low, scaling is a technique to adjust number of processes running concurrently. There are manual scaling and automatic scaling.</p>
</div>
<div class="paragraph">
<p>Wrapping servers into Docker containers and implementing stateless servers make scaling very easy. Orchestrators like Kubernetes or Docker Compose can be used.</p>
</div>
<div class="paragraph">
<p>In this project, Docker Compose is used for manual scaling.</p>
</div>
</div>
<div class="sect3">
<h4 id="_centralized_logging">1.2.2. Centralized logging</h4>
<div class="paragraph">
<p>In a microservice project, there can be many processes running. It is unsatisfactory to lookup logs in multiple places in order to trace logs about a particular request or event. A centralized place is needed to collect all the application logs.</p>
</div>
<div class="paragraph">
<p>There are multiple stacks can be used, for example, ELK (Elasticsearch, Logstash, Kibana), or EFK (Elasticsearch, Fluentd, Kibana). If the project is deployed at cloud, cloud providers usually provide log ingestion services, e.g. AWS CloudWatch. As logs need to be distinguished between the local environment and cloud environments, plus there is a cost on cloud service, it is OK to have different infrastructure stacks between the local environment and cloud environments.</p>
</div>
<div class="paragraph">
<p>In this project, Logspout + ELK are used.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/kibana.png" alt="kibana"></span></p>
</div>
</div>
<div class="sect3">
<h4 id="_request_tracing">1.2.3. Request tracing</h4>
<div class="paragraph">
<p>It is often useful to know how much time was spent on each operation, what microservices were visited, and e.g., what SQL was used, in a particular request, without diving into raw log lines. It would be even better if these data can be searched against some criteria. Except those built-ins, custom data tags can also be logged. Tools like Zipkin or Jaeger can visualize these information. They can be integrated with Spring Boot or OpenTelemetry.</p>
</div>
<div class="paragraph">
<p>In this project, OpenTelemetry + Jaeger are used.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/jaeger.png" alt="jaeger"></span></p>
</div>
</div>
<div class="sect3">
<h4 id="_metrics">1.2.4. Metrics</h4>
<div class="paragraph">
<p>Numeric metrics such as incoming HTTP request rate, request processing time, error rate, number of responses per HTTP status code, healthiness, memory usage, CPU usage over time are very useful for debugging and analyzing if they are logged and visualized. It would be even better if their distribution, e.g. 80% and 95% of request processing time, can be visualized. Apart of those metrics, custom metrics are also a common use case.</p>
</div>
<div class="paragraph">
<p>In this project, OpenTelemetry + Prometheus + Grafana are used.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/grafana.png" alt="grafana"></span></p>
</div>
<div class="paragraph">
<p>There are <a href="https://sre.google/sre-book/monitoring-distributed-systems/">golden signals of monitoring</a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Latency</p>
</li>
<li>
<p>Traffic</p>
</li>
<li>
<p>Errors</p>
</li>
<li>
<p>Saturation</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>and <a href="https://povilasv.me/monitoring-spring-boot-application-with-prometheus/">the RED method</a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Request rate</p>
</li>
<li>
<p>Error rate</p>
</li>
<li>
<p>Duration</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_health_check">1.2.5. Health check</h4>
<div class="paragraph">
<p>It is important to implement health check for each service, so that external components can know the healthiness of an individual service, and:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Kill the unhealthy/unresponsive servers and restart</p>
</li>
<li>
<p>Log the incident for debug use</p>
</li>
<li>
<p>Notify staffs to resolve the incident</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A health check API needs to be implemented in each microservice to provide the healthiness, and then an external agent would query this API regularly. Additional tools may be integrated to trigger actions if the service is unhealthy.</p>
</div>
<div class="paragraph">
<p>Kubernetes provides built-in support to restart an unhealthy container.</p>
</div>
<div class="paragraph">
<p>In this project, Spring Boot Actuator is used to implement the health check API. The Blackbox Exporter, a plugin of Prometheus, would be integrated with Prometheus to do the query job and log the data.</p>
</div>
</div>
<div class="sect3">
<h4 id="_alarm">1.2.6. Alarm</h4>
<div class="paragraph">
<p>As introduced in previous sections, notifying staffs when there are something abnormal can be crucial. Events that require immediate attentions may include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Services are consecutively down for a period</p>
</li>
<li>
<p>Number of requests are abnormally high (Are we under a DDoS attack?)</p>
</li>
<li>
<p>Number of error responses are consecutively high over some time</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this project, those data have already been collected in previous sections. Grafana can be used for realtime monitoring and sending alerts.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/grafana-alert.png" alt="grafana alert"></span></p>
</div>
</div>
<div class="sect3">
<h4 id="_application_persistent_storage">1.2.7. Application Persistent Storage</h4>
<div class="paragraph">
<p>This section is about all persistent data needed by the application servers.</p>
</div>
<div class="paragraph">
<p>In this project, binary files are stored in MinIO, which provides a S3-compatible API. Textual and indexed data are stored in database, which is either MySQL or MongoDB.</p>
</div>
</div>
<div class="sect3">
<h4 id="_summary">1.2.8. Summary</h4>
<div class="paragraph">
<p>Below diagram summarizes all the components used.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="diag-mermaid-md5-ab908c5261ac7624c1c9503dbcffe80b.png" alt="Diagram" width="784" height="218">
</div>
</div>
<div class="paragraph">
<p>Arrows represent the data direction.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_programming_stack_reactive">1.3. Programming Stack &amp; Reactive</h3>
<div class="sect3">
<h4 id="_reactive_programming_with_kotlin_coroutines">1.3.1. Reactive Programming with Kotlin Coroutines</h4>
<div class="paragraph">
<p>Reactive programming enables use of very few threads, implying low memory usage, to handle high number of concurrent I/O. It does not help lowering resource needed for high-computing processes though, e.g. loops with time complexity \$O(N^2), N &gt;= 1000\$ or higher. Since normal application projects, including this project, are API integrations, database I/O and simple logic, most computing responsibility is delegated to the database, reactive programming is very suitable to us.</p>
</div>
<div class="paragraph">
<p>However, reactive programming is hard to write.</p>
</div>
<div class="paragraph">
<p>Fortunately, Kotlin coroutine integrates with Reactor nicely to provide reactiveness. We can write non-blocking codes in simple familiar syntax to enjoy the benefits of reactive programming, like this:</p>
</div>
<div class="listingblock">
<div class="title">/main/message-service/src/main/kotlin/com/gtomato/server/application/messenger/messageservice/api/MessageApi.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-nd">@PostMapping</span>
<span class="tok-nd">@ResponseStatus</span><span class="tok-p">(</span><span class="tok-n">HttpStatus</span><span class="tok-p">.</span><span class="tok-na">CREATED</span><span class="tok-p">)</span>
<span class="tok-kd">suspend</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">create</span><span class="tok-p">(</span>
<span class="tok-w">    </span><span class="tok-nd">@RequestBody</span><span class="tok-w"> </span><span class="tok-n">payload</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">CreateMessagePayload</span><span class="tok-p">,</span>
<span class="tok-w">    </span><span class="tok-nd">@RequestHeader</span><span class="tok-p">(</span><span class="tok-s">&quot;request-id&quot;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">requestId</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">String</span><span class="tok-p">,</span>
<span class="tok-w">    </span><span class="tok-nd">@RequestUserId</span><span class="tok-w"> </span><span class="tok-n">userId</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">String</span>
<span class="tok-p">):</span><span class="tok-w"> </span><span class="tok-n">CreationResource</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">isChannelActive</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">chatChannelRepository</span><span class="tok-p">.</span><span class="tok-na">countByIdAndIsActive</span><span class="tok-p">(</span><span class="tok-n">id</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">payload</span><span class="tok-p">.</span><span class="tok-na">channelId</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">isActive</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-kc">true</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-m">0</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">isChannelActive</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">throw</span><span class="tok-w"> </span><span class="tok-n">InvalidChannelException</span><span class="tok-p">()</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-n">messageService</span><span class="tok-p">.</span><span class="tok-na">checkUserIsAParticipantOfChannel</span><span class="tok-p">(</span><span class="tok-n">userId</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">userId</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">channelId</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">payload</span><span class="tok-p">.</span><span class="tok-na">channelId</span><span class="tok-p">)</span><span class="tok-w"> </span><i class="conum" data-value="2"></i><b>(2)</b>

<span class="tok-w">    </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">trimmedContent</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">payload</span><span class="tok-p">.</span><span class="tok-na">content</span><span class="tok-p">.</span><span class="tok-na">trim</span><span class="tok-p">()</span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">trimmedContent</span><span class="tok-p">.</span><span class="tok-na">length</span><span class="tok-w"> </span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-m">16000</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">throw</span><span class="tok-w"> </span><span class="tok-n">ContentTooLongException</span><span class="tok-p">()</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">trimmedContent</span><span class="tok-p">.</span><span class="tok-na">isEmpty</span><span class="tok-p">())</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">throw</span><span class="tok-w"> </span><span class="tok-n">InvalidInputException</span><span class="tok-p">(</span><span class="tok-s">&quot;No content to send&quot;</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">message</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ChatMessage</span><span class="tok-p">(</span>
<span class="tok-w">        </span><span class="tok-n">channelId</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">payload</span><span class="tok-p">.</span><span class="tok-na">channelId</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">senderId</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">userId</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">content</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">trimmedContent</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">creationRequestId</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">requestId</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">attachmentIds</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">emptyList</span><span class="tok-p">()</span>
<span class="tok-w">    </span><span class="tok-p">)</span>

<span class="tok-w">    </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">attachmentIds</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">payload</span><span class="tok-p">.</span><span class="tok-na">attachmentIds</span><span class="tok-o">?.</span><span class="tok-na">let</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">ids</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span>
<span class="tok-w">        </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">ids</span><span class="tok-p">.</span><span class="tok-na">size</span><span class="tok-w"> </span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-m">20</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-k">throw</span><span class="tok-w"> </span><span class="tok-n">TooManyAttachmentsException</span><span class="tok-p">()</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-n">fileServiceApi</span><span class="tok-p">.</span><span class="tok-na">createAttachments</span><span class="tok-p">(</span><span class="tok-n">CreateAttachmentPayload</span><span class="tok-p">(</span>
<span class="tok-w">            </span><span class="tok-n">messageId</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">message</span><span class="tok-p">.</span><span class="tok-na">id</span><span class="tok-p">,</span>
<span class="tok-w">            </span><span class="tok-n">channelId</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">payload</span><span class="tok-p">.</span><span class="tok-na">channelId</span><span class="tok-p">,</span>
<span class="tok-w">            </span><span class="tok-n">uploadIds</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ids</span>
<span class="tok-w">        </span><span class="tok-p">))</span><span class="tok-w"> </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-o">?.</span><span class="tok-na">ids</span><span class="tok-w"> </span><span class="tok-o">?:</span><span class="tok-w"> </span><span class="tok-n">emptyList</span><span class="tok-p">()</span>

<span class="tok-w">    </span><span class="tok-n">message</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">chatMessageRepository</span><span class="tok-p">.</span><span class="tok-na">save</span><span class="tok-p">(</span><span class="tok-n">message</span><span class="tok-p">.</span><span class="tok-na">copy</span><span class="tok-p">(</span><span class="tok-n">attachmentIds</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">attachmentIds</span><span class="tok-p">))</span><span class="tok-w"> </span><i class="conum" data-value="4"></i><b>(4)</b>

<span class="tok-w">    </span><span class="tok-c1">// issue UPDATE directly to the database to avoid optimistic lock exception.</span>
<span class="tok-w">    </span><span class="tok-c1">// this operation doesn&#39;t need to be protected by application locks, and should not throw error.</span>
<span class="tok-w">    </span><span class="tok-n">chatChannelRepository</span><span class="tok-p">.</span><span class="tok-na">updateLastMessageTime</span><span class="tok-p">(</span><span class="tok-n">channelId</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">payload</span><span class="tok-p">.</span><span class="tok-na">channelId</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">isActive</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-kc">true</span><span class="tok-p">)</span><span class="tok-w"> </span><i class="conum" data-value="5"></i><b>(5)</b>

<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">CreationResource</span><span class="tok-p">(</span><span class="tok-n">id</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">message</span><span class="tok-p">.</span><span class="tok-na">id</span><span class="tok-p">)</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There are 5 I/O calls in this API, not a simple example. They are reactive, and as you can see there is no complicated reactive operator. They are as simple as writing usual blocking codes.</p>
</div>
</div>
<div class="sect3">
<h4 id="_kotlin">1.3.2. Kotlin</h4>
<div class="paragraph">
<p>If you did not hear about <a href="https://kotlinlang.org/">Kotlin</a>, it is a multiplatform language. We will only focus on its JVM variant, which is fully compatible and interoperable with Java. Kotlin code can call and use Java stuffs, and vice versa, although I don&#8217;t find people use Java to call Kotlin. As this variant compiles Kotlin code to JVM bytecodes, all the usual and familiar JVM restrictions apply. The compiled artifacts would be jar files.</p>
</div>
</div>
<div class="sect3">
<h4 id="_programming_stack">1.3.3. Programming Stack</h4>
<div class="paragraph">
<p>Alright, so Kotlin coroutines would be used. This project bases on Spring Boot as well. The stack looks like this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Kotlin 1.8</p>
</li>
<li>
<p>Java 17</p>
</li>
<li>
<p>Spring Boot 3.2</p>
</li>
<li>
<p>Spring Cloud 2023</p>
</li>
<li>
<p>Spring Webflux</p>
</li>
<li>
<p>Spring Data R2DBC / MongoDB</p>
</li>
<li>
<p>Reactor</p>
</li>
<li>
<p>Kotlinx Coroutines</p>
</li>
<li>
<p>Micrometer</p>
</li>
<li>
<p>MapStruct</p>
</li>
<li>
<p>Springdoc</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_programming_principles">2. Programming Principles</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Programming principles are crucial, not difficult, but easy to be missed out, even senior developers do. Here lists the most important principles that are applicable to most server projects.</p>
</div>
<div class="sect2">
<h3 id="_dont_repeat_yourself_dry">2.1. <a href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself">Don&#8217;t repeat yourself</a> (DRY)</h3>
<div class="paragraph">
<p>When a code block or logic is written <strong>more than once</strong>, this is a problem. When you write the 3rd time, would you refactor or duplicate the code? You would duplicate, because you did it in the 2nd time. How about the 4th time? When changes are needed, you would need to change everywhere the code appears. Can you find out all the code occurrence? If no, then inconsistency is introduced. You create a bug. Also, development time needed (or technical debt) is strictly increasing when you need to fix it.</p>
</div>
<div class="paragraph">
<p>In this project, we will strictly conform to this principle, no matter in programming codes, configurations or build scripts.</p>
</div>
</div>
<div class="sect2">
<h3 id="_separation_of_concerns_soc">2.2. Separation of Concerns (SoC)</h3>
<div class="paragraph">
<p>This is about each component addresses a separate concern. It avoids deep coupling among components, thus enabling easier refactoring and reusing. Highly exercising this principle can result in large size of unnecessary codes, which ironically lower the maintainability. A balance is needed.</p>
</div>
<div class="paragraph">
<p>It is advised to list out all the responsibilities and foreseeable highly possible extensions at design time, then separate and assign them to the components. When a new responsibility is added, it is necessary to review whether a new component should be created, embedding into existing components, or break existing components into different ones. Maintaining a design document can ease this iterative process.</p>
</div>
</div>
<div class="sect2">
<h3 id="_service_statelessness">2.3. Service Statelessness</h3>
<div class="paragraph">
<p>This is rather specific to server scaling. To make it possible, server should be stateless.</p>
</div>
<div class="paragraph">
<p>An example is that if user session is stored in server memory, and when there is 2 servers. Say user A&#8217;s logins via server A, so the session is stored in server A&#8217;s memory. When user A&#8217;s traffic is routed to server B, server B doesn&#8217;t know about it and rejects the request with an error. Then, user A could not use the service.</p>
</div>
<div class="paragraph">
<p>To exercise this principle, separating all the states from application servers to database, log sinks, object storage, message queues, cache servers, or a set of customized cache servers implemented by your team. The only state that is valid to live in application servers should be caches.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_project_structure">3. Project Structure</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_gradle_modules">3.1. Gradle modules</h3>
<div class="paragraph">
<p>We will break down the project into many library modules to allow reuse and reduce duplicate code.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="diag-mermaid-md5-c235a93c2c6bcd86becc61f466a8945b.png" alt="Diagram" width="784" height="273">
</div>
</div>
<div class="paragraph">
<p>Arrows represent a dependency.</p>
</div>
<div class="paragraph">
<p>The graph is giant. Let&#8217;s break down it.</p>
</div>
<div class="paragraph">
<p><code>profile-service</code>, <code>message-service</code>, <code>file-service</code> are microservices. Their common components will be put into <code>lib:microservice-common</code>. <code>api-gateway</code> is not classified as a microservice&#8201;&#8212;&#8201;it does not require application-specific components.</p>
</div>
<div class="paragraph">
<p>In this project, a microservice is a HTTP server, so <code>lib:microservice-common</code> "extends" <code>lib:http-server</code>. In other projects that do not apply, we may further differentiate by adding <code>lib:microservice-http</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="diag-mermaid-md5-c7d539102d6959c89a8ebeeb71247532.png" alt="Diagram" width="478" height="218">
</div>
</div>
<div class="paragraph">
<p>All the microservices in this project require DB access, so we have the following dependencies.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is not uncommon that a microservice does not require database access.
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="diag-mermaid-md5-270dab3d18605d6f743ff7e0b5ffbd27.png" alt="Diagram" width="632" height="218">
</div>
</div>
<div class="paragraph">
<p>We will extract request, response models and inter-microservice calls into library modules so that they can be reused. DRY.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="diag-mermaid-md5-56702ff0e44fd9143a5133444bf60cf4.png" alt="Diagram" width="658" height="218">
</div>
</div>
<div class="paragraph">
<p>Finally, we will have convention plugin and integration test modules.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="diag-mermaid-md5-b63f34c4e8ddc81f0a398001aa218179.png" alt="Diagram" width="510" height="218">
</div>
</div>
<div class="sect3">
<h4 id="_microservices">3.1.1. Microservices</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Module</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">api-gateway</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">API Gateway</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">profile-service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Profile Service. Manages accounts and profiles</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">message-service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message Service. Manages messages.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">file-service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">File Service. Manages attachments.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_library_artifacts">3.1.2. Library Artifacts</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 13%;">
<col style="width: 13%;">
<col style="width: 74%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Module</th>
<th class="tableblock halign-center valign-top">Is Application-specific?</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">profile-transport</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTP client for calling Profile Service
internal APIs. Include request &amp; response models.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">message-transport</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTP client for calling Message Service
internal APIs. Include request &amp; response models.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">file-transport</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTP client for calling File Service internal
APIs. Include request &amp; response models.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">lib:microservice-common</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Common among microservices.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">lib:feign-common</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Little</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Common among HTTP clients.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">lib:http-server</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Common among Webflux web servers that decoupled
from application-specific stuffs. Intended to be extracted out to share
among different projects.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">lib:db-mysql</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Little</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">R2DBC DB client. It should contain very few
application-specific stuffs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">lib:db-mongodb</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Little</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MongoDB reactive DB client. It should contain
very few application-specific stuffs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">lib:db-common</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Little</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Common among DB clients. It should contain very
few application-specific stuffs.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_other_modules">3.1.3. Other Modules</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Module</th>
<th class="tableblock halign-center valign-top">Is Application-specific?</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">buildSrc</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A Gradle plugin to handle build logic.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">integration-test</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integration test.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_summary_2">3.1.4. Summary</h4>
<div class="paragraph">
<p>The general idea is extracting each "kind" into a module, somewhat similar to classes in programming. "Extend" common stuffs by depending on common modules.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_folder_structure">3.2. Folder Structure</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>./
 main/ <i class="conum" data-value="1"></i><b>(1)</b>
    buildSrc/
    api-gateway/
       build.gradle.kts
    profile-service/
    profile-transport/
    message-service/
    message-transport/
    file-service/
    file-transport/
    lib/ <i class="conum" data-value="2"></i><b>(2)</b>
       db-common/
          build.gradle.kts
       db-mysql/
       db-mongodb/
       feign-common/
       microservice-common/
       http-server/
    integration-test/
    gradle/
       libs.versions.toml <i class="conum" data-value="3"></i><b>(3)</b>
    build.gradle.kts
    settings.gradle.kts
 infra/ <i class="conum" data-value="4"></i><b>(4)</b>
    otel-collector/
    prometheus/
    prom-blackbox-exporter/
    grafana/
 jar.Dockerfile <i class="conum" data-value="5"></i><b>(5)</b>
 docker-compose.yml <i class="conum" data-value="6"></i><b>(6)</b>
 rebuild-and-up.sh <i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The main Gradle project relies in this project. Sometimes, there are more than one Gradle root project. It is also a good idea to separate the giant application code from other supplementary files, such as local infrastructure files or documentation.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Library modules are separated from microservice modules for easier navigation. When a developer is working on application code, they can collapse the library modules in the project file tree to concentrate.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Dependency versions are <a href="https://docs.gradle.org/current/userguide/platforms.html#sec:sharing-catalogs">centralized</a> in one place. Versions are only declared once, to exercise the DRY principle. Actually, there are many other ways to do it.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Infrastructure configuration files. In practice, this folder should be extracted as a separate git repository to allow devops engineers and developers to work together without polluting application codes, and include it into this repository using git submodules.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Don&#8217;t duplicate Dockerfile for each microservice. DRY. Only one file. If the configurations are a little bit different, see if it can be put into the same Dockerfile, before creating a variant.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>A big configuration file for local environment setup.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Also for local environment. To allow an one-liner command <code>./rebuild-and-up.sh</code> to compile and setup a local environment, including the whole infrastructure and initial data. This will be very handy to developers. It can also embed some fast testing scripts.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_gradle_scripts_and_custom_plugins">3.3. Gradle scripts and custom plugins</h3>
<div class="paragraph">
<p>Common dependencies can be written into a shared Gradle module. Actually, another way is to write into a shared Gradle plugin. Plugin can do much more things, such as sharing common third-party plugins (e.g. applying the <code>org.springframework.boot</code> plugin), sharing configurations (e.g. <code>tasks.getByName&lt;BootRun&gt;("bootRun") { &#8230;&#8203; }</code>), etc.. Writing a custom <a href="https://docs.gradle.org/current/userguide/organizing_gradle_projects.html#sec:build_sources">buildSrc plugin (convention plugin)</a> is not complicated. It is as simple as writing a build.gradle.kts script.</p>
</div>
<div class="listingblock">
<div class="title">/main/buildSrc/src/main/kotlin/messenger.kotlin.gradle.kts</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-k">import</span><span class="tok-w"> </span><span class="tok-nn">org.jetbrains.kotlin.gradle.tasks.KotlinCompile</span>

<span class="tok-n">plugins</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">kotlin</span><span class="tok-p">(</span><span class="tok-s">&quot;jvm&quot;</span><span class="tok-p">)</span>
<span class="tok-p">}</span>

<span class="tok-n">java</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">sourceCompatibility</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">JavaVersion</span><span class="tok-p">.</span><span class="tok-na">VERSION_17</span>
<span class="tok-p">}</span>

<span class="tok-n">tasks</span><span class="tok-p">.</span><span class="tok-na">withType</span><span class="tok-o">&lt;</span><span class="tok-n">KotlinCompile</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">kotlinOptions</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">freeCompilerArgs</span><span class="tok-w"> </span><span class="tok-o">+=</span><span class="tok-w"> </span><span class="tok-s">&quot;-Xjsr305=strict&quot;</span>
<span class="tok-w">        </span><span class="tok-n">freeCompilerArgs</span><span class="tok-w"> </span><span class="tok-o">+=</span><span class="tok-w"> </span><span class="tok-s">&quot;-Xjvm-default=all&quot;</span><span class="tok-w"> </span><span class="tok-c1">// for generating &quot;interface default methods&quot; to be used by MapStruct @Named mapping methods</span>
<span class="tok-w">        </span><span class="tok-n">jvmTarget</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;17&quot;</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span>

<span class="tok-n">tasks</span><span class="tok-p">.</span><span class="tok-na">withType</span><span class="tok-o">&lt;</span><span class="tok-n">Test</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">useJUnitPlatform</span><span class="tok-p">()</span>
<span class="tok-p">}</span>

<span class="tok-n">dependencies</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">implementation</span><span class="tok-p">(</span><span class="tok-s">&quot;org.jetbrains.kotlin:kotlin-reflect&quot;</span><span class="tok-p">)</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And to use it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-n">plugins</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">id</span><span class="tok-p">(</span><span class="tok-s">&quot;messenger.kotlin&quot;</span><span class="tok-p">)</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Plugin IDs are defined in the filename of the plugin script, e.g. <code><em>plugin.name</em>.gradle.kts</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A change in buildSrc causes the whole project to become out-of-date. If changes are frequent, it can be optimized by using <a href="https://ncorti.com/blog/gradle-plugins-and-composite-builds">Composite Builds</a>.</p>
</div>
<div class="paragraph">
<p>Changing from convention plugins to composite builds requires no changes to your script content. It only involves moving the script files and updating the <code>setting.build.kts</code> file. An example is in <a href="https://github.com/sunny-chung/kdatetime-multiplatform/tree/main/convention-plugins">here</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Gradle <a href="https://docs.gradle.org/current/userguide/sharing_build_logic_between_subprojects.html#sec:convention_plugins_vs_cross_configuration">recommends</a> use of plugins over a <code>subproject { &#8230;&#8203; }</code> block. Still, a minimal <code>subproject</code> block can be used to apply a plugin that applies to every module.</p>
</div>
<div class="listingblock">
<div class="title">/main/build.gradle.kts</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-n">subprojects</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">apply</span><span class="tok-p">(</span><span class="tok-n">plugin</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;messenger.kotlin&quot;</span><span class="tok-p">)</span>

<span class="tok-w">    </span><span class="tok-n">repositories</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">mavenCentral</span><span class="tok-p">()</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Custom plugins should be created according to technical "kinds". For example, a plugin for modules that use "kotlin", a plugin for "spring", a plugin for "microservice", etc.. Don&#8217;t put everything into one gradle script. SoC.</p>
</div>
</div>
<div class="sect2">
<h3 id="_request_flow">3.4. Request Flow</h3>
<div class="paragraph">
<p>This project follows a rather standard flow of processing requests.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="diag-mermaid-md5-542a8b15f162f8d480cf91e2a58179b4.png" alt="Diagram" width="693" height="204">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There is no interceptor in Spring Webflux.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_package_structure">3.5. Package Structure</h3>
<div class="paragraph">
<p>Don&#8217;t be stingy. Create a package for every kind.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>com.gtomato.server.application.messenger <i class="conum" data-value="1"></i><b>(1)</b>
 messageservice
    annotation
    api / controller
    autoconfiguration
    config
    constant
    controlleradvice
    entity
    exception
    exceptionhandler
    extension
    filter
    helper
    mapper
    model
    payload
    resolver
    repository
    httprepository
    scheduletask
    service
    util
 profileservice
    ... <i class="conum" data-value="2"></i><b>(2)</b>
 fileservice
    ...
 apigateway
    ...
 common <i class="conum" data-value="3"></i><b>(3)</b>
     ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Each application project should have their own dedicated package. Otherwise, there could be a clash if library modules from other projects are imported.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>All microservices have their own package. The package structures inside those are the same. Transport modules use the same packages as their counterpart microservices.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>All library modules share the same "common" package, which has the same package structure as microservices' one.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_local_environment">4. Local Environment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At minimal, besides UAT and Production, there should be a Local environment for every developer. The benefits are significant and many:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>The "deployment process" can be tested before Production deployment</strong>. If there are only UAT and Production, the first chance to infrastructure changes and DB migrations might be Production, which means no testing is performed before Production deployment. It may create lots of issues, cause the deployment to fail or result in data loss in Production.</p>
</li>
<li>
<p><strong>Avoid interference from other developers.</strong> During development of a feature, code changes by other developers may not be merged or committed as they are not yet complete, but they may need to change data to test the feature. Using a shared environment, their data changes or infrastructure changes may affect your development.</p>
</li>
<li>
<p><strong>Freedom to clear and manipulate data.</strong> As the Local environment is isolated, feel free to delete and reset all the data while carrying out testing. This allows you to <strong>perform automatic end-to-end tests</strong>.</p>
</li>
<li>
<p><strong>Easier to read logs.</strong> You don&#8217;t have to filter logs created by other developers and testers.</p>
</li>
<li>
<p><strong>Easier debugging by setting breakpoints.</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To summarize, having a Local environment can enjoy safer deployment and faster development.</p>
</div>
<div class="sect2">
<h3 id="_docker_compose_setup">4.1. Docker Compose Setup</h3>
<div class="paragraph">
<p>Local environment does not have to be identical to other environments. It should provide a minimal set of components for development and testing, without the dependency on other environments.</p>
</div>
<div class="paragraph">
<p>So, at minimal we have the followings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Database</p>
</li>
<li>
<p>Local object storage (MinIO)</p>
</li>
<li>
<p>ELK for reading logs</p>
</li>
<li>
<p>Metrics stack, if custom metrics are implemented</p>
</li>
<li>
<p>All the microservices</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s put all those together into the <code>docker-compose.yml</code> file.</p>
</div>
<div class="sect3">
<h4 id="_application_and_storage">4.1.1. Application and Storage</h4>
<div class="listingblock">
<div class="title">/docker-compose.yml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">x-common-microservice-env</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-nl">&amp;microservice-env</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">  </span><span class="tok-nt">spring.profiles.active</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">local</span>
<span class="tok-w">  </span><span class="tok-nt">spring.r2dbc.url</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;r2dbcs:mysql://mysql:3306/?sslMode=required&quot;</span>
<span class="tok-w">  </span><span class="tok-nt">spring.flyway.url</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;jdbc:mysql://mysql:3306/?sslMode=required&quot;</span>
<span class="tok-w">  </span><span class="tok-nt">spring.flyway.user</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">root</span>
<span class="tok-w">  </span><span class="tok-nt">spring.flyway.password</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">123</span>
<span class="tok-w">  </span><span class="tok-nt">spring.cloud.openfeign.client.config.profile-service.url</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;http://profile-service:10001&quot;</span>
<span class="tok-w">  </span><span class="tok-nt">spring.cloud.openfeign.client.config.file-service.url</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;http://file-service:10003&quot;</span>

<span class="tok-nt">services</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-c1">## Storage Architecture</span>
<span class="tok-w">  </span><span class="tok-nt">mysql</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">mysql:8.0</span><span class="tok-w"> </span><span class="tok-c1"># 8.1 is not supported by many clients</span>
<span class="tok-w">    </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-s">&quot;10101:3306&quot;</span>
<span class="tok-w">    </span><span class="tok-nt">environment</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">MYSQL_ROOT_PASSWORD</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">123</span>
<span class="tok-c1">#      MYSQL_DATABASE: messenger</span>
<span class="tok-w">      </span><span class="tok-nt">MYSQL_USER</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">user1</span>
<span class="tok-w">      </span><span class="tok-nt">MYSQL_PASSWORD</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">password1</span>
<span class="tok-w">    </span><span class="tok-nt">healthcheck</span><span class="tok-p">:</span><span class="tok-w"> </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-w">      </span><span class="tok-nt">test</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;mysql</span><span class="tok-nv"> </span><span class="tok-s">$$MYSQL_DATABASE</span><span class="tok-nv"> </span><span class="tok-s">-u$$MYSQL_USER</span><span class="tok-nv"> </span><span class="tok-s">-p$$MYSQL_PASSWORD</span><span class="tok-nv"> </span><span class="tok-s">-e</span><span class="tok-nv"> </span><span class="tok-s">&#39;SELECT</span><span class="tok-nv"> </span><span class="tok-s">1;&#39;&quot;</span>
<span class="tok-w">      </span><span class="tok-nt">interval</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">5s</span>
<span class="tok-w">      </span><span class="tok-nt">timeout</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">3s</span>
<span class="tok-w">      </span><span class="tok-nt">retries</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">3</span>
<span class="tok-w">      </span><span class="tok-nt">start_period</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">5s</span>
<span class="tok-c1">#    volumes:</span>
<span class="tok-c1">#      - ./dbinit:/docker-entrypoint-initdb.d</span>
<span class="tok-w">    </span><span class="tok-nt">command</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">--ft_stopword_file=&quot;&quot; --ngram_token_size=1</span>
<span class="tok-w">    </span><span class="tok-nt">deploy</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">resources</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">limits</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">cpus</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;1&quot;</span>
<span class="tok-w">          </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">2G</span>
<span class="tok-w">  </span><span class="tok-nt">minio</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">minio/minio</span>
<span class="tok-w">    </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-s">&quot;10102:9000&quot;</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-s">&quot;10103:9001&quot;</span>
<span class="tok-w">    </span><span class="tok-nt">environment</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">MINIO_ROOT_USER</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">LOZpOCD0i5tlzgpqmw</span>
<span class="tok-w">      </span><span class="tok-nt">MINIO_ROOT_PASSWORD</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">M2QEhwXOlgPRYA3h83LGH4e0kSa5fDVCcRDPaFaQ45V</span>
<span class="tok-w">    </span><span class="tok-nt">entrypoint</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sh</span>
<span class="tok-w">    </span><span class="tok-nt">command</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">-c &#39;mkdir -p /data/uploads &amp;&amp; mkdir -p /data/attachments &amp;&amp; /opt/bin/minio server /data --console-address &quot;:9001&quot;&#39;</span><span class="tok-w"> </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">    </span><span class="tok-nt">deploy</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">resources</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">limits</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">cpus</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;0.5&quot;</span><span class="tok-w"> </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">          </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">200M</span><span class="tok-w"> </span><i class="conum" data-value="3"></i><b>(3)</b>

<span class="tok-w">  </span><span class="tok-c1"># ...</span>

<span class="tok-w">  </span><span class="tok-nt">api-gateway</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">build</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">context</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">main/api-gateway</span>
<span class="tok-w">      </span><span class="tok-nt">dockerfile</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">../../jar.Dockerfile</span><span class="tok-w"> </span><i class="conum" data-value="6"></i><b>(6)</b>
<span class="tok-w">      </span><span class="tok-nt">args</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">JAR_PATH=build/libs/api-gateway.jar</span><span class="tok-w"> </span><i class="conum" data-value="6"></i><b>(6)</b>
<span class="tok-w">    </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-s">&quot;10000:10000&quot;</span>
<span class="tok-w">    </span><span class="tok-nt">environment</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">spring.profiles.active</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">localcompose</span>
<span class="tok-w">    </span><span class="tok-nt">deploy</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">resources</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">limits</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">cpus</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;1&quot;</span><span class="tok-w"> </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">          </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">200M</span><span class="tok-w"> </span><i class="conum" data-value="3"></i><b>(3)</b>

<span class="tok-w">  </span><span class="tok-c1"># ...</span>

<span class="tok-w">  </span><span class="tok-nt">file-service</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">application</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">messenger</span>
<span class="tok-w">    </span><span class="tok-nt">build</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">context</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">main/file-service</span>
<span class="tok-w">      </span><span class="tok-nt">dockerfile</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">../../jar.Dockerfile</span><span class="tok-w"> </span><i class="conum" data-value="6"></i><b>(6)</b>
<span class="tok-w">      </span><span class="tok-nt">args</span><span class="tok-p">:</span><span class="tok-w"> </span><i class="conum" data-value="6"></i><b>(6)</b>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">JAR_PATH=build/libs/file-service.jar</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">JVM_ARGS=-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005</span>
<span class="tok-w">    </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-s">&quot;10003:10003&quot;</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-s">&quot;10203:5005&quot;</span>
<span class="tok-w">    </span><span class="tok-nt">environment</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">&lt;&lt;</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-nv">*microservice-env</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">      </span><span class="tok-nt">spring.profiles.active</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">local</span><span class="tok-w"> </span><i class="conum" data-value="5"></i><b>(5)</b>
<span class="tok-w">      </span><span class="tok-nt">s3.endpoint</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">http://minio:9000</span><span class="tok-w"> </span><i class="conum" data-value="5"></i><b>(5)</b>
<span class="tok-w">      </span><span class="tok-nt">s3.accessKeyId</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">LOZpOCD0i5tlzgpqmw</span><span class="tok-w"> </span><i class="conum" data-value="5"></i><b>(5)</b>
<span class="tok-w">      </span><span class="tok-nt">s3.secretAccessKey</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">M2QEhwXOlgPRYA3h83LGH4e0kSa5fDVCcRDPaFaQ45V</span><span class="tok-w"> </span><i class="conum" data-value="5"></i><b>(5)</b>
<span class="tok-w">    </span><span class="tok-nt">depends_on</span><span class="tok-p">:</span><span class="tok-w"> </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-w">      </span><span class="tok-nt">mysql</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">condition</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">service_healthy</span>
<span class="tok-w">    </span><span class="tok-nt">deploy</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">resources</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">limits</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">cpus</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;1&quot;</span><span class="tok-w"> </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">          </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">400M</span><span class="tok-w"> </span><span class="tok-c1"># file-service needs more memory </span><i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>DRY. Extract common configurations and reuse.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Initialize any data required by the application if necessary.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>CPU and memory are limited. Limit all the containers so that you have a less laggy computer to use.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Define health check and dependencies to avoid unnecessary error logs.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Additional service-specific configurations.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Reuse the same Dockerfile. Input the differences by passing arguments.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_monitoring">4.1.2. Monitoring</h4>
<div class="listingblock">
<div class="title">/docker-compose.yml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-w">  </span><span class="tok-c1">## Monitoring Architecture</span>
<span class="tok-w">  </span><span class="tok-nt">otel-collector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">otel/opentelemetry-collector-contrib</span>
<span class="tok-w">    </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">application</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">messenger</span>
<span class="tok-w">    </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">10105:4317</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">10106:4318</span>
<span class="tok-w">    </span><span class="tok-nt">volumes</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">./infra/otel-collector/otel-collector-config.yaml:/etc/otelcol-contrib/config.yaml</span><span class="tok-w"> </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">    </span><span class="tok-nt">depends_on</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">jaeger</span>
<span class="tok-w">    </span><span class="tok-nt">deploy</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">resources</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">limits</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">cpus</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;1&quot;</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">          </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">150M</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">  </span><span class="tok-nt">jaeger</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">application</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">messenger</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">jaegertracing/all-in-one:1.53</span>
<span class="tok-w">    </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">10107:16686</span><span class="tok-w"> </span><span class="tok-c1"># UI</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">10108:4317</span><span class="tok-w"> </span><span class="tok-c1"># OTLP gRPC</span>
<span class="tok-w">    </span><span class="tok-nt">deploy</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">resources</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">limits</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">cpus</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;1&quot;</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">          </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">300M</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">  </span><span class="tok-nt">prometheus</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">application</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">messenger</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">prom/prometheus:v2.49.1</span>
<span class="tok-w">    </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">10109:9090</span>
<span class="tok-w">    </span><span class="tok-nt">volumes</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">./infra/prometheus/prometheus.yaml:/etc/prometheus/prometheus.yml</span><span class="tok-w"> </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">    </span><span class="tok-nt">deploy</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">resources</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">limits</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">cpus</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;1&quot;</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">          </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">200M</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">  </span><span class="tok-nt">grafana</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">application</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">messenger</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">grafana/grafana:10.2.3</span>
<span class="tok-w">    </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">10110:3000</span>
<span class="tok-w">    </span><span class="tok-nt">volumes</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">./infra/grafana/provisioning/:/etc/grafana/provisioning/</span><span class="tok-w"> </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">    </span><span class="tok-nt">deploy</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">resources</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">limits</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">cpus</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;1&quot;</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">          </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">100M</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">  </span><span class="tok-nt">prom-blackbox-exporter</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">application</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">messenger</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">prom/blackbox-exporter:v0.24.0</span>
<span class="tok-w">    </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">10111:9115</span>
<span class="tok-w">    </span><span class="tok-nt">volumes</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">./infra/prom-blackbox-exporter/config.yaml:/config.yaml:ro</span><span class="tok-w"> </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">    </span><span class="tok-nt">command</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">--config.file=&quot;/config.yaml&quot;</span>
<span class="tok-w">    </span><span class="tok-nt">deploy</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">resources</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">limits</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">cpus</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;0.25&quot;</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">          </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">100M</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Resources are precious. Don&#8217;t let the cluster exhausts your PC.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The configuration files are put under the <code>/infra</code> directory and omitted here.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Setting resource limit is a trial-and-error process. Set a minimum yet performance-acceptable limit.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_logging">4.1.3. Logging</h4>
<div class="paragraph">
<p>The ELK architecture looks like this.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="diag-mermaid-md5-19c06b0b3bfb5af9369aca3c31f13104.png" alt="Diagram" width="503" height="218">
</div>
</div>
<div class="paragraph">
<p>Logspout collects <em>all</em> the logs in the docker host. We only need the logs related to this application. We can do it by adding <strong>labels</strong> to the interested services, and filter the logs by labels.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Do NOT collect logs from the logging architecture itself. Otherwise, an infinite loop is created and the disk space would be exhausted quickly.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">/docker-compose.yml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-w">  </span><span class="tok-c1">## Application Architecture</span>
<span class="tok-w">  </span><span class="tok-nt">api-gateway</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">application</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">messenger</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">    </span><span class="tok-nt">build</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-c1"># ...</span>

<span class="tok-w">  </span><span class="tok-nt">profile-service</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">application</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">messenger</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">    </span><span class="tok-nt">build</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-c1"># ...</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Add a label to the interested services.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If there is something wrong in the configuration, most of the time there is no meaningful error message. You can refer to this project while setting up the architecture.</p>
</div>
<div class="paragraph">
<p>To be simple, we disable all the security in this logging architecture, e.g. hardcoded password, disabled SSL. They should not be disabled in UAT and Production.</p>
</div>
<div class="listingblock">
<div class="title">/docker-compose.yml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-w">  </span><span class="tok-c1">## Logging Architecture</span>
<span class="tok-w">  </span><span class="tok-nt">elasticsearch</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">elasticsearch:8.12.2</span>
<span class="tok-w">    </span><span class="tok-nt">environment</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">discovery.type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">single-node</span>
<span class="tok-w">      </span><span class="tok-nt">ELASTIC_PASSWORD</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1234</span>
<span class="tok-w">      </span><span class="tok-nt">xpack.security.enabled</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">false</span>
<span class="tok-w">      </span><span class="tok-nt">cluster.routing.allocation.disk.threshold_enabled</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">false</span>
<span class="tok-w">    </span><span class="tok-nt">healthcheck</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">test</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">curl -f --insecure -X OPTIONS http://localhost:9200</span>
<span class="tok-w">    </span><span class="tok-nt">deploy</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">resources</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">limits</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1.5g</span>
<span class="tok-w">  </span><span class="tok-nt">logstash</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">docker.elastic.co/logstash/logstash:8.12.2</span>
<span class="tok-w">    </span><span class="tok-nt">volumes</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">./infra/logging/logstash/config.txt:/usr/share/logstash/pipeline/logstash.conf:ro</span>
<span class="tok-w">  </span><span class="tok-nt">logspout-logstash</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">build</span><span class="tok-p">:</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">      </span><span class="tok-nt">context</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">infra/logging/logspout-logstash</span>
<span class="tok-w">    </span><span class="tok-nt">volumes</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/var/run/docker.sock:/var/run/docker.sock</span>
<span class="tok-w">    </span><span class="tok-nt">environment</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">INACTIVITY_TIMEOUT</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">30s</span><span class="tok-w"> </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">    </span><span class="tok-nt">command</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">logstash://logstash:5000?filter.labels=application:messenger</span><span class="tok-w"> </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">    </span><span class="tok-nt">depends_on</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">logstash</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">condition</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">service_started</span><span class="tok-w"> </span><span class="tok-c1">#service_healthy</span>
<span class="tok-w">    </span><span class="tok-nt">restart</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">on-failure</span>
<span class="tok-w">    </span><span class="tok-nt">deploy</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">resources</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-c1"># according to README instructions in https://github.com/looplab/logspout-logstash</span>
<span class="tok-w">        </span><span class="tok-nt">limits</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">cpus</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;0.2&quot;</span>
<span class="tok-w">          </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">256M</span>
<span class="tok-w">        </span><span class="tok-nt">reservations</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">cpus</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;0.1&quot;</span>
<span class="tok-w">          </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">128M</span>
<span class="tok-w">  </span><span class="tok-nt">kibana</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">docker.elastic.co/kibana/kibana:8.12.2</span>
<span class="tok-w">    </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">10113:5601</span>
<span class="tok-w">    </span><span class="tok-nt">environment</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">elasticsearch.hosts</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&#39;[&quot;http://elasticsearch:9200&quot;]&#39;</span>
<span class="tok-w">      </span><span class="tok-nt">elasticsearch.ssl.verificationMode</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">none</span>
<span class="tok-w">      </span><span class="tok-nt">NODE_OPTIONS</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;--max_old_space_size=400&quot;</span>
<span class="tok-w">    </span><span class="tok-nt">depends_on</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">elasticsearch</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">condition</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">service_healthy</span>
<span class="tok-w">    </span><span class="tok-nt">deploy</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">resources</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">limits</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">cpus</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;1&quot;</span>
<span class="tok-w">          </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">500M</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The logspout docker image is customized in order to support sending logs to logstash.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Docker can hang. This parameter retries if docker does not respond within 30 seconds.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Very important&#8201;&#8212;&#8201;filter the logs by labels.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">/infra/logging/logstash/config.txt</div>
<div class="content">
<pre class="pygments highlight"><code><span></span>input {
  udp {
    port  =&gt; 5000
    codec =&gt; json
  }
  tcp {
    port  =&gt; 5000
    codec =&gt; json
  }
}

output {
  elasticsearch {
    hosts =&gt; &quot;http://elasticsearch:9200&quot;
    ssl =&gt; false
    ssl_certificate_verification =&gt; false
    user =&gt; elastic
    password =&gt; &quot;1234&quot;
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_multiple_instances_for_a_service">4.1.4. Multiple Instances for a Service</h4>
<div class="paragraph">
<p>It is advised to start multiple instances for each service concurrently. This helps you spot out some concurrent issues, especially schedule tasks.</p>
</div>
<div class="paragraph">
<p>In docker compose, it is a matter of updating the <code>docker-compose.yml</code> file:</p>
</div>
<div class="listingblock">
<div class="title">/docker-compose.yml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-w">  </span><span class="tok-nt">message-service</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">application</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">messenger</span>
<span class="tok-w">    </span><span class="tok-nt">build</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">context</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">main/message-service</span>
<span class="tok-w">      </span><span class="tok-nt">dockerfile</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">../../jar.Dockerfile</span>
<span class="tok-w">      </span><span class="tok-nt">args</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">JAR_PATH=build/libs/message-service.jar</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">JVM_ARGS=-XX:+AllowRedefinitionToAddDeleteMethods -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005</span>
<span class="tok-c1">#    ports: </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-c1">#      - &quot;10002:10002&quot;</span>
<span class="tok-c1">#      - &quot;10202:5005&quot;</span>
<span class="tok-w">    </span><span class="tok-nt">environment</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">&lt;&lt;</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-nv">*microservice-env</span>
<span class="tok-w">      </span><span class="tok-nt">spring.profiles.active</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">local</span>
<span class="tok-w">    </span><span class="tok-nt">depends_on</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">mysql</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">condition</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">service_healthy</span>
<span class="tok-w">    </span><span class="tok-nt">deploy</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">resources</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">limits</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">cpus</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;1&quot;</span>
<span class="tok-w">          </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">200M</span>
<span class="tok-w">      </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">3</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">      </span><span class="tok-nt">endpoint_mode</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">vip</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Start 3 instances of the message service.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Be aware of port clashes.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you want to expose ports from multiple-replica services, a range can be specified:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-w">    </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-s">&quot;10131-10133:10002&quot;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Specifying a port number in the request does not guarantee which container it would be sent to. Docker sends it randomly.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_persistence">4.1.5. Persistence</h4>
<div class="paragraph">
<p>If something needs to be persisted, persistent volumes can be added or mounted by specifying it in the <code>docker-compose.yml</code> file.</p>
</div>
<div class="paragraph">
<p>In this project, I do not need to persist any data except infrastructure configurations. All the testing data can be created manually and automatically. This practice can also save your time on fixing old bad data.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_launch_script">4.2. Launch Script</h3>
<div class="paragraph">
<p>Next, write a shell script to connect everything. In this project, that is about compilation and kickoff the Docker Compose containers.</p>
</div>
<div class="listingblock">
<div class="title">/rebuild-and-up.sh</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-ch">#!/bin/bash</span>
<span class="tok-nb">set</span><span class="tok-w"> </span>-e<span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-nb">pushd</span><span class="tok-w"> </span>main
./gradlew<span class="tok-w"> </span><span class="tok-s2">&quot;:api-gateway:bootJar&quot;</span><span class="tok-w"> </span><span class="tok-s2">&quot;:profile-service:bootJar&quot;</span><span class="tok-w"> </span><span class="tok-s2">&quot;:message-service:bootJar&quot;</span><span class="tok-w"> </span><span class="tok-s2">&quot;:file-service:bootJar&quot;</span>
<span class="tok-nb">popd</span>

docker<span class="tok-w"> </span>compose<span class="tok-w"> </span>up<span class="tok-w"> </span>--build</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Remember to set this flag to stop executing when there is an error.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Database initialization would be performed by Flyway. We will implement that later.</p>
</div>
<div class="paragraph">
<p>OK, so we have a working Local environment now.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_application_base_framework">5. Application Base Framework</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section gives a brief introduction on what should be commonized into library modules.</p>
</div>
<div class="sect2">
<h3 id="_application_server_request_response_logging">5.1. Application Server Request, Response Logging</h3>
<div class="paragraph">
<p>In most of the projects, especially those involving third-party integration, it is necessary to log request and response in order to enable incident diagnosis. There are multiple places requiring this feature. This section focus on logging of incoming requests and their corresponding responses.</p>
</div>
<div class="paragraph">
<p>No matter Spring MVC or Spring Webflux is used, it must be implemented at filter level, because you will want to log requests that blocked by the framework or responses returned by the framework, in which they are usually the focus of diagnosis. Implementing this logging is tricky. There are multiple considerations:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Request Consumption</dt>
<dd>
<p>HTTP request body is a stream. It can only be consumed once. If your log filter consumes the request without extra care, the body is not readable by consequent filters and controllers. Normally, it is workaround by caching the request in memory.</p>
</dd>
<dt class="hdlist1">Memory Consumption</dt>
<dd>
<p>While you attempt to cache the request in memory, in a naive implementation, a 10-GB request requires <strong>at least</strong> 10 GB memory. I say "at least", because using a JSON parser, for example, can demand another 10 GB memory during parsing. Storing it to a model may be another 10 GB again. So total 30 GB memory is used for this request. This probably results in a famous Out-Of-Memory crash of the application server.</p>
<div class="paragraph">
<p>May be you think it is too extreme. A more likely case is an application server needs to be capable to process average 10 MB requests uploaded by each of a maximum 500 concurrent users. A naive implementation requires \(10 \text{ MB} \times 500 \text{ requests} \times 3 = 15 \text{ GB}\) memory, which is far more than the maximum limit of a regular application server. A regular server may have 7 GB usable memory, while a microservice container may have only 300 MB memory.</p>
</div>
<div class="paragraph">
<p>There are different solutions to remedy this issue:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Reject large requests before processing</p>
</li>
<li>
<p>If a request is over a threshold, give up logging the content and not to cache the request, or</p>
</li>
<li>
<p>Log and cache only the first few-hundred bytes</p>
</li>
<li>
<p>Optimize <strong>all</strong> the processes to stream the request</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Reactiveness</dt>
<dd>
<p>If the server is reactive, is your logging process blocking? An improper implementation may bring a reactive server becomes non-reactive. You can find out this by performing load tests with and without the logging, and comparing the result.</p>
</dd>
<dt class="hdlist1">Storage Capacity and Cost</dt>
<dd>
<p>Do a math calculation, how much log size is produced per day, per month and per year in Production? Is it realistic to store logs in a size unit of TB? Are the allocated hard disks capable to store such size? If it is on cloud, does the client expect this storage cost?</p>
<div class="paragraph">
<p>Solutions are rather straight-forward:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Buy large hard disks or cloud storage</p>
</li>
<li>
<p>Review the requirements, perhaps store only the key things.</p>
</li>
<li>
<p>Keep the log in a cold storage to lower the cost.</p>
</li>
<li>
<p>Housekeep the logs so that, for example, only recent 3 year&#8217;s log is kept.</p>
</li>
<li>
<p>Perhaps different housekeeping policies for different kind of logs.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Association</dt>
<dd>
<p>Did the log associate with some identifiers? For example, can you filter the logs related to a response immediately, using a "request ID" embedded in response header or request header? If no, then the log can be useless when logging is overwhelmed in Production.</p>
</dd>
<dt class="hdlist1">Sensitive Data</dt>
<dd>
<p>Does this project require compliance of privacy policies that sensitive or PII (Personally Identifiable Information) data is not allowed to be logged? If yes, extra handling needs to be done to mask those sensitive data while logging the requests and responses. The implementation can be tricky. Always consider the above points.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Besides writing requests and responses to server log, another way is to write to a request tracer (e.g. Jaeger).</p>
</div>
</div>
<div class="sect2">
<h3 id="_request_tracing_assigning_request_ids">5.2. Request Tracing (Assigning Request IDs)</h3>
<div class="paragraph">
<p>As introduced in previous section, a log is useful when it is associated with a unique identifier that is known to the client. I name it a "request ID". There are different directions to implement this:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Server-generated ID</dt>
<dd>
<p>It guarantees absolute uniqueness. The request ID is returned in the response, in header or in body. In a proper API design, it should be in response header because it is a metadata commonly lives in all responses.</p>
<div class="paragraph">
<p>However, if a request timeouts, there is no request ID returned, and thus the log of this request is not associated. It can be a major headache in Production.</p>
</div>
</dd>
<dt class="hdlist1">Client-generated ID</dt>
<dd>
<p>How about letting client-side to generate the ID and pass it to servers via request header? This guarantees the log is always associated, but the ID may not be unique, it could pollute existing logs.</p>
</dd>
<dt class="hdlist1">Hybrid</dt>
<dd>
<p>To take the advantages of both worlds, it can be hybrid. Associate the log by a ID, which is the concatenation of the ID generated by client and server.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">/main/lib/http-server/src/main/kotlin/com/gtomato/server/application/messenger/common/filter/TraceIdFilter.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-k">import</span><span class="tok-w"> </span><span class="tok-nn">io.micrometer.tracing.Tracer</span>

<span class="tok-nd">@Component</span>
<span class="tok-nd">@Order</span><span class="tok-p">(</span><span class="tok-m">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-c1">// higher order than ErrorWebExceptionHandler</span>
<span class="tok-kd">class</span><span class="tok-w"> </span><span class="tok-nc">TraceIdFilter</span><span class="tok-w"> </span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">WebFilter</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nd">@Autowired</span>
<span class="tok-w">    </span><span class="tok-kd">lateinit</span><span class="tok-w"> </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">tracer</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">Tracer</span>

<span class="tok-w">    </span><span class="tok-kd">final</span><span class="tok-w"> </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">log</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">LogFactory</span><span class="tok-p">.</span><span class="tok-na">getLog</span><span class="tok-p">(</span><span class="tok-n">javaClass</span><span class="tok-p">)</span>

<span class="tok-w">    </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">REQUEST_HEADER_CLIENT_REQUEST_ID</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;request-id&quot;</span>
<span class="tok-w">    </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">RESPONSE_HEADER_REQUEST_ID</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;app-request-id&quot;</span>

<span class="tok-w">    </span><span class="tok-k">init</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">log</span><span class="tok-p">.</span><span class="tok-na">info</span><span class="tok-p">(</span><span class="tok-s">&quot;TraceIdFilter is instantiated.&quot;</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-kd">override</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">filter</span><span class="tok-p">(</span><span class="tok-n">exchange</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">ServerWebExchange</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">chain</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">WebFilterChain</span><span class="tok-p">):</span><span class="tok-w"> </span><span class="tok-n">Mono</span><span class="tok-o">&lt;</span><span class="tok-n">Void</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">traceId</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">tracer</span><span class="tok-p">.</span><span class="tok-na">currentSpan</span><span class="tok-p">()</span><span class="tok-o">?.</span><span class="tok-na">context</span><span class="tok-p">()</span><span class="tok-o">?.</span><span class="tok-na">traceId</span><span class="tok-p">()</span>
<span class="tok-w">        </span><span class="tok-n">exchange</span><span class="tok-p">.</span><span class="tok-na">request</span><span class="tok-p">.</span><span class="tok-na">headers</span><span class="tok-o">[</span><span class="tok-n">REQUEST_HEADER_CLIENT_REQUEST_ID</span><span class="tok-o">]?.</span><span class="tok-na">firstOrNull</span><span class="tok-p">()</span><span class="tok-o">?.</span><span class="tok-na">let</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">clientRequestId</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span>
<span class="tok-w">            </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">clientRequestId</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">clientRequestId</span><span class="tok-p">.</span><span class="tok-na">take</span><span class="tok-p">(</span><span class="tok-m">64</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-c1">// take at most first 64 characters</span>

<span class="tok-w">            </span><span class="tok-n">log</span><span class="tok-p">.</span><span class="tok-na">info</span><span class="tok-p">(</span><span class="tok-s">&quot;Client Request ID </span><span class="tok-si">$</span><span class="tok-n">clientRequestId</span><span class="tok-s">&quot;</span><span class="tok-p">)</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-n">exchange</span><span class="tok-p">.</span><span class="tok-na">response</span><span class="tok-p">.</span><span class="tok-na">beforeCommit</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">Mono</span><span class="tok-p">.</span><span class="tok-na">fromCallable</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                </span><span class="tok-n">traceId</span><span class="tok-o">?.</span><span class="tok-na">let</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">traceId</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span>
<span class="tok-w">                    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">exchange</span><span class="tok-p">.</span><span class="tok-na">response</span><span class="tok-p">.</span><span class="tok-na">headers</span><span class="tok-p">.</span><span class="tok-na">containsKey</span><span class="tok-p">(</span><span class="tok-n">RESPONSE_HEADER_REQUEST_ID</span><span class="tok-p">))</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-c1">// it might be added multiple times by multiple microservices</span>
<span class="tok-w">                        </span><span class="tok-c1">// https://github.com/spring-cloud/spring-cloud-gateway/issues/748</span>
<span class="tok-w">                        </span><span class="tok-n">exchange</span><span class="tok-p">.</span><span class="tok-na">response</span><span class="tok-p">.</span><span class="tok-na">headers</span><span class="tok-p">.</span><span class="tok-na">add</span><span class="tok-p">(</span><span class="tok-n">RESPONSE_HEADER_REQUEST_ID</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">traceId</span><span class="tok-p">)</span><span class="tok-w"> </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">                    </span><span class="tok-p">}</span>
<span class="tok-w">                </span><span class="tok-p">}</span>
<span class="tok-w">            </span><span class="tok-p">}.</span><span class="tok-na">then</span><span class="tok-p">()</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">chain</span><span class="tok-p">.</span><span class="tok-na">filter</span><span class="tok-p">(</span><span class="tok-n">exchange</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This line logs both client-sent request ID and server-generated request ID (<code>traceId</code>).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Return the server-generated request ID as a response header.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_exception_handling">5.3. Exception Handling</h3>
<div class="paragraph">
<p>DRY. Don&#8217;t do it at every function of an API controller. Do it once in an exception handler.</p>
</div>
<div class="paragraph">
<p>A minimal exception handling should include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Log the root cause and details of unknown errors</p>
</li>
<li>
<p>NOT to log details of known, frequent errors</p>
</li>
<li>
<p>Return a proper error code and descriptive message (always "System Error" is meaningless) to client-side</p>
</li>
<li>
<p>Mask sensitive information in the returned error message which can be a security issue</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Make sure to handle all kinds of errors, including those thrown by the framework.</p>
</div>
<div class="listingblock">
<div class="title">/main/lib/microservice-common/src/main/kotlin/com/gtomato/server/application/messenger/common/controlleradvice/ApplicationRestControllerAdvice.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-nd">@RestControllerAdvice</span>
<span class="tok-kd">class</span><span class="tok-w"> </span><span class="tok-nc">ApplicationRestControllerAdvice</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">log</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">LogFactory</span><span class="tok-p">.</span><span class="tok-na">getLog</span><span class="tok-p">(</span><span class="tok-n">javaClass</span><span class="tok-p">)</span>

<span class="tok-w">    </span><span class="tok-nd">@ExceptionHandler</span><span class="tok-p">(</span><span class="tok-n">ApiError</span><span class="tok-o">::</span><span class="tok-n">class</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-nd">@ResponseStatus</span><span class="tok-p">(</span><span class="tok-n">HttpStatus</span><span class="tok-p">.</span><span class="tok-na">CONFLICT</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-kd">suspend</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">handleApiError</span><span class="tok-p">(</span><span class="tok-n">error</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">ApiError</span><span class="tok-p">):</span><span class="tok-w"> </span><span class="tok-n">ErrorResponse</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">ErrorResponse</span><span class="tok-p">(</span><span class="tok-n">code</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">error</span><span class="tok-p">.</span><span class="tok-na">code</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">message</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">error</span><span class="tok-p">.</span><span class="tok-na">msg</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-nd">@ExceptionHandler</span><span class="tok-p">(</span><span class="tok-n">MissingRequestValueException</span><span class="tok-o">::</span><span class="tok-n">class</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-nd">@ResponseStatus</span><span class="tok-p">(</span><span class="tok-n">HttpStatus</span><span class="tok-p">.</span><span class="tok-na">BAD_REQUEST</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-kd">suspend</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">handleMissingInput</span><span class="tok-p">(</span><span class="tok-n">error</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">MissingRequestValueException</span><span class="tok-p">):</span><span class="tok-w"> </span><span class="tok-n">ErrorResponse</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">ErrorResponse</span><span class="tok-p">(</span><span class="tok-n">code</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;MISSING_INPUT&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">message</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">error</span><span class="tok-p">.</span><span class="tok-na">reason</span><span class="tok-w"> </span><span class="tok-o">?:</span><span class="tok-w"> </span><span class="tok-s">&quot;Missing input&quot;</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-nd">@ExceptionHandler</span><span class="tok-p">(</span><span class="tok-n">ServerWebInputException</span><span class="tok-o">::</span><span class="tok-n">class</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-nd">@ResponseStatus</span><span class="tok-p">(</span><span class="tok-n">HttpStatus</span><span class="tok-p">.</span><span class="tok-na">BAD_REQUEST</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-kd">suspend</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">handleInvalidRequest</span><span class="tok-p">(</span><span class="tok-n">error</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">ServerWebInputException</span><span class="tok-p">):</span><span class="tok-w"> </span><span class="tok-n">ErrorResponse</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">ErrorResponse</span><span class="tok-p">(</span><span class="tok-n">code</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;INVALID_REQUEST&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">message</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-si">${</span><span class="tok-n">error</span><span class="tok-p">.</span><span class="tok-na">reason</span><span class="tok-w"> </span><span class="tok-o">?:</span><span class="tok-w"> </span><span class="tok-s">&quot;&quot;</span><span class="tok-si">}</span><span class="tok-s">. It could be missing required input.&quot;</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-nd">@ExceptionHandler</span><span class="tok-p">(</span><span class="tok-n">Throwable</span><span class="tok-o">::</span><span class="tok-n">class</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-nd">@ResponseStatus</span><span class="tok-p">(</span><span class="tok-n">HttpStatus</span><span class="tok-p">.</span><span class="tok-na">INTERNAL_SERVER_ERROR</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-kd">suspend</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">handleUnexpectedError</span><span class="tok-p">(</span><span class="tok-n">error</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">Throwable</span><span class="tok-p">):</span><span class="tok-w"> </span><span class="tok-n">ErrorResponse</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">log</span><span class="tok-p">.</span><span class="tok-na">warn</span><span class="tok-p">(</span><span class="tok-s">&quot;Unexpected error occurred&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">error</span><span class="tok-p">)</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">        </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">errorMsg</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">when</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">error</span><span class="tok-p">.</span><span class="tok-na">javaClass</span><span class="tok-p">.</span><span class="tok-na">name</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-s">&quot;org.springframework.dao.DataAccessResourceFailureException&quot;</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span><span class="tok-w"> </span><span class="tok-s">&quot;DB resource failure&quot;</span><span class="tok-w"> </span><span class="tok-c1">// hide sensitive information, e.g. SQL </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">            </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span><span class="tok-w"> </span><span class="tok-n">error</span><span class="tok-p">.</span><span class="tok-na">message</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">ErrorResponse</span><span class="tok-p">(</span><span class="tok-n">code</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;UNEXPECTED&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">message</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;Unexpected error occurred -- </span><span class="tok-si">$</span><span class="tok-n">errorMsg</span><span class="tok-s">&quot;</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Log the error detail / stacktrace only if it is unknown</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Hide sensitive information, such as SQL used, from the response</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_authorization">5.4. Authorization</h3>
<div class="sect3">
<h4 id="_design">5.4.1. Design</h4>
<div class="paragraph">
<p>In this project, <a href="https://jwt.io/">JWT</a> is used as a stateless authorization, which means no storage is needed to issue and validate an access token. JWT can carry custom data in an <em>unencrypted</em> format. Things like user ID or permissions of the user can be embedded into JWT.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Improper verification of JWT is vulnerable. There are <a href="https://systemweakness.com/deep-dive-into-jwt-attacks-efc607858af6">many many ways</a> to exploit JWTs. It can allow an unauthorized person to access application services on behalf of anybody. Using a popular JWT library and following their documented best practices should be able to mitigate most of the attacks.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Do not attempt to read from database to verify or get information about a JWT. This defeats the purpose of JWT and is an anti-pattern.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There is no requirement in authorizing an individual for partial resources in this project. If a person is logged in, they can access all the public APIs. The only authorization is that whether a public API requires login, and this is controlled by a custom annotation <code>@WithoutAuthentication</code>.</p>
</div>
<div class="paragraph">
<p>Authorization is done at microservice-level. If it is in API gateway, then API gateway will have to deal with the API whitelisting logic, which is a kind of coupling and violates SoC.</p>
</div>
</div>
<div class="sect3">
<h4 id="_implementation">5.4.2. Implementation</h4>
<div class="paragraph">
<p>Instead of Spring Security, authentication and authorization are implemented by hand to make it simpler and flexible.</p>
</div>
<div class="listingblock">
<div class="title">/main/lib/microservice-common/src/main/kotlin/com/gtomato/server/application/messenger/common/filter/AuthenticationFilter.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-kd">internal</span><span class="tok-w"> </span><span class="tok-kd">const</span><span class="tok-w"> </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">CONTEXT_USER_ID</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;UserId&quot;</span>

<span class="tok-nd">@Component</span>
<span class="tok-kd">class</span><span class="tok-w"> </span><span class="tok-nc">AuthenticationFilter</span><span class="tok-w"> </span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">WebFilter</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">AUTH_HEADER_NAME</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;Authorization&quot;</span>
<span class="tok-w">    </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">AUTH_HEADER_VALUE_PREFIX</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;Bearer&quot;</span>

<span class="tok-w">    </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">jwtVerifier</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">JWT</span><span class="tok-p">.</span><span class="tok-na">require</span><span class="tok-p">(</span><span class="tok-n">Algorithm</span><span class="tok-p">.</span><span class="tok-na">HMAC256</span><span class="tok-p">(</span><span class="tok-n">Secret</span><span class="tok-p">.</span><span class="tok-na">LoginJwtKey</span><span class="tok-p">)).</span><span class="tok-na">build</span><span class="tok-p">()</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-w">    </span><span class="tok-nd">@Autowired</span>
<span class="tok-w">    </span><span class="tok-nd">@Qualifier</span><span class="tok-p">(</span><span class="tok-s">&quot;requestMappingHandlerMapping&quot;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-c1">// Spring Boot Actuator will add another RequestMappingHandlerMapping</span>
<span class="tok-w">    </span><span class="tok-kd">lateinit</span><span class="tok-w"> </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">handlerMapping</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">RequestMappingHandlerMapping</span>

<span class="tok-w">    </span><span class="tok-nd">@Autowired</span>
<span class="tok-w">    </span><span class="tok-kd">lateinit</span><span class="tok-w"> </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">objectMapper</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">ObjectMapper</span>

<span class="tok-w">    </span><span class="tok-kd">override</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">filter</span><span class="tok-p">(</span><span class="tok-n">exchange</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">ServerWebExchange</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">chain</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">WebFilterChain</span><span class="tok-p">):</span><span class="tok-w"> </span><span class="tok-n">Mono</span><span class="tok-o">&lt;</span><span class="tok-n">Void</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">handlerMapping</span><span class="tok-p">.</span><span class="tok-na">getHandler</span><span class="tok-p">(</span><span class="tok-n">exchange</span><span class="tok-p">)</span>
<span class="tok-w">            </span><span class="tok-p">.</span><span class="tok-na">map</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">handler</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span>
<span class="tok-w">                </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">handler</span><span class="tok-w"> </span><span class="tok-k">is</span><span class="tok-w"> </span><span class="tok-n">HandlerMethod</span><span class="tok-w"> </span><span class="tok-o">&amp;&amp;</span><span class="tok-w"> </span><span class="tok-n">isRequireAuthorization</span><span class="tok-p">(</span><span class="tok-n">handler</span><span class="tok-p">))</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                    </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">header</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">exchange</span><span class="tok-p">.</span><span class="tok-na">request</span><span class="tok-p">.</span><span class="tok-na">headers</span><span class="tok-o">[</span><span class="tok-n">AUTH_HEADER_NAME</span><span class="tok-o">]?.</span><span class="tok-na">firstOrNull</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-o">?:</span><span class="tok-w"> </span><span class="tok-k">throw</span><span class="tok-w"> </span><span class="tok-n">MissingInputException</span><span class="tok-p">(</span><span class="tok-n">AUTH_HEADER_NAME</span><span class="tok-p">)</span>
<span class="tok-w">                    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">header</span><span class="tok-p">.</span><span class="tok-na">startsWith</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-si">$</span><span class="tok-n">AUTH_HEADER_VALUE_PREFIX</span><span class="tok-s"> &quot;</span><span class="tok-p">))</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                        </span><span class="tok-k">throw</span><span class="tok-w"> </span><span class="tok-n">InvalidInputException</span><span class="tok-p">(</span><span class="tok-n">AUTH_HEADER_NAME</span><span class="tok-p">)</span>
<span class="tok-w">                    </span><span class="tok-p">}</span>
<span class="tok-w">                    </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">token</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">header</span><span class="tok-p">.</span><span class="tok-na">substringAfter</span><span class="tok-p">(</span><span class="tok-n">AUTH_HEADER_VALUE_PREFIX</span><span class="tok-p">).</span><span class="tok-na">trim</span><span class="tok-p">()</span>
<span class="tok-w">                    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">token</span><span class="tok-p">.</span><span class="tok-na">isEmpty</span><span class="tok-p">())</span><span class="tok-w"> </span><span class="tok-k">throw</span><span class="tok-w"> </span><span class="tok-n">InvalidInputException</span><span class="tok-p">(</span><span class="tok-n">AUTH_HEADER_NAME</span><span class="tok-p">)</span>
<span class="tok-w">                    </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">jwt</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">try</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                        </span><span class="tok-n">jwtVerifier</span><span class="tok-p">.</span><span class="tok-na">verify</span><span class="tok-p">(</span><span class="tok-n">token</span><span class="tok-p">)</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">                    </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">catch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">e</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">Throwable</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                        </span><span class="tok-k">throw</span><span class="tok-w"> </span><span class="tok-n">UnauthenticatedException</span><span class="tok-p">(</span><span class="tok-n">e</span><span class="tok-p">.</span><span class="tok-na">message</span><span class="tok-w"> </span><span class="tok-o">?:</span><span class="tok-w"> </span><span class="tok-s">&quot;Unauthenticated&quot;</span><span class="tok-p">)</span>
<span class="tok-w">                    </span><span class="tok-p">}</span>
<span class="tok-w">                    </span><span class="tok-n">exchange</span><span class="tok-p">.</span><span class="tok-na">attributes</span><span class="tok-o">[</span><span class="tok-n">CONTEXT_USER_ID</span><span class="tok-o">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">jwt</span><span class="tok-p">.</span><span class="tok-na">subject</span>
<span class="tok-w">                </span><span class="tok-p">}</span>
<span class="tok-w">            </span><span class="tok-p">}</span>
<span class="tok-w">            </span><span class="tok-p">.</span><span class="tok-na">then</span><span class="tok-p">(</span><span class="tok-n">chain</span><span class="tok-p">.</span><span class="tok-na">filter</span><span class="tok-p">(</span><span class="tok-n">exchange</span><span class="tok-p">))</span>
<span class="tok-w">            </span><span class="tok-p">.</span><span class="tok-na">onErrorResume</span><span class="tok-p">(</span><span class="tok-n">ApiError</span><span class="tok-o">::</span><span class="tok-n">class</span><span class="tok-p">.</span><span class="tok-na">java</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">error</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span><span class="tok-w"> </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">                </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">response</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ErrorResponse</span><span class="tok-p">(</span><span class="tok-n">code</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">error</span><span class="tok-p">.</span><span class="tok-na">code</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">message</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">error</span><span class="tok-p">.</span><span class="tok-na">msg</span><span class="tok-p">)</span>
<span class="tok-w">                </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">bodyBytes</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">objectMapper</span><span class="tok-p">.</span><span class="tok-na">writeValueAsBytes</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">)</span>
<span class="tok-w">                </span><span class="tok-n">exchange</span><span class="tok-p">.</span><span class="tok-na">response</span><span class="tok-p">.</span><span class="tok-na">headers</span><span class="tok-o">[</span><span class="tok-s">&quot;Content-Type&quot;</span><span class="tok-o">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;application/json&quot;</span>
<span class="tok-w">                </span><span class="tok-n">exchange</span><span class="tok-p">.</span><span class="tok-na">response</span><span class="tok-p">.</span><span class="tok-na">statusCode</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">HttpStatus</span><span class="tok-p">.</span><span class="tok-na">UNAUTHORIZED</span>
<span class="tok-w">                </span><span class="tok-k">return</span><span class="tok-nd">@onErrorResume</span><span class="tok-w"> </span><span class="tok-n">exchange</span><span class="tok-p">.</span><span class="tok-na">response</span><span class="tok-p">.</span><span class="tok-na">writeWith</span><span class="tok-p">(</span><span class="tok-n">Flux</span><span class="tok-p">.</span><span class="tok-na">just</span><span class="tok-p">(</span><span class="tok-n">exchange</span><span class="tok-p">.</span><span class="tok-na">response</span><span class="tok-p">.</span><span class="tok-na">bufferFactory</span><span class="tok-p">().</span><span class="tok-na">wrap</span><span class="tok-p">(</span><span class="tok-n">bodyBytes</span><span class="tok-p">)))</span>
<span class="tok-w">            </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">isRequireAuthorization</span><span class="tok-p">(</span><span class="tok-n">handler</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">HandlerMethod</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=</span>
<span class="tok-w">        </span><span class="tok-p">(</span><span class="tok-n">handler</span><span class="tok-p">.</span><span class="tok-na">hasMethodAnnotation</span><span class="tok-p">(</span><span class="tok-n">PublicApi</span><span class="tok-o">::</span><span class="tok-n">class</span><span class="tok-p">.</span><span class="tok-na">java</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">||</span><span class="tok-w"> </span><span class="tok-n">handler</span><span class="tok-p">.</span><span class="tok-na">beanType</span><span class="tok-p">.</span><span class="tok-na">isAnnotationPresent</span><span class="tok-p">(</span><span class="tok-n">PublicApi</span><span class="tok-o">::</span><span class="tok-n">class</span><span class="tok-p">.</span><span class="tok-na">java</span><span class="tok-p">))</span><span class="tok-w"> </span><span class="tok-o">&amp;&amp;</span>
<span class="tok-w">        </span><span class="tok-o">!</span><span class="tok-n">handler</span><span class="tok-p">.</span><span class="tok-na">hasMethodAnnotation</span><span class="tok-p">(</span><span class="tok-n">WithoutAuthentication</span><span class="tok-o">::</span><span class="tok-n">class</span><span class="tok-p">.</span><span class="tok-na">java</span><span class="tok-p">)</span><span class="tok-w"> </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>JWT verification.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Access control only applies to public APIs that do not mark <code>@WithoutAuthentication</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>It is not possible to propagate errors from filter to controller advices. If there will be multiple filters throwing errors, it is better to extract this error handling to a separate filter.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In filters, unfortunately, you have to write reactive codes.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When a user logins successfully, a pair of access token and refresh token is issued. Access tokens are short-lived, because there is no easy way to invalidate a JWT. If they expire, the client can get a new access token using the refresh token.</p>
</div>
<div class="paragraph">
<p>Refresh tokens are stored in database. They are invalidated when user logouts. There should be only one active refresh token associated to a login session at any time. A device may only have one active login session at any time. To prevent exploits, refresh tokens usually have an expiry time as well.</p>
</div>
<div class="listingblock">
<div class="title">/main/profile-service/src/main/kotlin/com/gtomato/server/application/messenger/profileservice/api/LoginSessionApi.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-w">    </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">jwtAlgorithm</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Algorithm</span><span class="tok-p">.</span><span class="tok-na">HMAC256</span><span class="tok-p">(</span><span class="tok-n">Secret</span><span class="tok-p">.</span><span class="tok-na">LoginJwtKey</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">secureRandom</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">SecureRandom</span><span class="tok-p">().</span><span class="tok-na">asKotlinRandom</span><span class="tok-p">()</span>
<span class="tok-w">    </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">refreshTokenCharSet</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-sc">&#39;a&#39;</span><span class="tok-p">..</span><span class="tok-sc">&#39;z&#39;</span><span class="tok-p">).</span><span class="tok-na">toSet</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-sc">&#39;A&#39;</span><span class="tok-p">..</span><span class="tok-sc">&#39;Z&#39;</span><span class="tok-p">).</span><span class="tok-na">toSet</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-sc">&#39;0&#39;</span><span class="tok-p">..</span><span class="tok-sc">&#39;9&#39;</span><span class="tok-p">).</span><span class="tok-na">toSet</span><span class="tok-p">()</span>

<span class="hll"><span class="tok-w">    </span><span class="tok-nd">@WithoutAuthentication</span>
</span><span class="tok-w">    </span><span class="tok-nd">@PostMapping</span>
<span class="tok-w">    </span><span class="tok-kd">suspend</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">login</span><span class="tok-p">(</span>
<span class="tok-w">        </span><span class="tok-nd">@RequestBody</span><span class="tok-w"> </span><span class="tok-n">payload</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">LoginPayload</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-nd">@RequestHeader</span><span class="tok-p">(</span><span class="tok-s">&quot;device-id&quot;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">deviceId</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">String</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-nd">@RequestHeader</span><span class="tok-p">(</span><span class="tok-s">&quot;platform&quot;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">devicePlatform</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">DevicePlatform</span><span class="tok-p">,</span>
<span class="tok-w">    </span><span class="tok-p">):</span><span class="tok-w"> </span><span class="tok-n">LoginSessionResource</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-nv">userId</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-nv">refreshToken</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">payload</span><span class="tok-p">.</span><span class="tok-na">username</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-kc">null</span><span class="tok-w"> </span><span class="tok-o">&amp;&amp;</span><span class="tok-w"> </span><span class="tok-n">payload</span><span class="tok-p">.</span><span class="tok-na">password</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-kc">null</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">user</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">accountRepository</span><span class="tok-p">.</span><span class="tok-na">findByUsernameAndPasswordHash</span><span class="tok-p">(</span>
<span class="tok-w">                </span><span class="tok-n">username</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">payload</span><span class="tok-p">.</span><span class="tok-na">username</span><span class="tok-o">!!</span><span class="tok-p">,</span>
<span class="tok-w">                </span><span class="tok-n">passwordHash</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">accountMapper</span><span class="tok-p">.</span><span class="tok-na">hashPassword</span><span class="tok-p">(</span><span class="tok-n">payload</span><span class="tok-p">.</span><span class="tok-na">password</span><span class="tok-o">!!</span><span class="tok-p">)</span>
<span class="tok-w">            </span><span class="tok-p">)</span>
<span class="tok-w">                </span><span class="tok-o">?:</span><span class="tok-w"> </span><span class="tok-k">throw</span><span class="tok-w"> </span><span class="tok-n">UnauthenticatedException</span><span class="tok-p">(</span><span class="tok-s">&quot;Login fail.&quot;</span><span class="tok-p">)</span>

<span class="tok-w">            </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">refreshToken</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-m">1.</span><span class="tok-p">.</span><span class="tok-m">60</span><span class="tok-p">).</span><span class="tok-na">map</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">refreshTokenCharSet</span><span class="tok-p">.</span><span class="tok-na">random</span><span class="tok-p">(</span><span class="tok-n">secureRandom</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">}.</span><span class="tok-na">joinToString</span><span class="tok-p">(</span><span class="tok-s">&quot;&quot;</span><span class="tok-p">)</span>
<span class="tok-w">            </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">loginSession</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">LoginSession</span><span class="tok-p">(</span>
<span class="tok-w">                </span><span class="tok-n">userId</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">user</span><span class="tok-p">.</span><span class="tok-na">id</span><span class="tok-p">,</span>
<span class="tok-w">                </span><span class="tok-n">refreshToken</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">refreshToken</span><span class="tok-p">,</span>
<span class="tok-w">                </span><span class="tok-n">expireAt</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Instant</span><span class="tok-p">.</span><span class="tok-na">now</span><span class="tok-p">().</span><span class="tok-na">plus</span><span class="tok-p">(</span><span class="tok-m">30</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">ChronoUnit</span><span class="tok-p">.</span><span class="tok-na">DAYS</span><span class="tok-p">),</span>
<span class="tok-w">                </span><span class="tok-n">deviceId</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">deviceId</span><span class="tok-p">,</span>
<span class="tok-w">                </span><span class="tok-n">devicePlatform</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">devicePlatform</span><span class="tok-p">,</span>
<span class="tok-w">            </span><span class="tok-p">).</span><span class="tok-na">let</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">loginSession</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span>
<span class="tok-w">                </span><span class="tok-n">loginSessionRepository</span><span class="tok-p">.</span><span class="tok-na">save</span><span class="tok-p">(</span><span class="tok-n">loginSession</span><span class="tok-p">)</span>
<span class="tok-w">            </span><span class="tok-p">}</span>

<span class="tok-w">            </span><span class="tok-n">Pair</span><span class="tok-p">(</span><span class="tok-n">user</span><span class="tok-p">.</span><span class="tok-na">id</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">refreshToken</span><span class="tok-p">)</span>
<span class="tok-w">        </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">payload</span><span class="tok-p">.</span><span class="tok-na">refreshToken</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-kc">null</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">session</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">loginSessionRepository</span><span class="tok-p">.</span><span class="tok-na">findByIsActiveAndRefreshTokenAndExpireAtAfter</span><span class="tok-p">(</span>
<span class="tok-w">                </span><span class="tok-n">isActive</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-kc">true</span><span class="tok-p">,</span>
<span class="tok-w">                </span><span class="tok-n">refreshToken</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">payload</span><span class="tok-p">.</span><span class="tok-na">refreshToken</span><span class="tok-o">!!</span><span class="tok-p">,</span>
<span class="tok-w">                </span><span class="tok-n">expireAtAfter</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Instant</span><span class="tok-p">.</span><span class="tok-na">now</span><span class="tok-p">(),</span>
<span class="tok-w">            </span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">?:</span><span class="tok-w"> </span><span class="tok-k">throw</span><span class="tok-w"> </span><span class="tok-n">UnauthenticatedException</span><span class="tok-p">(</span><span class="tok-s">&quot;Login session expired or invalid.&quot;</span><span class="tok-p">)</span>
<span class="tok-w">            </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">session</span><span class="tok-p">.</span><span class="tok-na">deviceId</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-n">deviceId</span><span class="tok-w"> </span><span class="tok-o">||</span><span class="tok-w"> </span><span class="tok-n">session</span><span class="tok-p">.</span><span class="tok-na">devicePlatform</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-n">devicePlatform</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                </span><span class="tok-k">throw</span><span class="tok-w"> </span><span class="tok-n">UnauthenticatedException</span><span class="tok-p">(</span><span class="tok-s">&quot;The login session is not eligible to be used on this device&quot;</span><span class="tok-p">)</span>
<span class="tok-w">            </span><span class="tok-p">}</span>
<span class="tok-w">            </span><span class="tok-n">Pair</span><span class="tok-p">(</span><span class="tok-n">session</span><span class="tok-p">.</span><span class="tok-na">userId</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kc">null</span><span class="tok-p">)</span>
<span class="tok-w">        </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-k">throw</span><span class="tok-w"> </span><span class="tok-n">MissingInputException</span><span class="tok-p">(</span><span class="tok-s">&quot;No login information is provided&quot;</span><span class="tok-p">)</span>
<span class="tok-w">        </span><span class="tok-p">}</span>

<span class="tok-w">        </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">jwt</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">JWT</span><span class="tok-p">.</span><span class="tok-na">create</span><span class="tok-p">()</span>
<span class="tok-w">            </span><span class="tok-p">.</span><span class="tok-na">withExpiresAt</span><span class="tok-p">(</span><span class="tok-n">Instant</span><span class="tok-p">.</span><span class="tok-na">now</span><span class="tok-p">().</span><span class="tok-na">plus</span><span class="tok-p">(</span><span class="tok-m">10</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">ChronoUnit</span><span class="tok-p">.</span><span class="tok-na">MINUTES</span><span class="tok-p">))</span>
<span class="tok-w">            </span><span class="tok-p">.</span><span class="tok-na">withSubject</span><span class="tok-p">(</span><span class="tok-n">userId</span><span class="tok-p">)</span>
<span class="tok-w">            </span><span class="tok-p">.</span><span class="tok-na">sign</span><span class="tok-p">(</span><span class="tok-n">jwtAlgorithm</span><span class="tok-p">)</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">LoginSessionResource</span><span class="tok-p">(</span>
<span class="tok-w">            </span><span class="tok-n">userId</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">userId</span><span class="tok-p">,</span>
<span class="tok-w">            </span><span class="tok-n">accessToken</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">jwt</span><span class="tok-p">,</span>
<span class="tok-w">            </span><span class="tok-n">refreshToken</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">refreshToken</span>
<span class="tok-w">        </span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Many Spring Security features, e.g. SAML, are not stateless. It stores user sessions in memory of that server instance.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_more_about_jwt">5.4.3. More about JWT</h4>
<div class="paragraph">
<p>In this project, an example of generated JWT looks like this:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3MDkwMjYzNTEsInN1YiI6ImIyNzM0ZGU1LTgyYjMtNDAxMy05ZDY2LWQwYTg5MDMzNzMxNCJ9.Fe8xzHXWo7Crji8WNPWgSy88lKXpAkB5oEZLb32kXUQ</pre>
</div>
</div>
<div class="paragraph">
<p>After decoding it:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Header: {"alg":"HS256","typ":"JWT"}
Payload: {"exp":1709026351,"sub":"b2734de5-82b3-4013-9d66-d0a890337314"}</pre>
</div>
</div>
<div class="paragraph">
<p>User ID is embedded into the JWT as a decodable data.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
If user ID is a sensitive data, it should be encrypted before embedding into a JWT.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
JWT can be used in everywhere that transmission of trusted plain text data is needed, not limited to authentication. I often use JWT as a paging cursor.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_resolving_common_parameters">5.5. Resolving Common Parameters</h3>
<div class="paragraph">
<p>In this project, it is frequently needed to parse user ID from the JWT token in request header. DRY and SoC. We will read the user ID like this, using a custom annotation <code>@RequestUserId</code>:</p>
</div>
<div class="listingblock">
<div class="title">/main/message-service/src/main/kotlin/com/gtomato/server/application/messenger/messageservice/api/ChannelApi.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-nd">@GetMapping</span>
<span class="hll"><span class="tok-kd">suspend</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">list</span><span class="tok-p">(</span><span class="tok-nd">@RequestUserId</span><span class="tok-w"> </span><span class="tok-n">userId</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">String</span><span class="tok-p">):</span><span class="tok-w"> </span><span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">ChatChannel</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
</span><span class="tok-w">    </span><span class="tok-c1">// ...</span>
<span class="tok-p">}</span>

<span class="tok-nd">@DeleteMapping</span><span class="tok-p">(</span><span class="tok-s">&quot;/{id}&quot;</span><span class="tok-p">)</span>
<span class="tok-nd">@ResponseStatus</span><span class="tok-p">(</span><span class="tok-n">HttpStatus</span><span class="tok-p">.</span><span class="tok-na">NO_CONTENT</span><span class="tok-p">)</span>
<span class="hll"><span class="tok-kd">suspend</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">inactivate</span><span class="tok-p">(</span><span class="tok-nd">@PathVariable</span><span class="tok-p">(</span><span class="tok-s">&quot;id&quot;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">channelId</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-nd">@RequestUserId</span><span class="tok-w"> </span><span class="tok-n">userId</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">String</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>JWT is parsed once in AuthenticationFilter and write to the request context. Write one resolver to resolve the userId parameter as the value in the request context.</p>
</div>
<div class="listingblock">
<div class="title">/main/lib/microservice-common/src/main/kotlin/com/gtomato/server/application/messenger/common/filter/AuthenticationFilter.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-kd">override</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">filter</span><span class="tok-p">(</span><span class="tok-n">exchange</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">ServerWebExchange</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">chain</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">WebFilterChain</span><span class="tok-p">):</span><span class="tok-w"> </span><span class="tok-n">Mono</span><span class="tok-o">&lt;</span><span class="tok-n">Void</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-c1">// ...</span>
<span class="tok-w">    </span><span class="tok-n">exchange</span><span class="tok-p">.</span><span class="tok-na">attributes</span><span class="tok-o">[</span><span class="tok-n">CONTEXT_USER_ID</span><span class="tok-o">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">jwt</span><span class="tok-p">.</span><span class="tok-na">subject</span>
<span class="tok-w">    </span><span class="tok-c1">// ...</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">/main/lib/microservice-common/src/main/kotlin/com/gtomato/server/application/messenger/common/annotation/RequestUserId.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-nd">@Target</span><span class="tok-p">(</span><span class="tok-n">AnnotationTarget</span><span class="tok-p">.</span><span class="tok-na">VALUE_PARAMETER</span><span class="tok-p">)</span>
<span class="tok-kd">annotation</span><span class="tok-w"> </span><span class="tok-kd">class</span><span class="tok-w"> </span><span class="tok-nc">RequestUserId</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">/main/lib/microservice-common/src/main/kotlin/com/gtomato/server/application/messenger/common/resolver/RequestUserIdResolver.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-nd">@Component</span>
<span class="tok-kd">class</span><span class="tok-w"> </span><span class="tok-nc">RequestUserIdResolver</span><span class="tok-w"> </span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">HandlerMethodArgumentResolver</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">override</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">supportsParameter</span><span class="tok-p">(</span><span class="tok-n">parameter</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">MethodParameter</span><span class="tok-p">):</span><span class="tok-w"> </span><span class="tok-kt">Boolean</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">parameter</span><span class="tok-p">.</span><span class="tok-na">hasParameterAnnotation</span><span class="tok-p">(</span><span class="tok-n">RequestUserId</span><span class="tok-o">::</span><span class="tok-n">class</span><span class="tok-p">.</span><span class="tok-na">java</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-kd">override</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">resolveArgument</span><span class="tok-p">(</span>
<span class="tok-w">        </span><span class="tok-n">parameter</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">MethodParameter</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">bindingContext</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">BindingContext</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">exchange</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">ServerWebExchange</span>
<span class="tok-w">    </span><span class="tok-p">):</span><span class="tok-w"> </span><span class="tok-n">Mono</span><span class="tok-o">&lt;</span><span class="tok-kt">Any</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">Mono</span><span class="tok-p">.</span><span class="tok-na">just</span><span class="tok-p">(</span><span class="tok-n">exchange</span><span class="tok-p">.</span><span class="tok-na">attributes</span><span class="tok-o">[</span><span class="tok-n">CONTEXT_USER_ID</span><span class="tok-o">]!!</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>More common stuffs, e.g. user device ID? Write a resolver for each of those. Instead of returning single primitive value, you could also return multiple values using a data class.</p>
</div>
</div>
<div class="sect2">
<h3 id="_parsing_x_forwarded_headers_to_obtain_real_ip_addresses">5.6. Parsing X-forwarded headers to obtain real IP addresses</h3>
<div class="paragraph">
<p>Usually application servers are deployed behind a proxy. Getting IP address of incoming requests using the usual way would yield the IP address of the proxy. To get real IP, we need to parse the <code>x-forwarded-*</code> headers added by the proxies.</p>
</div>
<div class="paragraph">
<p>Parsing those headers is not a trivial task. Fortunately, Spring Boot can help. By setting a configuration property, those headers are parsed and you will obtain the real IP addresses using the usual way.</p>
</div>
<div class="listingblock">
<div class="title">/main/lib/http-server/src/main/resources/application-httpserver.yaml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">server</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">forward-headers-strategy</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">native</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_inter_microservice_http_calls_openfeign">5.7. Inter-microservice HTTP calls (OpenFeign)</h3>
<div class="paragraph">
<p>In this project, RESTful HTTP calls are used in inter-microservice communication.</p>
</div>
<div class="paragraph">
<p>There are many options to fire HTTP calls among microservices and to external third parties. First we list out the requirements of this aspect:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Configurable timeout. Don&#8217;t hold connections for ages.</p>
</li>
<li>
<p>Interceptors for handling authorization.</p>
</li>
<li>
<p>Logging of requests and responses, including their bodies.</p>
</li>
<li>
<p>Request ID propagations.</p>
</li>
<li>
<p>Reactive (because this project is reactive)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Requirements that are nice to have:</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="6">
<li>
<p>Easy to use</p>
</li>
<li>
<p>Flexible</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
There are <a href="#_application_server_request_response_logging">many considerations</a> on logging request and response bodies.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Spring Cloud OpenFeign, which is based on OpenFeign, satisfies most of the requirements. OpenFeign is easy to use and so flexible that many components are plug-and-play. In additional to the features OpenFeign have, Spring Cloud OpenFeign integrates with Spring configuration properties, Spring Web annotations and Spring Boot auto-configuration, which is handy.</p>
</div>
<div class="paragraph">
<p>Unfortunately, the official one is not reactive nor asynchronous. It is also not possible to change it to reactive by changing its components. In the meantime, <a href="https://github.com/sunny-chung/spring-starter-feign-coroutine">spring-starter-feign-coroutine</a> can be used to provide asynchronous coroutine support.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Another alternative is <a href="https://github.com/PlaytikaOSS/feign-reactive">feign-reactive</a>, another unofficial Feign implementation. The reactive classes (e.g. <code>Mono&lt;T&gt;</code>, <code>Flux&lt;T&gt;</code>) can be converted into suspending functions using <code>.await*()</code> functions, which are provided by the <code>kotlinx-coroutines-reactive</code> library. So, <code>feign-reactive</code> is not a painful alternative.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
One more alternative is <a href="https://square.github.io/retrofit/">Retrofit</a>. Its use is very similar to OpenFeign, and supports suspending functions, but without plug-and-play components and Spring integration. We will explore and use Retrofit in integration tests.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The use would be like this:</p>
</div>
<div class="listingblock">
<div class="title">/main/profile-transport/src/main/kotlin/com/gtomato/server/application/messenger/profileservice/httprepository/AccountServiceApi.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-nd">@CoroutineFeignClient</span><span class="tok-p">(</span><span class="tok-n">name</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;profile-service&quot;</span><span class="tok-p">)</span>
<span class="tok-kd">interface</span><span class="tok-w"> </span><span class="tok-nc">AccountServiceApi</span><span class="tok-w"> </span><span class="tok-p">{</span>

<span class="tok-w">    </span><span class="tok-nd">@PostMapping</span><span class="tok-p">(</span><span class="tok-s">&quot;/internal/account/batchCheckValidity&quot;</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-kd">suspend</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">batchCheckAccountValidity</span><span class="tok-p">(</span><span class="tok-n">payload</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">CheckAccountValidityPayload</span><span class="tok-p">):</span><span class="tok-w"> </span><span class="tok-n">CheckAccountValidityResource</span>

<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">/main/lib/microservice-common/src/main/resources/application-local-microservice.yaml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">spring</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">cloud</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">openfeign</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">client</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">config</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">default</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">connect-timeout</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">2000</span>
<span class="tok-w">            </span><span class="tok-nt">read-timeout</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">5000</span>
<span class="tok-w">            </span><span class="tok-nt">defaultRequestHeaders</span><span class="tok-p">:</span>
<span class="tok-w">              </span><span class="tok-nt">content-type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">application/json</span>
<span class="tok-w">            </span><span class="tok-nt">loggerLevel</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">full</span><span class="tok-w"> </span><span class="tok-c1"># basic</span>
<span class="tok-w">          </span><span class="tok-nt">profile-service</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">url</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">http://localhost:10001</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Available configuration properties can be found in <a href="https://docs.spring.io/spring-cloud-openfeign/docs/4.0.6/reference/html/#spring-cloud-feign-overriding-defaults">Spring Cloud OpenFeign Documentation</a> and its <a href="https://docs.spring.io/spring-cloud-openfeign/docs/4.0.6/reference/html/appendix.html">Appendix</a>.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">/main/lib/feign-common/src/main/kotlin/com/gtomato/server/application/messenger/common/config/FeignConfig.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-nd">@Configuration</span>
<span class="tok-nd">@EnableCoroutineFeignClients</span><span class="tok-p">(</span><span class="tok-n">basePackages</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-o">[</span><span class="tok-s">&quot;com.gtomato.server.application.messenger&quot;</span><span class="tok-o">]</span><span class="tok-p">)</span>
<span class="tok-kd">class</span><span class="tok-w"> </span><span class="tok-nc">FeignConfig</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nd">@Bean</span>
<span class="tok-w">    </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">decoder</span><span class="tok-p">():</span><span class="tok-w"> </span><span class="tok-n">Decoder</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">JacksonDecoder</span><span class="tok-p">(</span>
<span class="tok-w">        </span><span class="tok-n">ObjectMapper</span><span class="tok-p">()</span>
<span class="tok-w">            </span><span class="tok-p">.</span><span class="tok-na">registerKotlinModule</span><span class="tok-p">()</span>
<span class="tok-w">            </span><span class="tok-p">.</span><span class="tok-na">configure</span><span class="tok-p">(</span><span class="tok-n">DeserializationFeature</span><span class="tok-p">.</span><span class="tok-na">FAIL_ON_UNKNOWN_PROPERTIES</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kc">false</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">)</span>

<span class="tok-w">    </span><span class="tok-nd">@Bean</span>
<span class="tok-w">    </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">encoder</span><span class="tok-p">():</span><span class="tok-w"> </span><span class="tok-n">Encoder</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">JacksonEncoder</span><span class="tok-p">()</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">/main/message-service/src/main/kotlin/com/gtomato/server/application/messenger/messageservice/api/ChannelApi.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-w">    </span><span class="tok-nd">@Autowired</span>
<span class="tok-w">    </span><span class="tok-kd">lateinit</span><span class="tok-w"> </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">accountServiceApi</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">AccountServiceApi</span>

<span class="tok-w">    </span><span class="tok-c1">// ...</span>

<span class="tok-w">    </span><span class="tok-nd">@PostMapping</span>
<span class="tok-w">    </span><span class="tok-nd">@ResponseStatus</span><span class="tok-p">(</span><span class="tok-n">HttpStatus</span><span class="tok-p">.</span><span class="tok-na">CREATED</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-nd">@Transactional</span>
<span class="tok-w">    </span><span class="tok-kd">suspend</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">create</span><span class="tok-p">(</span><span class="tok-nd">@RequestBody</span><span class="tok-w"> </span><span class="tok-n">payload</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">CreateChannelPayload</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-nd">@RequestHeader</span><span class="tok-p">(</span><span class="tok-s">&quot;request-id&quot;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">requestId</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-nd">@RequestUserId</span><span class="tok-w"> </span><span class="tok-n">userId</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">String</span><span class="tok-p">):</span><span class="tok-w"> </span><span class="tok-n">CreationResource</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-c1">// ...</span>
<span class="hll"><span class="tok-w">        </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">validities</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">CheckAccountValidityResource</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">accountServiceApi</span><span class="tok-p">.</span><span class="tok-na">batchCheckAccountValidity</span><span class="tok-p">(</span><span class="tok-n">CheckAccountValidityPayload</span><span class="tok-p">(</span><span class="tok-n">payload</span><span class="tok-p">.</span><span class="tok-na">participantIds</span><span class="tok-p">))</span>
</span><span class="tok-w">        </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">activeUsers</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">validities</span><span class="tok-p">.</span><span class="tok-na">isActive</span><span class="tok-p">.</span><span class="tok-na">toSet</span><span class="tok-p">()</span>
<span class="tok-w">        </span><span class="tok-c1">// ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>They are self-explanatory.</p>
</div>
</div>
<div class="sect2">
<h3 id="_model_mapping_mapstruct">5.8. Model Mapping (MapStruct)</h3>
<div class="paragraph">
<p>Model mapping is needed everywhere. Database entities are usually not directly returned to the client (Frontend). Some fields may be filtered out, transformed or even changed to another data type. Calling third party also requires model mapping as it is not desired to send them all the fields.</p>
</div>
<div class="paragraph">
<p>There are a lot model mapper libraries over the internet, for example, <a href="https://modelmapper.org/">ModelMapper</a>. Some developers may write their own. However, most of them use Java Reflection API to accomplish, which is significant slower and not safe. Under a heavy load environment, a mapping of a list of data can take 1 second. Not safe means developers won&#8217;t know if it is correct until the code is executed.</p>
</div>
<div class="paragraph">
<p><a href="https://mapstruct.org/">MapStruct</a> comes to the rescue. The mapping is done by code generation at compile-time. Under a heavy load environment, a mapping of a list of data takes 0.1s in runtime. What is more important, mapping correctness can be verified by inspecting the compiled code. If there is a type mismatch, the code will not compile. It is much better than discovering issues by encountering runtime exceptions from Reflection-based model mappers in UAT or even Production.</p>
</div>
<div class="paragraph">
<p>Although MapStruct generates only Java code, as Kotlin/JVM is interoperable with Java, it will work as intended.</p>
</div>
<div class="paragraph">
<p>To fully exercise DRY, we will extract common MapStruct configurations to an interface in a common module.</p>
</div>
<div class="listingblock">
<div class="title">/main/lib/microservice-common/src/main/kotlin/com/gtomato/server/application/messenger/common/mapper/AppMapperConfig.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-nd">@MapperConfig</span><span class="tok-p">(</span>
<span class="tok-w">    </span><span class="tok-n">componentModel</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">MappingConstants</span><span class="tok-p">.</span><span class="tok-na">ComponentModel</span><span class="tok-p">.</span><span class="tok-na">SPRING</span><span class="tok-p">,</span>
<span class="tok-w">    </span><span class="tok-n">unmappedTargetPolicy</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ReportingPolicy</span><span class="tok-p">.</span><span class="tok-na">IGNORE</span>
<span class="tok-p">)</span>
<span class="tok-kd">interface</span><span class="tok-w"> </span><span class="tok-nc">AppMapperConfig</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And use it like this:</p>
</div>
<div class="listingblock">
<div class="title">/main/message-service/src/main/kotlin/com/gtomato/server/application/messenger/messageservice/mapper/ChatChannelMapper.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="hll"><span class="tok-nd">@Mapper</span><span class="tok-p">(</span><span class="tok-n">config</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">AppMapperConfig</span><span class="tok-o">::</span><span class="tok-n">class</span><span class="tok-p">)</span>
</span><span class="tok-kd">interface</span><span class="tok-w"> </span><span class="tok-nc">ChatChannelMapper</span><span class="tok-w"> </span><span class="tok-p">{</span>

<span class="tok-w">    </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">copyChatChannel</span><span class="tok-p">(</span><span class="tok-n">source</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">ChatChannel</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-nd">@MappingTarget</span><span class="tok-w"> </span><span class="tok-n">target</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">ChatChannel</span><span class="tok-p">)</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tracing_and_metrics">5.9. Tracing and Metrics</h3>
<div class="paragraph">
<p>Include Spring Boot Actuator and OpenTelemetry related dependencies to enable tracing and metrics.</p>
</div>
<div class="listingblock">
<div class="title">/main/api-gateway/build.gradle.kts</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-n">dependencies</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-c1">// ...</span>

<span class="tok-w">    </span><span class="tok-n">implementation</span><span class="tok-p">(</span><span class="tok-s">&quot;org.springframework.boot:spring-boot-starter-actuator&quot;</span><span class="tok-p">)</span>

<span class="tok-w">    </span><span class="tok-c1">// observability</span>
<span class="tok-w">    </span><span class="tok-n">implementation</span><span class="tok-p">(</span><span class="tok-s">&quot;io.micrometer:micrometer-tracing-bridge-otel&quot;</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-n">implementation</span><span class="tok-p">(</span><span class="tok-s">&quot;io.opentelemetry:opentelemetry-exporter-otlp&quot;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-c1">// traces</span>
<span class="tok-w">    </span><span class="tok-n">implementation</span><span class="tok-p">(</span><span class="tok-s">&quot;io.micrometer:micrometer-registry-otlp:1.12.2&quot;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-c1">// metrics</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Configure the destination and the percentage of trace logging.</p>
</div>
<div class="listingblock">
<div class="title">/main/lib/microservice-common/src/main/resources/application-local-microservice.yaml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">management</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">tracing</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">sampling</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">probability</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1.0</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">  </span><span class="tok-nt">otlp</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metrics</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">export</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">url</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">http://otel-collector:4318/v1/metrics</span>
<span class="tok-w">    </span><span class="tok-nt">tracing</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">endpoint</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">http://otel-collector:4318/v1/traces</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Log 100% of the requests.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Enable "histogram" metrics so that we can analyze, for example, latency time at 95% of requests.</p>
</div>
<div class="listingblock">
<div class="title">/main/lib/http-server/src/main/resources/application-httpserver.yaml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">management</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">metrics</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">distribution</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">percentiles-histogram</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">http.server.requests</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">        </span><span class="tok-nt">http.client.requests</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">        </span><span class="tok-nt">tasks.scheduled.execution</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">    </span><span class="tok-nt">data</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">repository</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">autotime</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">percentiles-histogram</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_integration_with_either_mysql_or_mongodb_spring_data_r2dbc_mongodb">5.10. Integration with either MySQL or MongoDB (Spring Data R2DBC &amp; MongoDB)</h3>
<div class="paragraph">
<p>This project has a special requirement&#8201;&#8212;&#8201;it is needed to run with either a MySQL database, or a MongoDB database, but no need both. For example, it can be deployed to GCP and run along with a MySQL database. It can also be deployed to AWS and run with a MongoDB database.</p>
</div>
<div class="paragraph">
<p>DRY&#8201;&#8212;&#8201;we will only maintain one codebase, share the common code to support both databases. We can output two different artifacts to target different databases, so that the one work with MongoDB does not contain bulky libraries related to MySQL.</p>
</div>
<div class="sect3">
<h4 id="_gradle_configuration">5.10.1. Gradle Configuration</h4>
<div class="paragraph">
<p>Firstly, as seen in the <a href="#_gradle_modules">Gradle Modules</a> section, there will be three library modules, <code>lib:db-mysql</code>, <code>lib:db-mongodb</code> and <code>lib:db-common</code> , to handle the lower layer of database integration in this project. They are responsible to handle library dependencies and base classes. Spring Data solves a big problem for us&#8201;&#8212;&#8201;the base repository interfaces of Spring Data R2DBC and Spring Data MongoDB are the same, which would be <code>CoroutineCrudRepository</code> in this project.</p>
</div>
<div class="paragraph">
<p>A switch between MySQL and MongoDB is put inside a Gradle Plugin script. I have to admit this is quite deeply buried. A better place would be in <code>build.gradle.kts</code> or <code>gradle.properties</code>.</p>
</div>
<div class="listingblock">
<div class="title">/main/buildSrc/src/main/kotlin/messenger.microservice-spring.gradle.kts</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-kd">enum</span><span class="tok-w"> </span><span class="tok-kd">class</span><span class="tok-w"> </span><span class="tok-nc">Variation</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">MySQL</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">MongoDB</span>
<span class="tok-p">}</span>
<span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">variation</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">Variation</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Variation</span><span class="tok-p">.</span><span class="tok-na">MongoDB</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_mapping_annotations">5.10.2. Mapping Annotations</h4>
<div class="paragraph">
<p>Secondly, sometimes we need to write custom queries, in additional to the capabilities provided by Spring Data repository. Thanks to Kotlin&#8217;s <code>typealias</code> which can be applied to any classes, interfaces and <strong>annotations</strong>, we can write queries like this:</p>
</div>
<div class="listingblock">
<div class="title">/main/message-service/src/main/kotlin/com/gtomato/server/application/messenger/messageservice/repository/ChatMessageRepository.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-w">    </span><span class="tok-nd">@SQLQuery</span><span class="tok-p">(</span><span class="tok-s">&quot;SELECT * FROM (&quot;</span><span class="tok-w"> </span><span class="tok-o">+</span>
<span class="tok-w">            </span><span class="tok-s">&quot;    SELECT * FROM message__chat_message m&quot;</span><span class="tok-w"> </span><span class="tok-o">+</span>
<span class="tok-w">            </span><span class="tok-s">&quot;    WHERE (m.channel_id = :channelId)&quot;</span><span class="tok-w"> </span><span class="tok-o">+</span>
<span class="tok-w">            </span><span class="tok-s">&quot;       AND (m.is_active = :isActive)&quot;</span><span class="tok-w"> </span><span class="tok-o">+</span>
<span class="tok-w">            </span><span class="tok-s">&quot;       AND (m.create_at &gt; :createAtAfter)&quot;</span><span class="tok-w"> </span><span class="tok-o">+</span>
<span class="tok-w">            </span><span class="tok-s">&quot;       AND (m.create_at &lt; :createAtBefore)&quot;</span><span class="tok-w"> </span><span class="tok-o">+</span>
<span class="tok-w">            </span><span class="tok-s">&quot;       ORDER BY m.create_at ASC&quot;</span><span class="tok-w"> </span><span class="tok-o">+</span>
<span class="tok-w">            </span><span class="tok-s">&quot;) q WHERE match(q.content) against (:contentQuery in boolean mode)&quot;</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-nd">@MongoQuery</span><span class="tok-p">(</span><span class="tok-s">&quot;{ channelId: ?0, isActive: ?1, createAt: {\</span><span class="tok-si">$</span><span class="tok-n">gt</span><span class="tok-s">: ?2, \</span><span class="tok-si">$</span><span class="tok-n">lt</span><span class="tok-s">: ?3}, \</span><span class="tok-si">$</span><span class="tok-n">text</span><span class="tok-s">: {\</span><span class="tok-si">$</span><span class="tok-n">search</span><span class="tok-s">: ?4} }&quot;</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-kd">suspend</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">findByChannelIdAndIsActiveAndCreateAtAfterAndCreateAtBeforeAndContentAgainstFulltextQueryOrderByCreateAtAsc</span><span class="tok-p">(</span>
<span class="tok-w">        </span><span class="tok-n">channelId</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">String</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">isActive</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">Boolean</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">createAtAfter</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">Instant</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">createAtBefore</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">Instant</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">contentQuery</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">String</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">pageable</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">Pageable</span>
<span class="tok-w">    </span><span class="tok-p">):</span><span class="tok-w"> </span><span class="tok-n">Flow</span><span class="tok-o">&lt;</span><span class="tok-n">ChatMessage</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
The dollar sign character <code>$</code> has special meaning in Kotlin. You must escape it, no matter in a double quoted string (<code> "&#8230;&#8203;" </code>) or in a multiline string (<code>"""&#8230;&#8203;"""</code>). This can be a nightmare to write aggregation queries for MongoDB.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In <code>lib:db-mysql</code>, <code>@SQLQuery</code> is mapped to Spring Data R2DBC&#8217;s <code>@Query</code>. MongoDB annotations are mapped to a no-op annotation. Similar trick is also applied to <code>lib:db-mongodb</code>. Actually, there are quite a lot annotations to map.</p>
</div>
<div class="listingblock">
<div class="title">/main/lib/db-mysql/src/main/kotlin/com/gtomato/server/application/messenger/db/Query.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-k">import</span><span class="tok-w"> </span><span class="tok-nn">org.springframework.data.r2dbc.repository.Modifying</span>
<span class="tok-k">import</span><span class="tok-w"> </span><span class="tok-nn">org.springframework.data.r2dbc.repository.Query</span>

<span class="tok-k">typealias</span><span class="tok-w"> </span><span class="tok-n">SQLQuery</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Query</span>
<span class="tok-k">typealias</span><span class="tok-w"> </span><span class="tok-n">Modifying</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Modifying</span>

<span class="tok-k">typealias</span><span class="tok-w"> </span><span class="tok-n">MongoQuery</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">NoOpQuery</span>
<span class="tok-k">typealias</span><span class="tok-w"> </span><span class="tok-n">MongoAggregation</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">NoOpAggregation</span>
<span class="tok-k">typealias</span><span class="tok-w"> </span><span class="tok-n">MongoUpdate</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">NoOpQuery</span>
<span class="tok-k">typealias</span><span class="tok-w"> </span><span class="tok-n">MongoIndexed</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">NoOpIndex</span>
<span class="tok-k">typealias</span><span class="tok-w"> </span><span class="tok-n">MongoCompoundIndex</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">NoOpCompoundIndex</span>
<span class="tok-k">typealias</span><span class="tok-w"> </span><span class="tok-n">MongoCompoundIndexes</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">NoOpCompoundIndexes</span>
<span class="tok-k">typealias</span><span class="tok-w"> </span><span class="tok-n">MongoTextIndexed</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">NoOp</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">/main/lib/db-mongodb/src/main/kotlin/com/gtomato/server/application/messenger/db/Query.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-k">import</span><span class="tok-w"> </span><span class="tok-nn">org.springframework.data.mongodb.core.index.CompoundIndex</span>
<span class="tok-k">import</span><span class="tok-w"> </span><span class="tok-nn">org.springframework.data.mongodb.core.index.CompoundIndexes</span>
<span class="tok-k">import</span><span class="tok-w"> </span><span class="tok-nn">org.springframework.data.mongodb.core.index.Indexed</span>
<span class="tok-k">import</span><span class="tok-w"> </span><span class="tok-nn">org.springframework.data.mongodb.core.index.TextIndexed</span>
<span class="tok-k">import</span><span class="tok-w"> </span><span class="tok-nn">org.springframework.data.mongodb.repository.Aggregation</span>
<span class="tok-k">import</span><span class="tok-w"> </span><span class="tok-nn">org.springframework.data.mongodb.repository.Query</span>
<span class="tok-k">import</span><span class="tok-w"> </span><span class="tok-nn">org.springframework.data.mongodb.repository.Update</span>

<span class="tok-k">typealias</span><span class="tok-w"> </span><span class="tok-n">SQLQuery</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">NoOpQuery</span>
<span class="tok-k">typealias</span><span class="tok-w"> </span><span class="tok-n">Modifying</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">NoOp</span>

<span class="tok-k">typealias</span><span class="tok-w"> </span><span class="tok-n">MongoQuery</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Query</span>
<span class="tok-k">typealias</span><span class="tok-w"> </span><span class="tok-n">MongoAggregation</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Aggregation</span>
<span class="tok-k">typealias</span><span class="tok-w"> </span><span class="tok-n">MongoUpdate</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Update</span>
<span class="tok-k">typealias</span><span class="tok-w"> </span><span class="tok-n">MongoIndexed</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Indexed</span>
<span class="tok-k">typealias</span><span class="tok-w"> </span><span class="tok-n">MongoCompoundIndex</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">CompoundIndex</span>
<span class="tok-k">typealias</span><span class="tok-w"> </span><span class="tok-n">MongoCompoundIndexes</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">CompoundIndexes</span>
<span class="tok-k">typealias</span><span class="tok-w"> </span><span class="tok-n">MongoTextIndexed</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">TextIndexed</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">/main/lib/db-common/src/main/kotlin/com/gtomato/server/application/messenger/db/DisabledQuery.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-kd">annotation</span><span class="tok-w"> </span><span class="tok-kd">class</span><span class="tok-w"> </span><span class="tok-nc">NoOp</span><span class="tok-p">()</span>
<span class="tok-kd">annotation</span><span class="tok-w"> </span><span class="tok-kd">class</span><span class="tok-w"> </span><span class="tok-nc">NoOpQuery</span><span class="tok-p">(</span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">value</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">count</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">Boolean</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-kc">false</span><span class="tok-p">)</span>
<span class="tok-kd">annotation</span><span class="tok-w"> </span><span class="tok-kd">class</span><span class="tok-w"> </span><span class="tok-nc">NoOpAggregation</span><span class="tok-p">(</span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">value</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">Array</span><span class="tok-o">&lt;</span><span class="tok-kt">String</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-o">[]</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">pipeline</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">Array</span><span class="tok-o">&lt;</span><span class="tok-kt">String</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-o">[]</span><span class="tok-p">)</span>
<span class="tok-kd">annotation</span><span class="tok-w"> </span><span class="tok-kd">class</span><span class="tok-w"> </span><span class="tok-nc">NoOpIndex</span><span class="tok-p">(</span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">String</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">unique</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">Boolean</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-kc">false</span><span class="tok-p">)</span>
<span class="tok-kd">annotation</span><span class="tok-w"> </span><span class="tok-kd">class</span><span class="tok-w"> </span><span class="tok-nc">NoOpCompoundIndex</span><span class="tok-p">(</span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">String</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">unique</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">Boolean</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-kc">false</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">def</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">String</span><span class="tok-p">)</span>
<span class="tok-kd">annotation</span><span class="tok-w"> </span><span class="tok-kd">class</span><span class="tok-w"> </span><span class="tok-nc">NoOpCompoundIndexes</span><span class="tok-p">(</span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">value</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">Array</span><span class="tok-o">&lt;</span><span class="tok-n">NoOpCompoundIndex</span><span class="tok-o">&gt;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>However, this trick has some issues. Base classes like <code>BaseEntity</code> or <code>ScheduleJobRecord</code> cannot be put inside the <code>lib:db-common</code> module but have to be duplicated in <code>lib:db-mysql</code> and <code>lib:db-mongodb</code>, violating the DRY principle. If they need to be used inside <code>lib:db-common</code>, interfaces like <code>ScheduleJobRecordCommon</code> have to be created, which is somehow a duplication.</p>
</div>
<div class="listingblock">
<div class="title">/main/lib/db-common/src/main/kotlin/com/gtomato/server/application/messenger/common/entity/ScheduleJobRecordCommon.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-kd">interface</span><span class="tok-w"> </span><span class="tok-nc">ScheduleJobRecordCommon</span><span class="tok-w"> </span><span class="tok-p">{</span>

<span class="tok-w">    </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">id</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">String</span>

<span class="tok-w">    </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">lockedUntil</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">Instant</span>

<span class="tok-w">    </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">lockedAt</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">Instant?</span>

<span class="tok-w">    </span><span class="tok-c1">// ...</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_decoupling_by_using_interface_and_dependency_injection">5.10.3. Decoupling by using Interface and Dependency Injection</h4>
<div class="paragraph">
<p>For database-specific classes, use <code>interface</code>, implement the specific class in specific <code>lib:db-*</code> modules, provide and inject the bean into where it is used.</p>
</div>
<div class="listingblock">
<div class="title">/main/lib/db-common/src/main/kotlin/com/gtomato/server/application/messenger/db/textsearch/TextSearchQueryExpressionGenerator.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-kd">interface</span><span class="tok-w"> </span><span class="tok-nc">TextSearchQueryExpressionGenerator</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">toQueryExpression</span><span class="tok-p">(</span><span class="tok-n">tokens</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">TextSearchToken</span><span class="tok-o">&gt;</span><span class="tok-p">):</span><span class="tok-w"> </span><span class="tok-kt">String</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">/main/lib/db-mysql/src/main/kotlin/com/gtomato/server/application/messenger/db/textsearch/MysqlTextSearchQueryExpressionGenerator.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-nd">@Component</span>
<span class="tok-kd">class</span><span class="tok-w"> </span><span class="tok-nc">MysqlTextSearchQueryExpressionGenerator</span><span class="tok-w"> </span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">TextSearchQueryExpressionGenerator</span><span class="tok-w"> </span><span class="tok-p">{</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">/main/lib/db-mongodb/src/main/kotlin/com/gtomato/server/application/messenger/db/textsearch/MongoTextSearchQueryExpressionGenerator.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-nd">@Component</span>
<span class="tok-kd">class</span><span class="tok-w"> </span><span class="tok-nc">MongoTextSearchQueryExpressionGenerator</span><span class="tok-w"> </span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">TextSearchQueryExpressionGenerator</span><span class="tok-w"> </span><span class="tok-p">{</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To use it, inject the bean.</p>
</div>
<div class="listingblock">
<div class="title">/main/message-service/src/main/kotlin/com/gtomato/server/application/messenger/messageservice/api/MessageApi.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-w">    </span><span class="tok-nd">@Autowired</span>
<span class="tok-w">    </span><span class="tok-kd">lateinit</span><span class="tok-w"> </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">textSearchQueryExpressionGenerator</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">TextSearchQueryExpressionGenerator</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_base_schedule_tasks_distributed_locks">5.11. Base Schedule Tasks &amp; Distributed Locks</h3>
<div class="paragraph">
<p>We will dive deep into this topic <a href="#_schedule_tasks">later</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_other_common_stuffs">5.12. Other Common Stuffs</h3>
<div class="sect3">
<h4 id="_base_database_entities">5.12.1. Base Database Entities</h4>
<div class="paragraph">
<p>Regardless of database choices and use cases, I believe all regular entities should have following fields as a foundation.</p>
</div>
<div class="listingblock">
<div class="title">/main/lib/db-common/src/main/kotlin/com/gtomato/server/application/messenger/db/BaseEntity.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-kd">abstract</span><span class="tok-w"> </span><span class="tok-kd">class</span><span class="tok-w"> </span><span class="tok-nc">BaseEntityCommon</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nd">@Id</span>
<span class="tok-w">    </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">id</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">String</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">UUID</span><span class="tok-p">.</span><span class="tok-na">randomUUID</span><span class="tok-p">().</span><span class="tok-na">toString</span><span class="tok-p">()</span>

<span class="tok-w">    </span><span class="tok-kd">abstract</span><span class="tok-w"> </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">duplicationKey</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">String?</span>

<span class="tok-w">    </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">isActive</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">Boolean</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-kc">true</span>

<span class="tok-w">    </span><span class="tok-nd">@Version</span>
<span class="tok-w">    </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">version</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">Int?</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-kc">null</span>

<span class="tok-w">    </span><span class="tok-nd">@CreatedDate</span>
<span class="tok-w">    </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">createAt</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">Instant? </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-kc">null</span>

<span class="tok-w">    </span><span class="tok-nd">@LastModifiedDate</span>
<span class="tok-w">    </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">lastUpdateAt</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">Instant? </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-kc">null</span>

<span class="tok-w">    </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">fillDuplicationKey</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">duplicationKey</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">generateDuplicationKey</span><span class="tok-p">()</span><span class="tok-o">!!</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-kd">abstract</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">generateDuplicationKey</span><span class="tok-p">():</span><span class="tok-w"> </span><span class="tok-kt">String</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Fields <code>version</code>, <code>createAt</code> and <code>lastUpdateAt</code> can be automatically generated and managed by Spring Data by applying annotations.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
An auto-increment ID is not obvious to be implemented in MongoDB, and it creates coupling. Thus, we generate random UUIDs as unique String IDs of database records.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is a good idea to always include a duplication key field for uniqueness checking. If it is not needed for some entities, it can be set to the value of the record ID, or a random UUID. If there are multiple unique keys, it can be set to something like <code>{key1}|{key2}|{key3}</code>. In this case, <a href="https://owasp.org/www-community/Injection_Theory">injection attacks</a> need to be prevented by escaping input values.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The field <code>duplicationKey</code> is filled when a new record is saved, using <code>BeforeConvertCallback</code> (R2DBC) or <code>ReactiveBeforeConvertCallback</code> (MongoDB).</p>
</div>
<div class="listingblock">
<div class="title">/main/lib/db-mysql/src/main/kotlin/com/gtomato/server/application/messenger/db/BeforeConvertSaveEntityCallback.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-nd">@Component</span>
<span class="tok-kd">class</span><span class="tok-w"> </span><span class="tok-nc">BeforeConvertSaveEntityCallback</span><span class="tok-w"> </span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">BeforeConvertCallback</span><span class="tok-o">&lt;</span><span class="tok-n">BaseEntity</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">log</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">LogFactory</span><span class="tok-p">.</span><span class="tok-na">getLog</span><span class="tok-p">(</span><span class="tok-n">javaClass</span><span class="tok-p">)</span>

<span class="tok-w">    </span><span class="tok-kd">override</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">onBeforeConvert</span><span class="tok-p">(</span><span class="tok-n">entity</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">BaseEntity</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">table</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">SqlIdentifier</span><span class="tok-p">):</span><span class="tok-w"> </span><span class="tok-n">Publisher</span><span class="tok-o">&lt;</span><span class="tok-n">BaseEntity</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">log</span><span class="tok-p">.</span><span class="tok-na">debug</span><span class="tok-p">(</span><span class="tok-s">&quot;onBeforeConvert </span><span class="tok-si">${</span><span class="tok-n">entity</span><span class="tok-o">::</span><span class="tok-n">class</span><span class="tok-p">.</span><span class="tok-na">qualifiedName</span><span class="tok-si">}</span><span class="tok-s">&quot;</span><span class="tok-p">)</span>
<span class="tok-w">        </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">entity</span><span class="tok-p">.</span><span class="tok-na">version</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-kc">null</span><span class="tok-w"> </span><span class="tok-o">&amp;&amp;</span><span class="tok-w"> </span><span class="tok-n">entity</span><span class="tok-p">.</span><span class="tok-na">duplicationKey</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-kc">null</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">entity</span><span class="tok-p">.</span><span class="tok-na">fillDuplicationKey</span><span class="tok-p">()</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">Mono</span><span class="tok-p">.</span><span class="tok-na">just</span><span class="tok-p">(</span><span class="tok-n">entity</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_common_models_and_classes">5.12.2. Common models and classes</h4>
<div class="paragraph">
<p>Common stuffs like response models and exceptions classes can be put into common library modules. Which module to put is an artistic decision. Think carefully, how would they be used? If they are put in this module, what coupling would be created? Is the coupling too restrictive? What is the cost of refactoring it?</p>
</div>
<div class="paragraph">
<p>But don&#8217;t use too much time to think about it. Choose the one without high refactoring cost. It can be refactored later when the design is obsoleted.</p>
</div>
</div>
<div class="sect3">
<h4 id="_configuration_properties">5.12.3. Configuration Properties</h4>
<div class="paragraph">
<p>Ideally, we want to have multiple layers in configuration properties (application.yaml), where a base layer can be override by other layers. A layer can also be included or excluded according to needs. In this way we can cherrypick the configuration we need and share common configurations. DRY and SoC.</p>
</div>
<div class="paragraph">
<p>So lets brainstorm and design the layers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>HTTP server base configuration</p>
</li>
<li>
<p>Microservice base configuration</p>
</li>
<li>
<p>Database configuration</p>
</li>
<li>
<p>Per-microservice configuration</p>
</li>
<li>
<p>Per-environment configuration</p>
</li>
<li>
<p>Runtime environment configuration</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There can be many. I will leave this to you.</p>
</div>
<div class="paragraph">
<p>How to implement those layers? Spring provides some features to help:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.external-config">Precedences of various sources and config files</a></p>
</li>
<li>
<p>Import configuration files using <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.external-config.files.importing"><code>spring.config.import</code></a></p>
</li>
<li>
<p>Assigning different profiles to <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.profiles.groups">profile groups</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After organizing all the configuration properties, application.yaml of a microservice may look like this:</p>
</div>
<div class="listingblock">
<div class="title">/main/message-service/src/main/resources/application.yaml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">spring</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">application</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Message Service</span>
<span class="tok-w">  </span><span class="tok-nt">profiles</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">group</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">local</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">local-db, local-openfeign, local-microservice</span>
<span class="tok-w">      </span><span class="tok-nt">localcompose</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">localcompose-db, localcompose-openfeign</span>
<span class="tok-w">  </span><span class="tok-nt">config</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">import</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">application-httpserver.yaml, application-microservice.yaml, application-db.yaml</span>
<span class="tok-w">  </span><span class="tok-nt">r2dbc</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">message</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If the above configurations are common, it can be further refactored into another common yaml file.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_reactive_specific">5.13. Reactive Specific</h3>
<div class="sect3">
<h4 id="_context_propagation">5.13.1. Context propagation</h4>
<div class="paragraph">
<p>Since <a href="https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-3.2-Release-Notes">Spring Boot 3.2</a>, reactive context can be automatically propagated by adding the following configuration property:</p>
</div>
<div class="listingblock">
<div class="title">/main/lib/http-server/src/main/resources/application-httpserver.yaml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">spring</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">reactor</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">context-propagation</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">auto</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Before 3.2, a hook installation is needed before starting Spring Boot:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-k">import</span><span class="tok-w"> </span><span class="tok-nn">reactor.core.publisher.Hooks</span>

<span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">(</span><span class="tok-n">args</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">Array</span><span class="tok-o">&lt;</span><span class="tok-kt">String</span><span class="tok-o">&gt;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">Hooks</span><span class="tok-p">.</span><span class="tok-na">enableAutomaticContextPropagation</span><span class="tok-p">()</span>
<span class="tok-w">    </span><span class="tok-c1">// ...</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_blocking_code_detector">5.13.2. Blocking Code Detector</h4>
<div class="paragraph">
<p>There are tools, e.g. <strong>BlockHound</strong>, claiming they can detect blocking codes in a reactive application. But <strong>no, they don&#8217;t work</strong>, and they add significant performance overheads to the applications.</p>
</div>
<div class="paragraph">
<p>If you use them, you will start by encountering many false alarms. After whitelisting all of them according to official or community guidelines, and then write some blocking I/O calls. Wow, it is not detected!</p>
</div>
<div class="paragraph">
<p>They are also not maintained, due to restrictions enforced by recent Java versions.</p>
</div>
<div class="paragraph">
<p>The reliable ways to test for blocking code is to carry out <a href="#_load_test">load tests</a> or <a href="#_spring_boot_test">Spring Boot tests</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_relational_database_migrations">6. Relational Database Migrations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Database migrations include changes to columns, data, tables and the database. In this section, we only discuss relational databases, because NoSQL databases are schemaless and only data migration might be needed.</p>
</div>
<div class="paragraph">
<p>Avoid manual database migrations. There are many benefits:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The chance of missing database migrations in Production is much lower</p>
</li>
<li>
<p>If the migration has something wrong, it can be discovered in the development stage</p>
</li>
<li>
<p>It allows a person without knowledge of this project, e.g. a devops engineer, or CI/CD to perform deployment</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are a few popular database migration automation solutions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://flywaydb.org/">Flyway</a></p>
</li>
<li>
<p><a href="https://www.liquibase.org/">Liquibase</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>They have many ways to use. They can be used via a command line executable, thus integrable with CI/CD, or embedded in a Spring Boot application.</p>
</div>
<div class="paragraph">
<p>In this project, we will go with embedding Flyway into each microservice Spring Boot application.</p>
</div>
<div class="sect2">
<h3 id="_setup">6.1. Setup</h3>
<div class="sect3">
<h4 id="_migration_history_table">6.1.1. Migration History Table</h4>
<div class="paragraph">
<p>Both Flyway and Liquibase create a table in database to store migration log and status. Migrations are versioned. In a microservice pattern, we want to maintain independent versioning of migrations to avoid coupling. For example,</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Profile Service V1.0</p>
</li>
<li>
<p>Profile Service V1.1</p>
</li>
<li>
<p>Profile Service V1.2</p>
</li>
<li>
<p>Message Service V1.0</p>
</li>
<li>
<p>Message Service V1.1</p>
</li>
<li>
<p>File Service V1.0</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>But not:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Profile Service V1.0</p>
</li>
<li>
<p>Profile Service V1.1</p>
</li>
<li>
<p>Message Service V1.2</p>
</li>
<li>
<p>Profile Service V1.3</p>
</li>
<li>
<p>File Service V1.4</p>
</li>
<li>
<p>Message Service V1.5</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>When there are multiple developers working on different microservices, maintaining coupled versions is a nightmare.</p>
</div>
<div class="paragraph">
<p>One Flyway migration history table cannot handle multiple independent versions. Therefore, multiple schemas within a database or multiple databases are needed. This project will go for the way of multiple schemas in a single database.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/multiple-mysql-schema.png" alt="multiple mysql schema">
</div>
<div class="title">Figure 1. Example of multiple schemas within a MySQL database</div>
</div>
<div class="paragraph">
<p>This migration history table will be created and maintained automatically by Flyway.</p>
</div>
<div class="paragraph">
<p>Take 2 minutes to read the <a href="https://documentation.red-gate.com/flyway/quickstart-how-flyway-works">Flyway quick-start</a> article.</p>
</div>
</div>
<div class="sect3">
<h4 id="_spring_boot_integration">6.1.2. Spring Boot Integration</h4>
<div class="paragraph">
<p>Spring Boot has built-in integration with Flyway, as long as Flyway is included in the classpath. However, Flyway only supports blocking connections (JDBC) but not reactive (R2DBC). So, we have to include JDBC dependencies and JDBC configurations as well. End up we will have the following dependencies:</p>
</div>
<div class="listingblock">
<div class="title">/main/lib/db-mysql/build.gradle.kts</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-n">plugins</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">id</span><span class="tok-p">(</span><span class="tok-s">&quot;messenger.spring-kotlin&quot;</span><span class="tok-p">)</span>
<span class="tok-p">}</span>

<span class="tok-n">dependencies</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">api</span><span class="tok-p">(</span><span class="tok-n">project</span><span class="tok-p">(</span><span class="tok-s">&quot;:lib:db-common&quot;</span><span class="tok-p">))</span>
<span class="tok-w">    </span><span class="tok-n">api</span><span class="tok-p">(</span><span class="tok-s">&quot;org.springframework.boot:spring-boot-starter-data-r2dbc&quot;</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-n">runtimeOnly</span><span class="tok-p">(</span><span class="tok-s">&quot;io.asyncer:r2dbc-mysql&quot;</span><span class="tok-p">)</span>

<span class="hll"><span class="tok-w">    </span><span class="tok-n">api</span><span class="tok-p">(</span><span class="tok-s">&quot;org.flywaydb:flyway-core&quot;</span><span class="tok-p">)</span>
</span><span class="hll"><span class="tok-w">    </span><span class="tok-n">api</span><span class="tok-p">(</span><span class="tok-s">&quot;org.flywaydb:flyway-mysql&quot;</span><span class="tok-p">)</span>
</span><span class="hll"><span class="tok-w">    </span><span class="tok-n">runtimeOnly</span><span class="tok-p">(</span><span class="tok-s">&quot;com.mysql:mysql-connector-j&quot;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-c1">// for flyway use only</span>
</span>
<span class="tok-w">    </span><span class="tok-c1">// observability</span>
<span class="tok-w">    </span><span class="tok-n">api</span><span class="tok-p">(</span><span class="tok-s">&quot;io.r2dbc:r2dbc-proxy:1.1.4.RELEASE&quot;</span><span class="tok-p">)</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And configurations:</p>
</div>
<div class="listingblock">
<div class="title">/docker-compose.yml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">x-common-microservice-env</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-nl">&amp;microservice-env</span>
<span class="tok-w">  </span><span class="tok-nt">spring.profiles.active</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">local</span>
<span class="tok-w">  </span><span class="tok-nt">spring.r2dbc.url</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;r2dbcs:mysql://mysql:3306/?sslMode=required&quot;</span>
<span class="hll"><span class="tok-w">  </span><span class="tok-nt">spring.flyway.url</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;jdbc:mysql://mysql:3306/?sslMode=required&quot;</span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-nt">spring.flyway.user</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">root</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-nt">spring.flyway.password</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">123</span>
</span><span class="tok-w">  </span><span class="tok-nt">spring.cloud.openfeign.client.config.profile-service.url</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;http://profile-service:10001&quot;</span>
<span class="tok-w">  </span><span class="tok-nt">spring.cloud.openfeign.client.config.file-service.url</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;http://file-service:10003&quot;</span>
<span class="tok-w">  </span><span class="tok-c1"># ...</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A different user is used. It is more secure to have a low-privileged user for the application to only read and modify data, and another user to modify tables and databases.</td>
</tr>
</table>
</div>
<div class="literalblock">
<div class="title">/main/lib/db-mysql/src/main/resources/application-db.yaml</div>
<div class="content">
<pre>spring:
  flyway:
    default-schema: ${spring.r2dbc.name} <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Reuse configuration values.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_writing_migrations">6.2. Writing migrations</h3>
<div class="paragraph">
<p>Migration scripts are just SQL files, but filename matters. Filename contains a version number, which would affect the execution order. Read the <a href="https://documentation.red-gate.com/fd/migrations-184127470.html">official documentation</a> about this.</p>
</div>
<div class="paragraph">
<p>The migration files are organized under directories <code>/main/<em>{microservice}</em>/src/main/resources/db/migration/</code>. Here are some examples.</p>
</div>
<div class="listingblock">
<div class="title">/main/profile-service/src/main/resources/db/migration/V1_1__profile__account.sql</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span></span><span class="tok-k">GRANT</span><span class="tok-w"> </span><span class="tok-k">DELETE</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-k">INSERT</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-k">SELECT</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-k">UPDATE</span><span class="tok-w"> </span><span class="tok-k">ON</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-k">TO</span><span class="tok-w"> </span><span class="tok-s1">&#39;user1&#39;</span><span class="tok-o">@</span><span class="tok-s1">&#39;%&#39;</span><span class="tok-p">;</span>
<span class="tok-n">FLUSH</span><span class="tok-w"> </span><span class="tok-k">PRIVILEGES</span><span class="tok-p">;</span>

<span class="tok-k">CREATE</span><span class="tok-w"> </span><span class="tok-k">TABLE</span><span class="tok-w"> </span><span class="tok-n">profile__account</span><span class="tok-p">(</span>
<span class="tok-w">    </span><span class="tok-n">id</span><span class="tok-w"> </span><span class="tok-nb">VARCHAR</span><span class="tok-p">(</span><span class="tok-mi">255</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">PRIMARY</span><span class="tok-w"> </span><span class="tok-k">KEY</span><span class="tok-p">,</span>
<span class="tok-w">    </span><span class="tok-n">duplication_key</span><span class="tok-w"> </span><span class="tok-nb">VARCHAR</span><span class="tok-p">(</span><span class="tok-mi">255</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">UNIQUE</span><span class="tok-w"> </span><span class="tok-k">NOT</span><span class="tok-w"> </span><span class="tok-k">NULL</span><span class="tok-p">,</span>
<span class="tok-w">    </span><span class="tok-n">is_active</span><span class="tok-w"> </span><span class="tok-nb">BIT</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">NOT</span><span class="tok-w"> </span><span class="tok-k">NULL</span><span class="tok-p">,</span>
<span class="tok-w">    </span><span class="tok-k">version</span><span class="tok-w"> </span><span class="tok-nb">INTEGER</span><span class="tok-w"> </span><span class="tok-k">NOT</span><span class="tok-w"> </span><span class="tok-k">NULL</span><span class="tok-p">,</span>
<span class="tok-w">    </span><span class="tok-n">create_at</span><span class="tok-w"> </span><span class="tok-k">TIMESTAMP</span><span class="tok-p">(</span><span class="tok-mi">6</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">NOT</span><span class="tok-w"> </span><span class="tok-k">NULL</span><span class="tok-p">,</span>
<span class="tok-w">    </span><span class="tok-n">last_update_at</span><span class="tok-w"> </span><span class="tok-k">TIMESTAMP</span><span class="tok-p">(</span><span class="tok-mi">6</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">NOT</span><span class="tok-w"> </span><span class="tok-k">NULL</span><span class="tok-p">,</span>
<span class="tok-w">    </span><span class="tok-n">username</span><span class="tok-w"> </span><span class="tok-nb">VARCHAR</span><span class="tok-p">(</span><span class="tok-mi">255</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">NOT</span><span class="tok-w"> </span><span class="tok-k">NULL</span><span class="tok-p">,</span>
<span class="tok-w">    </span><span class="tok-n">password</span><span class="tok-w"> </span><span class="tok-nb">VARCHAR</span><span class="tok-p">(</span><span class="tok-mi">255</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">NOT</span><span class="tok-w"> </span><span class="tok-k">NULL</span><span class="tok-p">,</span>
<span class="tok-w">    </span><span class="tok-n">display_name</span><span class="tok-w"> </span><span class="tok-nb">VARCHAR</span><span class="tok-p">(</span><span class="tok-mi">255</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">NOT</span><span class="tok-w"> </span><span class="tok-k">NULL</span>
<span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">/main/message-service/src/main/resources/db/migration/V1_3__add_lastmessageat_to_chat_channel.sql</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span></span><span class="tok-k">ALTER</span><span class="tok-w"> </span><span class="tok-k">TABLE</span><span class="tok-w"> </span><span class="tok-n">message__chat_channel</span>
<span class="tok-w">    </span><span class="tok-k">ADD</span><span class="tok-w"> </span><span class="tok-k">COLUMN</span><span class="tok-w"> </span><span class="tok-n">last_message_at</span><span class="tok-w"> </span><span class="tok-k">TIMESTAMP</span><span class="tok-p">(</span><span class="tok-mi">6</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">AFTER</span><span class="tok-w"> </span><span class="tok-o">`</span><span class="tok-n">name</span><span class="tok-o">`</span><span class="tok-p">;</span>

<span class="tok-k">UPDATE</span><span class="tok-w"> </span><span class="tok-n">message__chat_channel</span><span class="tok-w"> </span><span class="tok-k">SET</span><span class="tok-w"> </span><span class="tok-n">last_message_at</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">create_at</span><span class="tok-w"> </span><span class="tok-k">WHERE</span><span class="tok-w"> </span><span class="tok-n">last_message_at</span><span class="tok-w"> </span><span class="tok-k">IS</span><span class="tok-w"> </span><span class="tok-k">NULL</span><span class="tok-p">;</span>

<span class="tok-k">ALTER</span><span class="tok-w"> </span><span class="tok-k">TABLE</span><span class="tok-w"> </span><span class="tok-n">message__chat_channel</span>
<span class="tok-w">    </span><span class="tok-k">MODIFY</span><span class="tok-w"> </span><span class="tok-k">COLUMN</span><span class="tok-w"> </span><span class="tok-n">last_message_at</span><span class="tok-w"> </span><span class="tok-k">TIMESTAMP</span><span class="tok-p">(</span><span class="tok-mi">6</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">NOT</span><span class="tok-w"> </span><span class="tok-k">NULL</span><span class="tok-p">;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_execution">6.3. Execution</h3>
<div class="paragraph">
<p>Database migrations happen during the startup of a Spring Boot application. Let&#8217;s watch the magic happens&#8201;&#8212;&#8201;start the microservices. In the application log, you will see if it runs successfully or not. You can also inspect the data in <code>flyway_schema_history</code> tables of each schema.</p>
</div>
<details>
<summary class="title">Example application log of database migration execution</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>2024-03-06 12:28:45 2024-03-06T12:28:45.244+08:00  INFO 1 --- [Message Service] [           main] [                                                 ] org.flywaydb.core.FlywayExecutor         : Database: jdbc:mysql://mysql:3306/ (MySQL 8.0)
2024-03-06 12:28:45 2024-03-06T12:28:45.422+08:00  INFO 1 --- [Message Service] [           main] [                                                 ] o.f.c.i.s.JdbcTableSchemaHistory         : Schema history table `message`.`flyway_schema_history` does not exist yet
2024-03-06 12:28:45 2024-03-06T12:28:45.435+08:00  INFO 1 --- [Message Service] [           main] [                                                 ] o.f.core.internal.command.DbValidate     : Successfully validated 4 migrations (execution time 00:00.083s)
2024-03-06 12:28:45 2024-03-06T12:28:45.476+08:00  INFO 1 --- [Message Service] [           main] [                                                 ] o.f.c.i.s.JdbcTableSchemaHistory         : Creating Schema History table `message`.`flyway_schema_history` ... <i class="conum" data-value="1"></i><b>(1)</b>
2024-03-06 12:27:51 OpenJDK 64-Bit Server VM warning: Option AllowRedefinitionToAddDeleteMethods was deprecated in version 13.0 and will likely be removed in a future release.
2024-03-06 12:28:45 2024-03-06T12:28:45.783+08:00  INFO 1 --- [Message Service] [           main] [                                                 ] o.f.core.internal.command.DbMigrate      : Current version of schema `message`: &lt;&lt; Empty Schema &gt;&gt;
2024-03-06 12:28:45 2024-03-06T12:28:45.828+08:00  INFO 1 --- [Message Service] [           main] [                                                 ] o.f.core.internal.command.DbMigrate      : Migrating schema `message` to version &quot;1.1 - chat channel&quot; <i class="conum" data-value="2"></i><b>(2)</b>
2024-03-06 12:28:45 2024-03-06T12:28:45.924+08:00  INFO 1 --- [Message Service] [           main] [                                                 ] o.f.core.internal.command.DbMigrate      : Migrating schema `message` to version &quot;1.2 - chat message&quot; <i class="conum" data-value="2"></i><b>(2)</b>
2024-03-06 12:28:46 2024-03-06T12:28:46.042+08:00  INFO 1 --- [Message Service] [           main] [                                                 ] o.f.core.internal.command.DbMigrate      : Migrating schema `message` to version &quot;1.3 - add lastmessageat to chat channel&quot; <i class="conum" data-value="2"></i><b>(2)</b>
2024-03-06 12:28:46 2024-03-06T12:28:46.112+08:00  INFO 1 --- [Message Service] [           main] [                                                 ] o.f.core.internal.command.DbMigrate      : Migrating schema `message` to version &quot;1.4 - alter chat message fulltext index&quot; <i class="conum" data-value="2"></i><b>(2)</b>
2024-03-06 12:28:46 2024-03-06T12:28:46.284+08:00  INFO 1 --- [Message Service] [           main] [                                                 ] o.f.core.internal.command.DbMigrate      : Successfully applied 4 migrations to schema `message`, now at version v1.4 (execution time 00:00.291s)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Initialization of Flyway migration history table</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Execution of migrations</td>
</tr>
</table>
</div>
</div>
</details>
<details>
<summary class="title">Example application log of no database migration needed</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>2024-03-06 12:28:48 2024-03-06T12:28:48.938+08:00  INFO 1 --- [Message Service] [           main] [                                                 ] o.f.c.internal.license.VersionPrinter    : Flyway Community Edition 9.22.3 by Redgate
2024-03-06 12:28:48 2024-03-06T12:28:48.938+08:00  INFO 1 --- [Message Service] [           main] [                                                 ] o.f.c.internal.license.VersionPrinter    : See release notes here: https://rd.gt/416ObMi
2024-03-06 12:28:48 2024-03-06T12:28:48.939+08:00  INFO 1 --- [Message Service] [           main] [                                                 ] o.f.c.internal.license.VersionPrinter    :
2024-03-06 12:28:49 2024-03-06T12:28:49.172+08:00  INFO 1 --- [Message Service] [           main] [                                                 ] org.flywaydb.core.FlywayExecutor         : Database: jdbc:mysql://mysql:3306/ (MySQL 8.0)
2024-03-06 12:28:49 2024-03-06T12:28:49.511+08:00  INFO 1 --- [Message Service] [           main] [                                                 ] o.f.core.internal.command.DbValidate     : Successfully validated 4 migrations (execution time 00:00.192s) <i class="conum" data-value="1"></i><b>(1)</b>
2024-03-06 12:28:49 2024-03-06T12:28:49.613+08:00  INFO 1 --- [Message Service] [           main] [                                                 ] o.f.core.internal.command.DbMigrate      : Current version of schema `message`: 1.4
2024-03-06 12:28:49 2024-03-06T12:28:49.642+08:00  INFO 1 --- [Message Service] [           main] [                                                 ] o.f.core.internal.command.DbMigrate      : Schema `message` is up to date. No migration necessary. <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>These signals are indicating it is working fine.</td>
</tr>
</table>
</div>
</div>
</details>
<div class="paragraph">
<p>If you want to undo or change the migration script, you would have to undo the changes manually in the database, including removing relevant rows from <code>flyway_schema_history</code> tables.</p>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion">6.4. Conclusion</h3>
<div class="paragraph">
<p>With a change in habit, without adding significant effort, we enjoy all the benefits it brings. You may feel not used to it during development, but in the long run, the accumulated effort (technical debt) and risk are actually smaller when the application grows.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_api_gateway">7. API Gateway</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Don&#8217;t do things like writing a function for each API to delegate the call. It is repetitive, worthless and hard to maintain. When a new API is introduced or there is a change in an API, the duplicated code requires copying or modification. When a global change is introduced, how many days are needed to update 50 APIs?</p>
</div>
<div class="paragraph">
<p>In this project, we are going to use Spring Cloud Gateway to do the dirty job. We will only write non-repetitive code and define the routes we need.</p>
</div>
<div class="paragraph">
<p>First, create a Gradle module.</p>
</div>
<div class="listingblock">
<div class="title">/main/api-gateway/build.gradle.kts</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-n">plugins</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">id</span><span class="tok-p">(</span><span class="tok-s">&quot;messenger.spring-kotlin&quot;</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-n">id</span><span class="tok-p">(</span><span class="tok-s">&quot;org.springframework.boot&quot;</span><span class="tok-p">)</span>
<span class="tok-p">}</span>

<span class="tok-n">dependencies</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">implementation</span><span class="tok-p">(</span><span class="tok-s">&quot;org.springframework.cloud:spring-cloud-starter-gateway&quot;</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-n">implementation</span><span class="tok-p">(</span><span class="tok-n">project</span><span class="tok-p">(</span><span class="tok-s">&quot;:lib:http-server&quot;</span><span class="tok-p">))</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_routing">7.1. Routing</h3>
<div class="listingblock">
<div class="title">/main/api-gateway/src/main/resources/application-localcompose.yaml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">spring</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">cloud</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">gateway</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">httpclient</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">response-timeout</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">10s</span>
<span class="tok-w">      </span><span class="tok-nt">routes</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">id</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">profile-service</span>
<span class="tok-w">          </span><span class="tok-nt">uri</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">http://profile-service:10001</span>
<span class="tok-w">          </span><span class="tok-nt">predicates</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Path=/loginSession/**, /account/**</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">id</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">message-service</span>
<span class="tok-w">          </span><span class="tok-nt">uri</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">http://message-service:10002</span>
<span class="tok-w">          </span><span class="tok-nt">predicates</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Path=/channel/**,/message/**</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">id</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">file-service</span>
<span class="tok-w">          </span><span class="tok-nt">uri</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">http://file-service:10003</span>
<span class="tok-w">          </span><span class="tok-nt">predicates</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Path=/upload/**</span>
<span class="tok-w">          </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">response-timeout</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">30000</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We only define the route and various timeout requirements we need. Add custom filters if needed.</p>
</div>
<div class="listingblock">
<div class="title">/main/api-gateway/src/main/kotlin/com/gtomato/server/application/messenger/apigateway/ApiGatewayApplication.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-nd">@SpringBootApplication</span><span class="tok-p">(</span><span class="tok-n">scanBasePackages</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-o">[</span><span class="tok-s">&quot;com.gtomato.server.application.messenger&quot;</span><span class="tok-o">]</span><span class="tok-p">)</span>
<span class="tok-kd">class</span><span class="tok-w"> </span><span class="tok-nc">ApiGatewayApplication</span>

<span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">(</span><span class="tok-n">args</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">Array</span><span class="tok-o">&lt;</span><span class="tok-kt">String</span><span class="tok-o">&gt;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">System</span><span class="tok-p">.</span><span class="tok-na">setProperty</span><span class="tok-p">(</span><span class="tok-s">&quot;reactor.netty.http.server.accessLogEnabled&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;true&quot;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-c1">// optional</span>
<span class="tok-w">    </span><span class="tok-n">Hooks</span><span class="tok-p">.</span><span class="tok-na">enableAutomaticContextPropagation</span><span class="tok-p">()</span>
<span class="tok-w">    </span><span class="tok-n">runApplication</span><span class="tok-o">&lt;</span><span class="tok-n">ApiGatewayApplication</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-o">*</span><span class="tok-n">args</span><span class="tok-p">)</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is the only code written for the API gateway.</p>
</div>
<div class="paragraph">
<p>Done. Run this Spring Boot application. Routing is working now.</p>
</div>
</div>
<div class="sect2">
<h3 id="_tracing_and_metrics_2">7.2. Tracing and Metrics</h3>
<div class="paragraph">
<p>If metrics and tracing are added to microservices, it is a must to add to API gateway, otherwise you can&#8217;t build a full picture of a request. To find out if there are any long-running API calls which involve multiple microservices and each only processes for a little time, only API gateway can know this.</p>
</div>
<div class="paragraph">
<p>The setup is the same with other microservices. No application code is needed.</p>
</div>
<div class="listingblock">
<div class="title">/main/api-gateway/build.gradle.kts</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-n">dependencies</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-c1">// ...</span>

<span class="tok-w">    </span><span class="tok-n">implementation</span><span class="tok-p">(</span><span class="tok-s">&quot;org.springframework.boot:spring-boot-starter-actuator&quot;</span><span class="tok-p">)</span>

<span class="tok-w">    </span><span class="tok-c1">// observability</span>
<span class="tok-w">    </span><span class="tok-n">implementation</span><span class="tok-p">(</span><span class="tok-s">&quot;io.micrometer:micrometer-tracing-bridge-otel&quot;</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-n">implementation</span><span class="tok-p">(</span><span class="tok-s">&quot;io.opentelemetry:opentelemetry-exporter-otlp&quot;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-c1">// traces</span>
<span class="tok-w">    </span><span class="tok-n">implementation</span><span class="tok-p">(</span><span class="tok-s">&quot;io.micrometer:micrometer-registry-otlp:1.12.2&quot;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-c1">// metrics</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">/main/api-gateway/src/main/resources/application-localcompose.yaml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">management</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">tracing</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">sampling</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">probability</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1.0</span>
<span class="tok-w">  </span><span class="tok-nt">otlp</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metrics</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">export</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">url</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">http://otel-collector:4318/v1/metrics</span>
<span class="tok-w">    </span><span class="tok-nt">tracing</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">endpoint</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">http://otel-collector:4318/v1/traces</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Unfortunately, they duplicate the one in microservices. A microservice is not necessary to be a HTTP server, and we need tracing and metrics for all microservices and HTTP servers. We favour SoC over DRY here by not commonizing the dependencies and configurations into the <code>lib:http-server</code> module.</p>
</div>
<div class="paragraph">
<p>In a large-scale project, it may be commonized by creating a <code>lib:microservice-http</code> module.</p>
</div>
</div>
<div class="sect2">
<h3 id="_api_documentation_springdoc">7.3. API Documentation (Springdoc)</h3>
<div class="paragraph">
<p>Implementing a API documentation that covers all the public APIs of all the microservices and excludes internal APIs is tricky. There is no good solution available at this moment. But DRY, let&#8217;s try to generate a Swagger API documentation from existing codes.</p>
</div>
<div class="paragraph">
<p>Firstly, let&#8217;s define all the internal APIs to start with a prefix path <code>/internal/</code>. It is not so elegant, but this makes the life easier. This also prevents public traffic from reaching internal APIs using the previous routing configuration.</p>
</div>
<div class="paragraph">
<p>Secondly, Springdoc has the ability to combine API documentation from multiple OpenAPI documentation. Let&#8217;s include the dependency in every microservice and in API Gateway (remember DRY).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Where should this dependency be placed?
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">/main/lib/http-server/build.gradle.kts</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-w">    </span><span class="tok-n">implementation</span><span class="tok-p">(</span><span class="tok-s">&quot;org.springdoc:springdoc-openapi-starter-webflux-ui:2.2.0&quot;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Configure microservices to exclude paths <code>/internal/**</code> from Springdoc.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Where should this configuration be placed?
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">/main/lib/microservice-common/src/main/resources/application-microservice.yaml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">springdoc</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">paths-to-exclude</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/internal/**</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the trick comes. In API Gateway, we define paths routing to an OpenAPI API endpoint for each microservice. It involves path rewriting.</p>
</div>
<div class="listingblock">
<div class="title">/main/api-gateway/src/main/resources/application-localcompose.yaml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">spring</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">cloud</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">gateway</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">httpclient</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">response-timeout</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">10s</span>
<span class="tok-w">      </span><span class="tok-nt">routes</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-c1"># ...</span>

<span class="tok-w">        </span><span class="tok-c1"># API Doc</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">id</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">profile-service-apidoc</span>
<span class="tok-w">          </span><span class="tok-nt">uri</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">http://profile-service:10001</span>
<span class="tok-w">          </span><span class="tok-nt">predicates</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Path=/apidoc/profile-service</span>
<span class="tok-w">          </span><span class="tok-nt">filters</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">RewritePath=/apidoc/(.*), /v3/api-docs</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">id</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">message-service-apidoc</span>
<span class="tok-w">          </span><span class="tok-nt">uri</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">http://message-service:10002</span>
<span class="tok-w">          </span><span class="tok-nt">predicates</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Path=/apidoc/message-service</span>
<span class="tok-w">          </span><span class="tok-nt">filters</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">RewritePath=/apidoc/(.*), /v3/api-docs</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">id</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">file-service-apidoc</span>
<span class="tok-w">          </span><span class="tok-nt">uri</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">http://file-service:10003</span>
<span class="tok-w">          </span><span class="tok-nt">predicates</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Path=/apidoc/file-service</span>
<span class="tok-w">          </span><span class="tok-nt">filters</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">RewritePath=/apidoc/(.*), /v3/api-docs</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And then, configure Springdoc to read from them:</p>
</div>
<div class="listingblock">
<div class="title">/main/api-gateway/src/main/resources/application-localcompose.yaml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">springdoc</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">api-docs</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">enabled</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">  </span><span class="tok-nt">swagger-ui</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">urls</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">profile-service</span>
<span class="tok-w">        </span><span class="tok-nt">url</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">http://localhost:10000/apidoc/profile-service</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">message-service</span>
<span class="tok-w">        </span><span class="tok-nt">url</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">http://localhost:10000/apidoc/message-service</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">file-service</span>
<span class="tok-w">        </span><span class="tok-nt">url</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">http://localhost:10000/apidoc/file-service</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Visit <a href="http://localhost:10000/webjars/swagger-ui/index.html" class="bare">http://localhost:10000/webjars/swagger-ui/index.html</a>. Now we have a working API documentation that only shows public APIs of all microservices.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Extra routing and path rewriting are needed, because the "combining" and "fetching" steps are performed at client-side.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_schedule_tasks">8. Schedule Tasks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Most applications consist of schedule tasks. But it is not easy to implement, especially in a scalable application. Improper implementation leads to race conditions, which usually result in a economic loss. It is extremely important to implement it correctly.</p>
</div>
<div class="sect2">
<h3 id="_race_condition_example">8.1. Race Condition Example</h3>
<div class="paragraph">
<p>Let&#8217;s see a common use case&#8201;&#8212;&#8201;deduct points and issue a reward to an eligible member. 100 points are required for a member to redeem a reward, and there is a quota of rewards.</p>
</div>
<div class="paragraph">
<p>A naive implementation looks like this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-nd">@Scheduled</span><span class="tok-p">(</span><span class="tok-n">cron</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;*/5 * * * * *&quot;</span><span class="tok-p">)</span>
<span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">deductPointsAndIssueReward</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">userRepository</span><span class="tok-p">.</span><span class="tok-na">findAll</span><span class="tok-p">().</span><span class="tok-na">forEach</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">user</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span>
<span class="tok-w">        </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">user</span><span class="tok-p">.</span><span class="tok-na">isRewarded</span><span class="tok-w"> </span><span class="tok-o">&amp;&amp;</span><span class="tok-w"> </span><span class="tok-n">user</span><span class="tok-p">.</span><span class="tok-na">point</span><span class="tok-w"> </span><span class="tok-o">&gt;=</span><span class="tok-w"> </span><span class="tok-m">100</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">rewardProduct</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">productRepository</span><span class="tok-p">.</span><span class="tok-na">findById</span><span class="tok-p">(</span><span class="tok-n">REWARD_ID</span><span class="tok-p">)</span>
<span class="tok-w">            </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">rewardProduct</span><span class="tok-p">.</span><span class="tok-na">quota</span><span class="tok-w"> </span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-m">0</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                </span><span class="tok-n">user</span><span class="tok-p">.</span><span class="tok-na">point</span><span class="tok-w"> </span><span class="tok-o">-=</span><span class="tok-w"> </span><span class="tok-m">100</span>
<span class="tok-w">                </span><span class="tok-o">--</span><span class="tok-n">rewardProduct</span><span class="tok-p">.</span><span class="tok-na">quota</span>
<span class="tok-w">                </span><span class="tok-n">user</span><span class="tok-p">.</span><span class="tok-na">isRewarded</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-kc">true</span>
<span class="tok-w">                </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">reward</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Reward</span><span class="tok-p">().</span><span class="tok-na">also</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                    </span><span class="tok-nb">it</span><span class="tok-p">.</span><span class="tok-na">userId</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">user</span><span class="tok-p">.</span><span class="tok-na">id</span>
<span class="tok-w">                    </span><span class="tok-nb">it</span><span class="tok-p">.</span><span class="tok-na">productId</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">rewardProduct</span><span class="tok-p">.</span><span class="tok-na">id</span>
<span class="tok-w">                </span><span class="tok-p">}</span>
<span class="tok-w">                </span><span class="tok-n">userRepository</span><span class="tok-p">.</span><span class="tok-na">save</span><span class="tok-p">(</span><span class="tok-n">user</span><span class="tok-p">)</span>
<span class="tok-w">                </span><span class="tok-n">productRepository</span><span class="tok-p">.</span><span class="tok-na">save</span><span class="tok-p">(</span><span class="tok-n">rewardProduct</span><span class="tok-p">)</span>
<span class="tok-w">                </span><span class="tok-n">userWalletRepository</span><span class="tok-p">.</span><span class="tok-na">save</span><span class="tok-p">(</span><span class="tok-n">reward</span><span class="tok-p">)</span>
<span class="tok-w">            </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This implementation has tons of problems. We will focus only one.</p>
</div>
<div class="paragraph">
<p>Assume there are two server instances running the same application, which is very common in Production, they execute this schedule task like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="diag-mermaid-md5-b873f501d52458b700cb1d7f35f3b102.png" alt="Diagram" width="784" height="635">
</div>
</div>
<div class="paragraph">
<p>Can you see the big problem? Before the schedule task, there is only a product with quota 1, and the user has only 100 points. The outcome is that user redeemed 2 products using only 100 points.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Race conditions are not specific to schedule tasks. It exists everywhere in server applications, including RESTful APIs. It also exists in frontend applications.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The most simple fix is to apply a locking mechanism distributed among all the instances, to make sure these logic for a particular record (user in this example) is only concurrently processed once.</p>
</div>
</div>
<div class="sect2">
<h3 id="_execution_context">8.2. Execution Context</h3>
<div class="paragraph">
<p>Regardless of Spring Web or Spring WebFlux, by default all <code>@Scheduled</code> functions are executed by only one and the same thread. That means if two schedule tasks are defined to run at 12:00:00 am, only one of them would execute first, and then the second one after the first one completes. What if the first one never completes, e.g. the database connection is hanged? Since this point of time, no other schedule tasks could run until the server is restarted.</p>
</div>
<div class="paragraph">
<p>Another problem is if the schedule task is time-critical, the Spring scheduler does not guarantee the task is executed right exactly at 12:00:00 am.</p>
</div>
<div class="paragraph">
<p>It is possible to configure the execution thread pool to be more than 1. It would help a bit, but it does not solve the issue that schedule tasks are blocked by hanged connections.</p>
</div>
<div class="paragraph">
<p>The suggested solution is:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Configure a thread pool with an upper limit (so that memory usage is bounded).</p>
</li>
<li>
<p>Launch a thread / coroutine in every iteration of schedule task executions.</p>
</li>
<li>
<p>Set a timeout to the coroutine. (It is not quite possible with Threads)</p>
</li>
<li>
<p>Cover schedule task execution status in health check, so that servers in stuck could be restarted automatically by the cluster.</p>
</li>
<li>
<p>Schedule task execution status should be included in metrics reporting.</p>
</li>
<li>
<p>Prioritize schedule tasks execution by creating dedicated thread pools of different size.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_distributed_locks">8.3. Distributed Locks</h3>
<div class="paragraph">
<p>There are different types of locks to remedy race conditions. They are suitable to different situations.</p>
</div>
<div class="sect3">
<h4 id="_task_level_lock">8.3.1. Task-level Lock</h4>
<div class="paragraph">
<p>This is for allowing only one concurrent instance to execute a particular task.</p>
</div>
<div class="paragraph">
<p>To implement this, the simpliest way is to put the lock in a database or cache server. Using a library, e.g. <a href="https://github.com/lukas-krecan/ShedLock">ShedLock</a>, is about adding an annotation.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The parameters of the annotation, e.g. timeout, require careful considerations. Improper configuration would make the lock useless and perhaps worse than not using a lock.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>However, it has a big disadvantage. Quoting from ShedLock:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>if one task is already being executed on one node, execution on other nodes does not wait, it is simply skipped.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>That means we cannot speed up the execution of schedule tasks by scaling out more number of server instances.</p>
</div>
</div>
<div class="sect3">
<h4 id="_record_level_lock">8.3.2. Record-level Lock</h4>
<div class="paragraph">
<p>Lock a record only during execution of this record. This ensures only one concurrent instance to process a particular record, while allowing scaling out to process more number of records at the same time.</p>
</div>
<div class="paragraph">
<p>Again, configurations e.g. timeout require careful consideration.</p>
</div>
<div class="paragraph">
<p>The implementation is tricky, so we have a <a href="#_record_level_schedule_task_implementation">dedicated section</a> for this.</p>
</div>
</div>
<div class="sect3">
<h4 id="_no_lock">8.3.3. No Lock</h4>
<div class="paragraph">
<p>If <em>all</em> operations inside the schedule tasks are process-safe, i.e. designed to handle properly under concurrent executions by multiple instances, including error handling, then no extra lock should be applied.</p>
</div>
<details>
<summary class="title">Example of process-safe schedule task without lock</summary>
<div class="content">
<div class="listingblock">
<div class="title">/main/file-service/src/main/kotlin/com/gtomato/server/application/messenger/fileservice/scheduletask/RemoveExpiredUploadsScheduleTask.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">context</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">newFixedThreadPoolContext</span><span class="tok-p">(</span><span class="tok-m">2</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;RemoveExpiredUploadsContext&quot;</span><span class="tok-p">)</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-nd">@Scheduled</span><span class="tok-p">(</span><span class="tok-n">fixedDelay</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-m">60</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-m">1000L</span><span class="tok-p">)</span>
<span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">run</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">log</span><span class="tok-p">.</span><span class="tok-na">info</span><span class="tok-p">(</span><span class="tok-s">&quot;RemoveExpiredUploadsScheduleTask start&quot;</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-n">context</span><span class="tok-p">.</span><span class="tok-na">executor</span><span class="tok-p">.</span><span class="tok-na">execute</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">        </span><span class="tok-n">runBlocking</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">attachmentService</span><span class="tok-p">.</span><span class="tok-na">removeExpiredUploads</span><span class="tok-p">()</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-n">log</span><span class="tok-p">.</span><span class="tok-na">info</span><span class="tok-p">(</span><span class="tok-s">&quot;RemoveExpiredUploadsScheduleTask end&quot;</span><span class="tok-p">)</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Per discussed <a href="#_execution_context">previously</a>, execution should be asynchronous and limited by a thread pool.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">/main/file-service/src/main/kotlin/com/gtomato/server/application/messenger/fileservice/service/AttachmentService.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-kd">suspend</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">removeExpiredUploads</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">log</span><span class="tok-p">.</span><span class="tok-na">debug</span><span class="tok-p">(</span><span class="tok-s">&quot;removeExpiredUploads()&quot;</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">resp</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">s3AsyncClient</span><span class="tok-p">.</span><span class="tok-na">listObjects</span><span class="tok-p">(</span><span class="tok-n">ListObjectsRequest</span><span class="tok-p">.</span><span class="tok-na">builder</span><span class="tok-p">().</span><span class="tok-na">bucket</span><span class="tok-p">(</span><span class="tok-n">S3Buckets</span><span class="tok-p">.</span><span class="tok-na">Uploads</span><span class="tok-p">).</span><span class="tok-na">build</span><span class="tok-p">()).</span><span class="tok-na">await</span><span class="tok-p">()</span><span class="tok-w"> </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">    </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">objects</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">resp</span><span class="tok-p">.</span><span class="tok-na">contents</span><span class="tok-p">()</span>
<span class="tok-w">    </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">now</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Instant</span><span class="tok-p">.</span><span class="tok-na">now</span><span class="tok-p">()</span>
<span class="tok-w">    </span><span class="tok-n">coroutineScope</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">log</span><span class="tok-p">.</span><span class="tok-na">debug</span><span class="tok-p">(</span><span class="tok-s">&quot;removeExpiredUploads scope </span><span class="tok-si">${</span><span class="tok-n">objects</span><span class="tok-p">.</span><span class="tok-na">size</span><span class="tok-si">}</span><span class="tok-s">&quot;</span><span class="tok-p">)</span>
<span class="tok-w">        </span><span class="tok-n">objects</span><span class="tok-p">.</span><span class="tok-na">filter</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-nb">it</span><span class="tok-p">.</span><span class="tok-na">lastModified</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">UPLOAD_EXPIRY_DURATION</span><span class="tok-p">).</span><span class="tok-na">isBefore</span><span class="tok-p">(</span><span class="tok-n">now</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">}</span>
<span class="tok-w">            </span><span class="tok-p">.</span><span class="tok-na">shuffled</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-c1">// randomize the list to allow concurrent deletes by different instances </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">            </span><span class="tok-p">.</span><span class="tok-na">forEach</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                </span><span class="tok-n">launch</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                    </span><span class="tok-k">try</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                        </span><span class="tok-n">log</span><span class="tok-p">.</span><span class="tok-na">info</span><span class="tok-p">(</span><span class="tok-s">&quot;Remove expired object </span><span class="tok-si">${</span><span class="tok-nb">it</span><span class="tok-p">.</span><span class="tok-na">key</span><span class="tok-p">()</span><span class="tok-si">}</span><span class="tok-s">&quot;</span><span class="tok-p">)</span>
<span class="tok-w">                        </span><span class="tok-n">s3AsyncClient</span><span class="tok-p">.</span><span class="tok-na">deleteObject</span><span class="tok-p">(</span><span class="tok-w"> </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">                            </span><span class="tok-n">DeleteObjectRequest</span><span class="tok-p">.</span><span class="tok-na">builder</span><span class="tok-p">()</span>
<span class="tok-w">                                </span><span class="tok-p">.</span><span class="tok-na">bucket</span><span class="tok-p">(</span><span class="tok-n">S3Buckets</span><span class="tok-p">.</span><span class="tok-na">Uploads</span><span class="tok-p">)</span>
<span class="tok-w">                                </span><span class="tok-p">.</span><span class="tok-na">key</span><span class="tok-p">(</span><span class="tok-nb">it</span><span class="tok-p">.</span><span class="tok-na">key</span><span class="tok-p">())</span>
<span class="tok-w">                                </span><span class="tok-p">.</span><span class="tok-na">build</span><span class="tok-p">()</span>
<span class="tok-w">                        </span><span class="tok-p">).</span><span class="tok-na">await</span><span class="tok-p">()</span>
<span class="tok-w">                    </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">catch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">e</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">S3Exception</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">                        </span><span class="tok-c1">// ignore. it is expected to have exceptions while deleting concurrently</span>
<span class="tok-w">                    </span><span class="tok-p">}</span>
<span class="tok-w">                </span><span class="tok-p">}</span>
<span class="tok-w">            </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Randomize processing order to reduce race conditions and increase efficiency.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>For concurrent accessing to the same file, MinIO / S3 takes care of that, not our business.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Ignore deletion error does no harm. If it is due to race conditions, the error should be ignored; for other reasons, it would be retried in the next iteration of the schedule task.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Adding up all these designs make this schedule task scalable without requiring locking.</p>
</div>
</div>
</details>
</div>
</div>
<div class="sect2">
<h3 id="_retries">8.4. Retries</h3>
<div class="paragraph">
<p>It is common that a schedule task could fail, requiring retries, and also common that retry would fail because they have already been expired. If we always retry starting from the oldest records, since processing time is limited, we may end up <em>only</em> retrying the always-fail tasks. This make our schedule tasks in stuck.</p>
</div>
<div class="paragraph">
<p>We should introduce an algorithm not to always retry the same set of tasks. Retrying recent tasks may be more necessary and frequently than old tasks.</p>
</div>
<div class="paragraph">
<p>A common approach is <a href="https://en.wikipedia.org/wiki/Exponential_backoff">exponential backoff</a>. Giving retry penalty to failed tasks, and the penalty time increases exponentially with number of fails. Quoting from Wikipedia:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>For example, if a smartphone app fails to connect to its server, it might try again 1 second later, then if it fails again, 2 seconds later, then 4, etc.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>In additional to it, we may also impose a maximum bound of retry penalty and number of retries. Retrying after a year is not making senses. If the task is retried for many times, e.g. 1000 times, we should give up it.</p>
</div>
</div>
<div class="sect2">
<h3 id="_record_level_schedule_task_implementation">8.5. Record-level Schedule Task Implementation</h3>
<div class="paragraph">
<p>Only record-level locks are complicated, so only this would be specifically explained.</p>
</div>
<div class="paragraph">
<p>Firstly, we have base classes implementation. This class should take consideration of all the above points. They are in the <code>lib:db-common</code> module, because the implementation is specific to databases.</p>
</div>
<div class="listingblock">
<div class="title">/main/lib/db-common/src/main/kotlin/com/gtomato/server/application/messenger/common/entity/ScheduleJobRecordCommon.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-kd">interface</span><span class="tok-w"> </span><span class="tok-nc">ScheduleJobRecordCommon</span><span class="tok-w"> </span><span class="tok-p">{</span>

<span class="tok-w">    </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">id</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">String</span>

<span class="tok-w">    </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">lockedUntil</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">Instant</span>

<span class="tok-w">    </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">lockedAt</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">Instant?</span>

<span class="tok-w">    </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">lockId</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">String</span>

<span class="tok-w">    </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">lockedBy</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">String?</span>

<span class="tok-w">    </span><span class="tok-cm">/**</span>
<span class="tok-cm">     * 1-based</span>
<span class="tok-cm">     */</span>
<span class="tok-w">    </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">attempts</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">Int</span>

<span class="tok-w">    </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">version</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">Int?</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">/main/lib/db-common/src/main/kotlin/com/gtomato/server/application/messenger/common/scheduletask/BaseScheduleTask.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span>
<span class="tok-kd">abstract</span><span class="tok-w"> </span><span class="tok-kd">class</span><span class="tok-w"> </span><span class="tok-nc">BaseScheduleTask</span><span class="tok-o">&lt;</span><span class="tok-n">T</span><span class="tok-w"> </span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">ScheduleJobRecordCommon</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">protected</span><span class="tok-w"> </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">log</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">LogFactory</span><span class="tok-p">.</span><span class="tok-na">getLog</span><span class="tok-p">(</span><span class="tok-n">javaClass</span><span class="tok-p">)</span>

<span class="tok-w">    </span><span class="tok-nd">@Autowired</span>
<span class="tok-w">    </span><span class="tok-nd">@Qualifier</span><span class="tok-p">(</span><span class="tok-s">&quot;DefaultScheduleTaskProperties&quot;</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-kd">protected</span><span class="tok-w"> </span><span class="tok-kd">open</span><span class="tok-w"> </span><span class="tok-kd">lateinit</span><span class="tok-w"> </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">scheduleTaskProperties</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">ScheduleTaskProperties</span>

<span class="tok-w">    </span><span class="tok-nd">@Autowired</span>
<span class="tok-w">    </span><span class="tok-kd">protected</span><span class="tok-w"> </span><span class="tok-kd">lateinit</span><span class="tok-w"> </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">tracer</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">Tracer</span>

<span class="tok-w">    </span><span class="tok-kd">protected</span><span class="tok-w"> </span><span class="tok-kd">lateinit</span><span class="tok-w"> </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">instanceName</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">String</span>
<span class="tok-w">        </span><span class="tok-n">private</span><span class="tok-w"> </span><span class="tok-k">set</span>

<span class="tok-w">    </span><span class="tok-kd">open</span><span class="tok-w"> </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">scheduleJobName</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">String</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">this</span><span class="tok-o">::</span><span class="tok-n">class</span><span class="tok-p">.</span><span class="tok-na">java</span><span class="tok-p">.</span><span class="tok-na">simpleName</span>

<span class="tok-w">    </span><span class="tok-kd">abstract</span><span class="tok-w"> </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">repository</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">BaseCommonRepository</span><span class="tok-o">&lt;</span><span class="tok-n">T</span><span class="tok-o">&gt;</span>

<span class="tok-w">    </span><span class="tok-kd">protected</span><span class="tok-w"> </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">lock</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Mutex</span><span class="tok-p">()</span>
<span class="tok-w">    </span><span class="tok-kd">protected</span><span class="tok-w"> </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">currentCoroutineScope</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">CoroutineScope</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">CoroutineScope</span><span class="tok-p">(</span><span class="tok-n">Dispatchers</span><span class="tok-p">.</span><span class="tok-na">IO</span><span class="tok-p">)</span>

<span class="tok-w">    </span><span class="tok-nd">@PostConstruct</span>
<span class="tok-w">    </span><span class="tok-kd">protected</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">init</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">instanceName</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">scheduleTaskProperties</span><span class="tok-p">.</span><span class="tok-na">instanceName</span>
<span class="tok-w">            </span><span class="tok-o">?:</span><span class="tok-w"> </span><span class="tok-n">InetAddress</span><span class="tok-p">.</span><span class="tok-na">getLocalHost</span><span class="tok-p">().</span><span class="tok-na">hostName</span><span class="tok-p">.</span><span class="tok-na">also</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-s">&quot;localhost&quot;</span><span class="tok-p">.</span><span class="tok-na">equals</span><span class="tok-p">(</span><span class="tok-nb">it</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">ignoreCase</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-kc">true</span><span class="tok-p">))</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                    </span><span class="tok-k">throw</span><span class="tok-w"> </span><span class="tok-n">RuntimeException</span><span class="tok-p">(</span><span class="tok-s">&quot;Cannot get host name as instance name&quot;</span><span class="tok-p">)</span>
<span class="tok-w">                </span><span class="tok-p">}</span>
<span class="tok-w">            </span><span class="tok-p">}</span>

<span class="tok-w">        </span><span class="tok-n">log</span><span class="tok-p">.</span><span class="tok-na">info</span><span class="tok-p">(</span><span class="tok-s">&quot;Job </span><span class="tok-si">$</span><span class="tok-n">scheduleJobName</span><span class="tok-s"> in </span><span class="tok-si">$</span><span class="tok-n">instanceName</span><span class="tok-s"> has been initialized&quot;</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-kd">protected</span><span class="tok-w"> </span><span class="tok-kd">abstract</span><span class="tok-w"> </span><span class="tok-kd">suspend</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">selectPendingJobs</span><span class="tok-p">():</span><span class="tok-w"> </span><span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">T</span><span class="tok-o">&gt;</span>

<span class="tok-w">    </span><span class="tok-cm">/**</span>
<span class="tok-cm">     * Within this method, it is guaranteed only one thread is executing it, unless execution timeouts</span>
<span class="tok-cm">     */</span>
<span class="tok-w">    </span><span class="tok-kd">protected</span><span class="tok-w"> </span><span class="tok-kd">abstract</span><span class="tok-w"> </span><span class="tok-kd">suspend</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">processOne</span><span class="tok-p">(</span><span class="tok-n">job</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">T</span><span class="tok-p">)</span>

<span class="tok-w">    </span><span class="tok-kd">protected</span><span class="tok-w"> </span><span class="tok-kd">open</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">getPenaltyDelayForAttempt</span><span class="tok-p">(</span><span class="tok-n">numOfAttempts</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">Int</span><span class="tok-p">):</span><span class="tok-w"> </span><span class="tok-n">Duration</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-cm">/**</span>
<span class="tok-cm">         * Attempt	Penalty (seconds)	Accumulated Delay (s)</span>
<span class="tok-cm">         * 1	10	10</span>
<span class="tok-cm">         * 2	20	30</span>
<span class="tok-cm">         * 3	40	70</span>
<span class="tok-cm">         * 4	80	150</span>
<span class="tok-cm">         * 5	160	310</span>
<span class="tok-cm">         * 6	320	630</span>
<span class="tok-cm">         * 7	640	1270</span>
<span class="tok-cm">         * 8	1280	2550</span>
<span class="tok-cm">         * 9	1800	4350</span>
<span class="tok-cm">         * 10	1800	6150</span>
<span class="tok-cm">         */</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">minOf</span><span class="tok-p">(</span>
<span class="tok-w">            </span><span class="tok-n">scheduleTaskProperties</span><span class="tok-p">.</span><span class="tok-na">maxPenaltyDelay</span><span class="tok-p">,</span>
<span class="tok-w">            </span><span class="tok-n">Duration</span><span class="tok-p">.</span><span class="tok-na">ofMillis</span><span class="tok-p">((</span><span class="tok-m">2.0</span><span class="tok-p">.</span><span class="tok-na">pow</span><span class="tok-p">(</span><span class="tok-n">numOfAttempts</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-m">5</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-m">1000</span><span class="tok-p">).</span><span class="tok-na">toLong</span><span class="tok-p">())</span>
<span class="tok-w">        </span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-cm">/**</span>
<span class="tok-cm">     * Do not block execute(), because there is only one execution thread in Spring</span>
<span class="tok-cm">     */</span>
<span class="tok-w">    </span><span class="tok-kd">open</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">execute</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">with</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">currentCoroutineScope</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">launch</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                </span><span class="tok-n">withTimeout</span><span class="tok-p">(</span><span class="tok-n">scheduleTaskProperties</span><span class="tok-p">.</span><span class="tok-na">maxExecutionDuration</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                    </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">jobs</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">try</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                        </span><span class="tok-n">selectPendingJobs</span><span class="tok-p">()</span>
<span class="tok-w">                    </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">catch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">e</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">Throwable</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                        </span><span class="tok-n">log</span><span class="tok-p">.</span><span class="tok-na">warn</span><span class="tok-p">(</span><span class="tok-s">&quot;Cannot fetch jobs&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">e</span><span class="tok-p">)</span>
<span class="tok-w">                        </span><span class="tok-n">emptyList</span><span class="tok-p">()</span>
<span class="tok-w">                    </span><span class="tok-p">}</span>

<span class="tok-w">                    </span><span class="tok-n">jobs</span><span class="tok-p">.</span><span class="tok-na">forEach</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">job</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span>
<span class="tok-w">                        </span><span class="tok-n">launch</span><span class="tok-w"> </span><span class="tok-nd">job@</span><span class="tok-p">{</span>
<span class="tok-w">                            </span><span class="tok-k">try</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                                </span><span class="tok-n">takeOne</span><span class="tok-p">(</span><span class="tok-n">job</span><span class="tok-p">).</span><span class="tok-na">also</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">isAccquired</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span>
<span class="tok-w">                                    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">isAccquired</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-nd">@job</span>
<span class="tok-w">                                </span><span class="tok-p">}</span>
<span class="tok-w">                                </span><span class="tok-k">try</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                                    </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">job</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">repository</span><span class="tok-p">.</span><span class="tok-na">findById</span><span class="tok-p">(</span><span class="tok-n">job</span><span class="tok-p">.</span><span class="tok-na">id</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">?:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-nd">@job</span>
<span class="tok-w">                                    </span><span class="tok-n">processOne</span><span class="tok-p">(</span><span class="tok-n">job</span><span class="tok-p">)</span>

<span class="tok-w">                                    </span><span class="tok-c1">// at this point, the job has completed successfully</span>
<span class="tok-w">                                    </span><span class="tok-c1">// release the job</span>
<span class="tok-w">                                    </span><span class="tok-c1">// the job might be updated during processOne(job), so re-fetch</span>
<span class="tok-w">                                    </span><span class="tok-n">job</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">repository</span><span class="tok-p">.</span><span class="tok-na">findById</span><span class="tok-p">(</span><span class="tok-n">job</span><span class="tok-p">.</span><span class="tok-na">id</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">?:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-nd">@job</span>
<span class="tok-w">                                    </span><span class="tok-n">release</span><span class="tok-p">(</span><span class="tok-n">job</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">isPenalize</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-kc">false</span><span class="tok-p">)</span>
<span class="tok-w">                                </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">catch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">e</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">Throwable</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                                    </span><span class="tok-n">log</span><span class="tok-p">.</span><span class="tok-na">debug</span><span class="tok-p">(</span>
<span class="tok-w">                                        </span><span class="tok-s">&quot;Received error while processing job </span><span class="tok-si">${</span><span class="tok-n">job</span><span class="tok-p">.</span><span class="tok-na">id</span><span class="tok-si">}</span><span class="tok-s">: </span><span class="tok-si">${</span><span class="tok-n">e</span><span class="tok-o">::</span><span class="tok-n">javaClass</span><span class="tok-p">.</span><span class="tok-na">name</span><span class="tok-si">}</span><span class="tok-s"> -- </span><span class="tok-si">${</span><span class="tok-n">e</span><span class="tok-p">.</span><span class="tok-na">message</span><span class="tok-si">}</span><span class="tok-s">&quot;</span><span class="tok-p">,</span>
<span class="tok-w">                                        </span><span class="tok-n">e</span>
<span class="tok-w">                                    </span><span class="tok-p">)</span>
<span class="tok-w">                                    </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">job</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">repository</span><span class="tok-p">.</span><span class="tok-na">findById</span><span class="tok-p">(</span><span class="tok-n">job</span><span class="tok-p">.</span><span class="tok-na">id</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">?:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-nd">@job</span>
<span class="tok-w">                                    </span><span class="tok-n">release</span><span class="tok-p">(</span><span class="tok-n">job</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">isPenalize</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-kc">true</span><span class="tok-p">)</span>
<span class="tok-w">                                </span><span class="tok-p">}</span>
<span class="tok-w">                            </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">catch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">e</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">Throwable</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                                </span><span class="tok-n">log</span><span class="tok-p">.</span><span class="tok-na">warn</span><span class="tok-p">(</span><span class="tok-s">&quot;Cannot process job properly&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">e</span><span class="tok-p">)</span>
<span class="tok-w">                            </span><span class="tok-p">}</span>
<span class="tok-w">                        </span><span class="tok-p">}</span>
<span class="tok-w">                    </span><span class="tok-p">}</span>
<span class="tok-w">                </span><span class="tok-p">}</span>
<span class="tok-w">            </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-cm">/**</span>
<span class="tok-cm">     * Lock this record.</span>
<span class="tok-cm">     */</span>
<span class="tok-w">    </span><span class="tok-kd">suspend</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">takeOne</span><span class="tok-p">(</span><span class="tok-n">job</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">T</span><span class="tok-p">):</span><span class="tok-w"> </span><span class="tok-kt">Boolean</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">now</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Instant</span><span class="tok-p">.</span><span class="tok-na">now</span><span class="tok-p">()</span>
<span class="tok-w">        </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span>
<span class="tok-w">            </span><span class="tok-n">job</span><span class="tok-p">.</span><span class="tok-na">attempts</span><span class="tok-w"> </span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">scheduleTaskProperties</span><span class="tok-p">.</span><span class="tok-na">maxRetryTimes</span>
<span class="tok-w">            </span><span class="tok-o">||</span><span class="tok-w"> </span><span class="tok-n">job</span><span class="tok-p">.</span><span class="tok-na">lockedUntil</span><span class="tok-w"> </span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">now</span>
<span class="tok-w">        </span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-kc">false</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">lockId</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">UUID</span><span class="tok-p">.</span><span class="tok-na">randomUUID</span><span class="tok-p">().</span><span class="tok-na">toString</span><span class="tok-p">()</span>
<span class="tok-w">        </span><span class="tok-n">job</span><span class="tok-p">.</span><span class="tok-na">lockedUntil</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">now</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">maxOf</span><span class="tok-p">(</span>
<span class="tok-w">            </span><span class="tok-n">scheduleTaskProperties</span><span class="tok-p">.</span><span class="tok-na">maxExecutionDuration</span><span class="tok-p">,</span>
<span class="tok-w">            </span><span class="tok-n">getPenaltyDelayForAttempt</span><span class="tok-p">(</span><span class="tok-n">job</span><span class="tok-p">.</span><span class="tok-na">attempts</span><span class="tok-p">)</span>
<span class="tok-w">        </span><span class="tok-p">)</span>
<span class="tok-w">        </span><span class="tok-n">job</span><span class="tok-p">.</span><span class="tok-na">lockedAt</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">now</span>
<span class="tok-w">        </span><span class="tok-n">job</span><span class="tok-p">.</span><span class="tok-na">lockedBy</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">instanceName</span>
<span class="tok-w">        </span><span class="tok-n">job</span><span class="tok-p">.</span><span class="tok-na">lockId</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">lockId</span>
<span class="tok-w">        </span><span class="tok-o">++</span><span class="tok-n">job</span><span class="tok-p">.</span><span class="tok-na">attempts</span>
<span class="tok-w">        </span><span class="tok-k">try</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">repository</span><span class="tok-p">.</span><span class="tok-na">save</span><span class="tok-p">(</span><span class="tok-n">job</span><span class="tok-p">)</span>
<span class="tok-w">        </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">catch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">_</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">OptimisticLockingFailureException</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-kc">false</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-kc">true</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-cm">/**</span>
<span class="tok-cm">     * Unlock this record, optionally also adding retry time penalty.</span>
<span class="tok-cm">     */</span>
<span class="tok-w">    </span><span class="tok-kd">suspend</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">release</span><span class="tok-p">(</span><span class="tok-n">job</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">T</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">isPenalize</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">Boolean</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-kc">false</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">now</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Instant</span><span class="tok-p">.</span><span class="tok-na">now</span><span class="tok-p">()</span>
<span class="tok-w">        </span><span class="tok-n">job</span><span class="tok-p">.</span><span class="tok-na">lockedUntil</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">isPenalize</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">now</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">getPenaltyDelayForAttempt</span><span class="tok-p">(</span><span class="tok-n">job</span><span class="tok-p">.</span><span class="tok-na">attempts</span><span class="tok-p">)</span>
<span class="tok-w">        </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">now</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-n">job</span><span class="tok-p">.</span><span class="tok-na">lockedBy</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-kc">null</span>
<span class="tok-w">        </span><span class="tok-n">log</span><span class="tok-p">.</span><span class="tok-na">debug</span><span class="tok-p">(</span><span class="tok-s">&quot;Release job #</span><span class="tok-si">${</span><span class="tok-n">job</span><span class="tok-p">.</span><span class="tok-na">id</span><span class="tok-si">}</span><span class="tok-s"> for attempt #</span><span class="tok-si">${</span><span class="tok-n">job</span><span class="tok-p">.</span><span class="tok-na">attempts</span><span class="tok-si">}${</span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">isPenalize</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-w"> </span><span class="tok-n">with</span><span class="tok-w"> </span><span class="tok-n">penalty</span><span class="tok-s">&quot;</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-s">&quot;&quot;</span><span class="tok-si">}</span><span class="tok-s">&quot;</span><span class="tok-p">)</span>
<span class="tok-w">        </span><span class="tok-n">repository</span><span class="tok-p">.</span><span class="tok-na">save</span><span class="tok-p">(</span><span class="tok-n">job</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To implement a record-level schedule task, it looks like this:</p>
</div>
<div class="listingblock">
<div class="title">/main/lib/db-mysql/src/test/kotlin/com/gtomato/server/application/messenger/test/common/scheduletask/scheduletask/TestScheduleTask.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-nd">@Component</span>
<span class="tok-kd">class</span><span class="tok-w"> </span><span class="tok-nc">TestScheduleTask</span><span class="tok-w"> </span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">BaseScheduleTask</span><span class="tok-o">&lt;</span><span class="tok-n">TestScheduleJobRecord</span><span class="tok-o">&gt;</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nd">@Autowired</span>
<span class="tok-w">    </span><span class="tok-kd">lateinit</span><span class="tok-w"> </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">testScheduleJobRecordRepository</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">TestScheduleJobRecordRepository</span>

<span class="tok-w">    </span><span class="tok-nd">@Autowired</span>
<span class="tok-w">    </span><span class="tok-kd">lateinit</span><span class="tok-w"> </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">testScheduleJobExecuteLogRepository</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">TestScheduleJobExecuteLogRepository</span>

<span class="tok-w">    </span><span class="tok-kd">override</span><span class="tok-w"> </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">repository</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">BaseCommonRepository</span><span class="tok-o">&lt;</span><span class="tok-n">TestScheduleJobRecord</span><span class="tok-o">&gt;</span>
<span class="tok-w">        </span><span class="tok-k">get</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">testScheduleJobRecordRepository</span>

<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">scheduleTaskProperties_</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">ScheduleTaskProperties? </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-kc">null</span>
<span class="tok-w">    </span><span class="tok-kd">override</span><span class="tok-w"> </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">scheduleTaskProperties</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">ScheduleTaskProperties</span>
<span class="tok-w">        </span><span class="tok-k">get</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">scheduleTaskProperties_</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-kc">null</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                </span><span class="tok-n">scheduleTaskProperties_</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">super</span><span class="tok-p">.</span><span class="tok-na">scheduleTaskProperties</span><span class="tok-p">.</span><span class="tok-na">copy</span><span class="tok-p">(</span><span class="tok-n">maxSelectBatchSize</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-m">1000</span><span class="tok-p">)</span>
<span class="tok-w">            </span><span class="tok-p">}</span>
<span class="tok-w">            </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">scheduleTaskProperties_</span><span class="tok-o">!!</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-k">set</span><span class="tok-p">(</span><span class="tok-n">value</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{}</span>

<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">random</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Random</span><span class="tok-p">()</span>

<span class="tok-w">    </span><span class="tok-nd">@Scheduled</span><span class="tok-p">(</span><span class="tok-n">fixedDelay</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-m">1000</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-kd">override</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">execute</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">super</span><span class="tok-p">.</span><span class="tok-na">execute</span><span class="tok-p">()</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-kd">override</span><span class="tok-w"> </span><span class="tok-kd">suspend</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">selectPendingJobs</span><span class="tok-p">():</span><span class="tok-w"> </span><span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">TestScheduleJobRecord</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">testScheduleJobRecordRepository</span><span class="tok-p">.</span><span class="tok-na">findPendingJobs</span><span class="tok-p">(</span>
<span class="tok-w">            </span><span class="tok-n">now</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Instant</span><span class="tok-p">.</span><span class="tok-na">now</span><span class="tok-p">(),</span>
<span class="tok-w">            </span><span class="tok-n">maxRetryTimes</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">scheduleTaskProperties</span><span class="tok-p">.</span><span class="tok-na">maxRetryTimes</span><span class="tok-p">,</span>
<span class="tok-w">            </span><span class="tok-n">isHandled</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-kc">false</span><span class="tok-p">,</span>
<span class="tok-w">            </span><span class="tok-n">pageable</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Pageable</span><span class="tok-p">.</span><span class="tok-na">ofSize</span><span class="tok-p">(</span><span class="tok-n">scheduleTaskProperties</span><span class="tok-p">.</span><span class="tok-na">maxSelectBatchSize</span><span class="tok-p">),</span>
<span class="tok-w">        </span><span class="tok-p">).</span><span class="tok-na">toList</span><span class="tok-p">()</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-kd">override</span><span class="tok-w"> </span><span class="tok-kd">suspend</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">processOne</span><span class="tok-p">(</span><span class="tok-n">job</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">TestScheduleJobRecord</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-c1">// do something</span>
<span class="tok-w">        </span><span class="tok-n">delay</span><span class="tok-p">(</span><span class="tok-m">500</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">random</span><span class="tok-p">.</span><span class="tok-na">nextLong</span><span class="tok-p">(</span><span class="tok-m">4500</span><span class="tok-p">))</span><span class="tok-w"> </span><span class="tok-c1">// 0.5s ~ 5s</span>
<span class="tok-w">        </span><span class="tok-n">testScheduleJobExecuteLogRepository</span><span class="tok-p">.</span><span class="tok-na">save</span><span class="tok-p">(</span><span class="tok-n">TestScheduleJobExecuteLog</span><span class="tok-p">().</span><span class="tok-na">also</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-nb">it</span><span class="tok-p">.</span><span class="tok-na">batchId</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">job</span><span class="tok-p">.</span><span class="tok-na">batchId</span>
<span class="tok-w">            </span><span class="tok-nb">it</span><span class="tok-p">.</span><span class="tok-na">recordId</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">job</span><span class="tok-p">.</span><span class="tok-na">id</span>
<span class="tok-w">        </span><span class="tok-p">})</span>

<span class="tok-w">        </span><span class="tok-c1">// VERY IMPORTANT: mark the job has been done</span>
<span class="tok-w">        </span><span class="tok-n">job</span><span class="tok-p">.</span><span class="tok-na">isHandled</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-kc">true</span>
<span class="tok-w">        </span><span class="tok-n">repository</span><span class="tok-p">.</span><span class="tok-na">save</span><span class="tok-p">(</span><span class="tok-n">job</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementation should be <a href="#schedule-task-test">battle-tested</a>, due to the great importance of schedule task correctness.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_automatic_testing">9. Automatic Testing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are many benefits of implementing automatic tests:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Safer&#8201;&#8212;&#8201;if test coverage is high</p>
</li>
<li>
<p>Saving effort&#8201;&#8212;&#8201;no repetitive manual testing. This is not significant in small projects, but very significant in large projects</p>
</li>
<li>
<p><strong>Be brave to change something or some big thing without fearing it would break the application</strong>&#8201;&#8212;&#8201;automatic tests tell you if it breaks or not</p>
</li>
<li>
<p>Able to find out contradicting requirements</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Implementing automatic tests in server-side application is relatively easier than in frontend. There are different types of testing. I will recommend some.</p>
</div>
<div class="sect2">
<h3 id="_unit_test">9.1. Unit Test</h3>
<div class="paragraph">
<p>To test whether a function works correctly. A test case can be as small as a utility, or a business requirement, but should not larger than an API. It should fully test happy cases, edge cases and error cases.</p>
</div>
<div class="paragraph">
<p>Sometimes, you want to avoid testing other unnecessary functions or making calls to third party. In this case, you need to <a href="https://javadoc.io/doc/org.mockito/mockito-core/latest/org/mockito/Mockito.html#mock-java.lang.Class-">mock</a> those calls. Mocking should be avoided if possible. It often creates testing bugs and hides real application bugs.</p>
</div>
<div class="paragraph">
<p>Unit tests look like this.</p>
</div>
<div class="listingblock">
<div class="title">/main/message-service/src/test/kotlin/com/gtomato/server/application/messenger/messageservice/KeywordQueryParserTest.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-kd">class</span><span class="tok-w"> </span><span class="tok-nc">KeywordQueryParserTest</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">parse</span><span class="tok-p">(</span><span class="tok-n">query</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">String</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">KeywordQueryParser</span><span class="tok-p">(</span><span class="tok-n">query</span><span class="tok-p">).</span><span class="tok-na">parse</span><span class="tok-p">()</span>
<span class="tok-w">        </span><span class="tok-p">.</span><span class="tok-na">dropLast</span><span class="tok-p">(</span><span class="tok-m">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-c1">// drop the EOF Token</span>

<span class="tok-w">    </span><span class="tok-nd">@Test</span>
<span class="tok-w">    </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">someWords</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">result</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">parse</span><span class="tok-p">(</span><span class="tok-s">&quot;a few words&quot;</span><span class="tok-p">)</span>
<span class="tok-w">        </span><span class="tok-n">assertEquals</span><span class="tok-p">(</span><span class="tok-m">3</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">result</span><span class="tok-p">.</span><span class="tok-na">size</span><span class="tok-p">)</span>
<span class="tok-w">        </span><span class="tok-n">result</span><span class="tok-p">.</span><span class="tok-na">forEach</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">assertTrue</span><span class="tok-p">(</span><span class="tok-nb">it</span><span class="tok-w"> </span><span class="tok-k">is</span><span class="tok-w"> </span><span class="tok-n">KeywordToken</span><span class="tok-p">)</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-n">assertEquals</span><span class="tok-p">(</span><span class="tok-n">listOf</span><span class="tok-p">(</span><span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;few&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;words&quot;</span><span class="tok-p">),</span><span class="tok-w"> </span><span class="tok-n">result</span><span class="tok-p">.</span><span class="tok-na">map</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-nb">it</span><span class="tok-w"> </span><span class="tok-k">as</span><span class="tok-w"> </span><span class="tok-n">KeywordToken</span><span class="tok-p">).</span><span class="tok-na">keyword</span><span class="tok-w"> </span><span class="tok-p">})</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-nd">@Test</span>
<span class="tok-w">    </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">someWordsWithSymbols</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">result</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">parse</span><span class="tok-p">(</span><span class="tok-s">&quot;a  +few*@#% key-words ()*&amp;^_-&quot;</span><span class="tok-p">)</span>
<span class="tok-w">        </span><span class="tok-n">println</span><span class="tok-p">(</span><span class="tok-n">result</span><span class="tok-p">)</span>
<span class="tok-w">        </span><span class="tok-n">assertEquals</span><span class="tok-p">(</span><span class="tok-m">4</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">result</span><span class="tok-p">.</span><span class="tok-na">size</span><span class="tok-p">)</span>
<span class="tok-w">        </span><span class="tok-n">result</span><span class="tok-p">.</span><span class="tok-na">forEach</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">assertTrue</span><span class="tok-p">(</span><span class="tok-nb">it</span><span class="tok-w"> </span><span class="tok-k">is</span><span class="tok-w"> </span><span class="tok-n">KeywordToken</span><span class="tok-p">)</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-n">assertEquals</span><span class="tok-p">(</span><span class="tok-n">listOf</span><span class="tok-p">(</span><span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;few&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;key&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;words&quot;</span><span class="tok-p">),</span><span class="tok-w"> </span><span class="tok-n">result</span><span class="tok-p">.</span><span class="tok-na">map</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-nb">it</span><span class="tok-w"> </span><span class="tok-k">as</span><span class="tok-w"> </span><span class="tok-n">KeywordToken</span><span class="tok-p">).</span><span class="tok-na">keyword</span><span class="tok-w"> </span><span class="tok-p">})</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-c1">// ...</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Unit tests should be implemented during development, before submitting a merge request. These tests should also be run and passed before requesting code reviews.</p>
</div>
</div>
<div class="sect2">
<h3 id="_spring_boot_test">9.2. Spring Boot Test</h3>
<div class="paragraph">
<p>This is about starting a temporary embedded server during tests. <code>@Autowired</code> and mocking inside test classes would work. Some people categorizes this as an integration test. I give it another name to distinguish among embedded Spring Boot server tests, embedded database tests, and end-to-end tests.</p>
</div>
<div class="paragraph">
<p>When you need to test only the service layers or schedule jobs, Spring Boot tests is more suitable than end-to-end integration tests.</p>
</div>
<div class="paragraph">
<p>In Spring Boot tests, usually another set of application properties and beans are provided.</p>
</div>
<details id="schedule-task-test" open>
<summary class="title">An example Spring Boot test</summary>
<div class="content">
<div class="listingblock">
<div class="title">/main/lib/db-mysql/src/test/kotlin/com/gtomato/server/application/messenger/test/common/scheduletask/ConcurrentScheduleJobMysqlSpringTest.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-nd">@SpringBootTest</span><span class="tok-p">(</span>
<span class="tok-w">    </span><span class="tok-n">classes</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-o">[</span><span class="tok-n">ConcurrentScheduleJobMysqlSpringTest</span><span class="tok-p">.</span><span class="tok-na">Application</span><span class="tok-o">::</span><span class="tok-n">class</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">ConcurrentScheduleJobMysqlSpringTest</span><span class="tok-p">.</span><span class="tok-na">TestConfiguration</span><span class="tok-o">::</span><span class="tok-n">class</span><span class="tok-o">]</span><span class="tok-p">,</span>
<span class="tok-w">    </span><span class="tok-n">properties</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-o">[</span>
<span class="tok-w">        </span><span class="tok-s">&quot;spring.r2dbc.url=r2dbcs:mysql://localhost:10101/?sslMode=required&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// use the one in docker compose</span>
<span class="tok-w">        </span><span class="tok-s">&quot;spring.r2dbc.name=test&quot;</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-s">&quot;spring.r2dbc.username=root&quot;</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-s">&quot;spring.r2dbc.password=123&quot;</span><span class="tok-p">,</span>
<span class="tok-w">    </span><span class="tok-o">]</span><span class="tok-p">,</span>
<span class="tok-p">)</span>
<span class="tok-kd">class</span><span class="tok-w"> </span><span class="tok-nc">ConcurrentScheduleJobMysqlSpringTest</span><span class="tok-w"> </span><span class="tok-p">{</span>

<span class="tok-w">    </span><span class="tok-nd">@SpringBootApplication</span><span class="tok-p">(</span><span class="tok-n">scanBasePackages</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-o">[</span>
<span class="tok-w">        </span><span class="tok-s">&quot;com.gtomato.server.application.messenger.test.common.scheduletask&quot;</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-s">&quot;com.gtomato.server.application.messenger.db&quot;</span><span class="tok-p">,</span>
<span class="tok-w">    </span><span class="tok-o">]</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-kd">class</span><span class="tok-w"> </span><span class="tok-nc">Application</span>

<span class="tok-w">    </span><span class="tok-nd">@Configuration</span>
<span class="tok-w">    </span><span class="tok-kd">class</span><span class="tok-w"> </span><span class="tok-nc">TestConfiguration</span><span class="tok-w"> </span><span class="tok-p">{</span>

<span class="tok-w">        </span><span class="tok-nd">@Bean</span><span class="tok-p">(</span><span class="tok-s">&quot;DefaultScheduleTaskProperties&quot;</span><span class="tok-p">)</span>
<span class="tok-w">        </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">defaultScheduleTaskProperties</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ScheduleTaskProperties</span><span class="tok-p">(</span><span class="tok-n">instanceName</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;-&quot;</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">log</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">LogFactory</span><span class="tok-p">.</span><span class="tok-na">getLog</span><span class="tok-p">(</span><span class="tok-n">javaClass</span><span class="tok-p">)</span>

<span class="tok-w">    </span><span class="tok-nd">@Autowired</span>
<span class="tok-w">    </span><span class="tok-kd">lateinit</span><span class="tok-w"> </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">databaseClient</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">DatabaseClient</span>

<span class="tok-w">    </span><span class="tok-nd">@Autowired</span>
<span class="tok-w">    </span><span class="tok-kd">lateinit</span><span class="tok-w"> </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">testScheduleJobRecordRepository</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">TestScheduleJobRecordRepository</span>

<span class="tok-w">    </span><span class="tok-nd">@Autowired</span>
<span class="tok-w">    </span><span class="tok-kd">lateinit</span><span class="tok-w"> </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">testScheduleJobExecuteLogRepository</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">TestScheduleJobExecuteLogRepository</span>

<span class="tok-w">    </span><span class="tok-nd">@Autowired</span>
<span class="tok-w">    </span><span class="tok-kd">lateinit</span><span class="tok-w"> </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">testScheduleTask</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">TestScheduleTask</span>

<span class="tok-w">    </span><span class="tok-nd">@BeforeEach</span>
<span class="tok-w">    </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">beforeEach</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">listOf</span><span class="tok-p">(</span>
<span class="tok-w">            </span><span class="tok-s">&quot;DROP TABLE IF EXISTS test_schedule_job_record;&quot;</span><span class="tok-p">,</span>
<span class="tok-w">            </span><span class="tok-s">&quot;&quot;&quot;</span>
<span class="tok-s">            CREATE TABLE test_schedule_job_record</span>
<span class="tok-s">            (</span>
<span class="tok-s">                id              VARCHAR(255) PRIMARY KEY,</span>
<span class="tok-s">                duplication_key VARCHAR(255) UNIQUE NOT NULL,</span>
<span class="tok-s">                is_active       BIT(1)              NOT NULL,</span>
<span class="tok-s">                version         INTEGER             NOT NULL,</span>
<span class="tok-s">                create_at       TIMESTAMP(6)        NOT NULL,</span>
<span class="tok-s">                last_update_at  TIMESTAMP(6)        NOT NULL,</span>
<span class="tok-s">                locked_until    TIMESTAMP(6)        NOT NULL,</span>
<span class="tok-s">                locked_at       TIMESTAMP(6)        NULL,</span>
<span class="tok-s">                lock_id         VARCHAR(255)        NULL,</span>
<span class="tok-s">                locked_by       VARCHAR(255)        NULL,</span>
<span class="tok-s">                attempts        INTEGER             NOT NULL,</span>
<span class="tok-s">                batch_id        VARCHAR(255)        NOT NULL,</span>
<span class="tok-s">                is_handled      BIT(1)              NOT NULL,</span>
<span class="tok-s">                INDEX `idx_test_schedule_job_record_routine` (</span>
<span class="tok-s">                    `locked_until`, `attempts`, `is_handled`</span>
<span class="tok-s">                ),</span>
<span class="tok-s">                INDEX `idx_test_schedule_job_record_check` (</span>
<span class="tok-s">                    `batch_id`, `is_handled`</span>
<span class="tok-s">                )</span>
<span class="tok-s">            );</span>
<span class="tok-s">            &quot;&quot;&quot;</span><span class="tok-p">.</span><span class="tok-na">trimIndent</span><span class="tok-p">(),</span>

<span class="tok-w">            </span><span class="tok-s">&quot;DROP TABLE IF EXISTS test_schedule_job_execute_log;&quot;</span><span class="tok-p">,</span>

<span class="tok-w">            </span><span class="tok-s">&quot;&quot;&quot;</span>
<span class="tok-s">            CREATE TABLE test_schedule_job_execute_log</span>
<span class="tok-s">            (</span>
<span class="tok-s">                id              VARCHAR(255) PRIMARY KEY,</span>
<span class="tok-s">                duplication_key VARCHAR(255) UNIQUE NOT NULL,</span>
<span class="tok-s">                is_active       BIT(1)              NOT NULL,</span>
<span class="tok-s">                version         INTEGER             NOT NULL,</span>
<span class="tok-s">                create_at       TIMESTAMP(6)        NOT NULL,</span>
<span class="tok-s">                last_update_at  TIMESTAMP(6)        NOT NULL,</span>
<span class="tok-s">                batch_id        VARCHAR(255)        NOT NULL,</span>
<span class="tok-s">                record_id       VARCHAR(255)        NOT NULL,</span>
<span class="tok-s">                INDEX `idx_test_schedule_job_execute_log_check` (</span>
<span class="tok-s">                    `batch_id`, `record_id`</span>
<span class="tok-s">                )</span>
<span class="tok-s">            );</span>
<span class="tok-s">            &quot;&quot;&quot;</span><span class="tok-p">.</span><span class="tok-na">trimIndent</span><span class="tok-p">()</span>
<span class="tok-w">        </span><span class="tok-p">).</span><span class="tok-na">forEach</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">databaseClient</span><span class="tok-p">.</span><span class="tok-na">sql</span><span class="tok-p">(</span><span class="tok-nb">it</span><span class="tok-p">).</span><span class="tok-na">fetch</span><span class="tok-p">().</span><span class="tok-na">rowsUpdated</span><span class="tok-p">().</span><span class="tok-na">block</span><span class="tok-p">()</span>
<span class="tok-w">            </span><span class="tok-n">log</span><span class="tok-p">.</span><span class="tok-na">debug</span><span class="tok-p">(</span><span class="tok-s">&quot;beforeEach execute SQL \&quot;</span><span class="tok-si">$</span><span class="tok-n">it</span><span class="tok-s">\&quot;&quot;</span><span class="tok-p">)</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-kd">suspend</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">insertTestData</span><span class="tok-p">(</span><span class="tok-n">batchId</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">count</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">Long</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">coroutineScope</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-p">(</span><span class="tok-m">1.</span><span class="tok-p">.</span><span class="tok-na">count</span><span class="tok-p">).</span><span class="tok-na">forEach</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                </span><span class="tok-n">launch</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                    </span><span class="tok-n">testScheduleJobRecordRepository</span><span class="tok-p">.</span><span class="tok-na">save</span><span class="tok-p">(</span><span class="tok-n">TestScheduleJobRecord</span><span class="tok-p">().</span><span class="tok-na">also</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                        </span><span class="tok-nb">it</span><span class="tok-p">.</span><span class="tok-na">batchId</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">batchId</span>
<span class="tok-w">                    </span><span class="tok-p">})</span>
<span class="tok-w">                </span><span class="tok-p">}</span>
<span class="tok-w">            </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-nd">@Test</span>
<span class="tok-w">    </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">`multiple instances execute same set of jobs, jobs are executed exactly once`</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">runBlocking</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">batchId</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">UUID</span><span class="tok-p">.</span><span class="tok-na">randomUUID</span><span class="tok-p">().</span><span class="tok-na">toString</span><span class="tok-p">()</span>
<span class="tok-w">        </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">numRecords</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-m">1000L</span>
<span class="tok-w">        </span><span class="tok-n">insertTestData</span><span class="tok-p">(</span><span class="tok-n">batchId</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">batchId</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">count</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">numRecords</span><span class="tok-p">)</span>

<span class="tok-w">        </span><span class="tok-n">assertEquals</span><span class="tok-p">(</span><span class="tok-m">0</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">testScheduleJobExecuteLogRepository</span><span class="tok-p">.</span><span class="tok-na">countByBatchId</span><span class="tok-p">(</span><span class="tok-n">batchId</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">batchId</span><span class="tok-p">))</span>

<span class="tok-w">        </span><span class="tok-n">coroutineScope</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-p">(</span><span class="tok-m">1.</span><span class="tok-p">.</span><span class="tok-m">5</span><span class="tok-p">).</span><span class="tok-na">forEach</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">instanceId</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span><span class="tok-w"> </span><span class="tok-c1">// simulate 5 concurrent instances</span>
<span class="tok-w">                </span><span class="tok-n">launch</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                    </span><span class="tok-p">(</span><span class="tok-m">0.</span><span class="tok-p">.</span><span class="tok-m">9</span><span class="tok-p">).</span><span class="tok-na">forEach</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">second</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span><span class="tok-w"> </span><span class="tok-c1">// simulate execute job every second, do 10 times</span>
<span class="tok-w">                        </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">startTime</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Instant</span><span class="tok-p">.</span><span class="tok-na">now</span><span class="tok-p">()</span>
<span class="tok-w">                        </span><span class="tok-n">testScheduleTask</span><span class="tok-p">.</span><span class="tok-na">execute</span><span class="tok-p">()</span>
<span class="tok-w">                        </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">endTime</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Instant</span><span class="tok-p">.</span><span class="tok-na">now</span><span class="tok-p">()</span>
<span class="tok-w">                        </span><span class="tok-n">assert</span><span class="tok-p">(</span><span class="tok-n">Duration</span><span class="tok-p">.</span><span class="tok-na">between</span><span class="tok-p">(</span><span class="tok-n">startTime</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">endTime</span><span class="tok-p">).</span><span class="tok-na">toMillis</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-w"> </span><span class="tok-m">200</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-c1">// should be very quick</span>

<span class="tok-w">                        </span><span class="tok-n">delay</span><span class="tok-p">(</span><span class="tok-m">1000L</span><span class="tok-p">)</span>
<span class="tok-w">                    </span><span class="tok-p">}</span>
<span class="tok-w">                </span><span class="tok-p">}</span>
<span class="tok-w">            </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-p">}</span>

<span class="tok-w">        </span><span class="tok-n">assertEquals</span><span class="tok-p">(</span><span class="tok-n">numRecords</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">testScheduleJobExecuteLogRepository</span><span class="tok-p">.</span><span class="tok-na">countByBatchId</span><span class="tok-p">(</span><span class="tok-n">batchId</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">batchId</span><span class="tok-p">))</span>
<span class="tok-w">        </span><span class="tok-n">assertEquals</span><span class="tok-p">(</span><span class="tok-n">numRecords</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">testScheduleJobExecuteLogRepository</span><span class="tok-p">.</span><span class="tok-na">countDistinctRecordIdByBatchId</span><span class="tok-p">(</span><span class="tok-n">batchId</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">batchId</span><span class="tok-p">))</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-nd">@Test</span>
<span class="tok-w">    </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">`multiple instances execute a larger set of jobs, jobs are executed exactly once`</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">runBlocking</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">batchId</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">UUID</span><span class="tok-p">.</span><span class="tok-na">randomUUID</span><span class="tok-p">().</span><span class="tok-na">toString</span><span class="tok-p">()</span>
<span class="tok-w">        </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">numRecords</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-m">5000L</span>
<span class="tok-w">        </span><span class="tok-n">insertTestData</span><span class="tok-p">(</span><span class="tok-n">batchId</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">batchId</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">count</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">numRecords</span><span class="tok-p">)</span>

<span class="tok-w">        </span><span class="tok-n">assertEquals</span><span class="tok-p">(</span><span class="tok-m">0</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">testScheduleJobExecuteLogRepository</span><span class="tok-p">.</span><span class="tok-na">countByBatchId</span><span class="tok-p">(</span><span class="tok-n">batchId</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">batchId</span><span class="tok-p">))</span>

<span class="tok-w">        </span><span class="tok-n">coroutineScope</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-p">(</span><span class="tok-m">1.</span><span class="tok-p">.</span><span class="tok-m">5</span><span class="tok-p">).</span><span class="tok-na">forEach</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">instanceId</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span><span class="tok-w"> </span><span class="tok-c1">// simulate 5 concurrent instances</span>
<span class="tok-w">                </span><span class="tok-n">launch</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                    </span><span class="tok-p">(</span><span class="tok-m">0.</span><span class="tok-p">.</span><span class="tok-m">9</span><span class="tok-p">).</span><span class="tok-na">forEach</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">second</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span><span class="tok-w"> </span><span class="tok-c1">// simulate execute job every second, do 10 times</span>
<span class="tok-w">                        </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">startTime</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Instant</span><span class="tok-p">.</span><span class="tok-na">now</span><span class="tok-p">()</span>
<span class="tok-w">                        </span><span class="tok-n">testScheduleTask</span><span class="tok-p">.</span><span class="tok-na">execute</span><span class="tok-p">()</span>
<span class="tok-w">                        </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">endTime</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Instant</span><span class="tok-p">.</span><span class="tok-na">now</span><span class="tok-p">()</span>
<span class="tok-w">                        </span><span class="tok-n">assert</span><span class="tok-p">(</span><span class="tok-n">Duration</span><span class="tok-p">.</span><span class="tok-na">between</span><span class="tok-p">(</span><span class="tok-n">startTime</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">endTime</span><span class="tok-p">).</span><span class="tok-na">toMillis</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-w"> </span><span class="tok-m">200</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-c1">// should be very quick</span>

<span class="tok-w">                        </span><span class="tok-n">delay</span><span class="tok-p">(</span><span class="tok-m">1000L</span><span class="tok-p">)</span>
<span class="tok-w">                    </span><span class="tok-p">}</span>
<span class="tok-w">                </span><span class="tok-p">}</span>
<span class="tok-w">            </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-n">delay</span><span class="tok-p">(</span><span class="tok-m">10</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-m">1000L</span><span class="tok-p">)</span>

<span class="tok-w">        </span><span class="tok-n">assertEquals</span><span class="tok-p">(</span><span class="tok-n">numRecords</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">testScheduleJobExecuteLogRepository</span><span class="tok-p">.</span><span class="tok-na">countByBatchId</span><span class="tok-p">(</span><span class="tok-n">batchId</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">batchId</span><span class="tok-p">))</span>
<span class="tok-w">        </span><span class="tok-n">assertEquals</span><span class="tok-p">(</span><span class="tok-n">numRecords</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">testScheduleJobExecuteLogRepository</span><span class="tok-p">.</span><span class="tok-na">countDistinctRecordIdByBatchId</span><span class="tok-p">(</span><span class="tok-n">batchId</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">batchId</span><span class="tok-p">))</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</details>
</div>
<div class="sect2">
<h3 id="_data_test">9.3. Data Test</h3>
<div class="paragraph">
<p>This is about starting a temporary embedded database during tests. Some people categorizes this as an integration test.</p>
</div>
<div class="paragraph">
<p>Not recommended. Skipping.</p>
</div>
</div>
<div class="sect2">
<h3 id="_integration_test">9.4. Integration Test</h3>
<div class="paragraph">
<p>To perform end-to-end tests, act as client-side to call one or more APIs and verify. An integration test case tests against a use case, a flow, or a storyline.</p>
</div>
<div class="paragraph">
<p>At minimum, integration tests should list and include all known business requirements and listed error cases. Ideally, it should also include unlisted error cases and edge cases.</p>
</div>
<div class="paragraph">
<p>Integration tests should be implemented during development, before submitting a merge request. These tests should also be run and passed before requesting code reviews.</p>
</div>
<div class="sect3">
<h4 id="_end_to_end_tests">9.4.1. End-to-end tests</h4>
<div class="paragraph">
<p>We will need an isolated environment to carry out end-to-end tests. Local environment is usually an ideal choice. It contains isolated database and storage. However, if your local environment connects to third party services or shared storage, you have to think how to decouple from them.</p>
</div>
<div class="paragraph">
<p>Implement a neat integration test is not easy. Improper design will bring below disadvantages which would greatly slow down development:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Unstable test result&#8201;&#8212;&#8201;<a href="#schedule-task-test">sleep-based tests</a>. Test case can fail just because the PC is slow</p>
</li>
<li>
<p>Random result&#8201;&#8212;&#8201;the test implementation makes uses of unreasonable randomness</p>
</li>
<li>
<p>Initialize everything (e.g. login 100 users and create 1000 rows for each user) <em>every time</em> for <em>every test case</em> which each of them only use a few data. Slow down the whole integration test</p>
</li>
<li>
<p>Polluted / Non-isolated environment - the testing result fails because there are some external factors affecting the runtime</p>
</li>
<li>
<p>Forget to remove/invalidate unrelated/testing data&#8201;&#8212;&#8201;the test succeeds, but fails at the second time</p>
</li>
<li>
<p>Hardcoded endpoints&#8201;&#8212;&#8201;that means it cannot be put into CI/CD pipelines.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
In a real project, an unoptimized integration test takes an hour to run, and during the test developers cannot do development (unless they have two PCs). This is a big blocker almost defeats the benefits.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s define a workable structure.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Define the actors.</strong> In this project, we have only one actor&#8201;&#8212;&#8201;an user account.</p>
</li>
<li>
<p><strong>Define the actions of each actor.</strong> For example, a user can "login", "send message", "list chat channels", etc..</p>
</li>
<li>
<p><strong>Define HTTP API interfaces.</strong> Define the API calls for each HTTP repository. We will use <a href="https://square.github.io/retrofit/">Retrofit</a> here, which enables defining API interfaces could almost implement all the HTTP calls.</p>
</li>
<li>
<p><strong>Bind HTTP API calls to actors' actions.</strong> This is an implementation step.</p>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="_example_test_casecreate_a_chat_channel_send_a_message_to_the_channel_and_received_by_other_users">Example Test Case&#8201;&#8212;&#8201;Create a chat channel, send a message to the channel and received by other users</h5>
<div class="paragraph">
<p>The title is self-explanatory. I will use it as the test function name. Let&#8217;s start from scratch.</p>
</div>
<div class="paragraph">
<p><code>ApiContext</code> is a <em>per-user</em> class holding endpoint configuration and HTTP client implementation. I will skip this.</p>
</div>
<div class="paragraph">
<p><code>User</code> is our first actor.</p>
</div>
<div class="listingblock">
<div class="title">/main/integration-test/src/test/kotlin/com/gtomato/server/application/messenger/integrationtest/actor/User.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-kd">data</span><span class="tok-w"> </span><span class="tok-kd">class</span><span class="tok-w"> </span><span class="tok-nc">User</span><span class="tok-p">(</span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">context</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">ApiContext</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">username</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">password</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">String</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">Actor</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">accessToken</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">String?</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-kc">null</span>
<span class="tok-w">    </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">refreshToken</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">String?</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-kc">null</span>
<span class="tok-w">    </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">id</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">String?</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-kc">null</span>

<span class="tok-w">    </span><span class="tok-k">init</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">context</span><span class="tok-p">.</span><span class="tok-na">attachUser</span><span class="tok-p">(</span><span class="tok-k">this</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Each <code>User</code> has some actions they can perform.</p>
</div>
<div class="listingblock">
<div class="title">/main/integration-test/src/test/kotlin/com/gtomato/server/application/messenger/integrationtest/actor/ChatChannel.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-kd">data</span><span class="tok-w"> </span><span class="tok-kd">class</span><span class="tok-w"> </span><span class="tok-nc">ChatChannel</span><span class="tok-p">(</span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">participantUsers</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">User</span><span class="tok-o">&gt;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">admins</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">User</span><span class="tok-o">&gt;</span><span class="tok-p">):</span><span class="tok-w"> </span><span class="tok-n">Actor</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-nv">id</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-kt">String?</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-kc">null</span>
<span class="tok-p">}</span>

<span class="tok-kd">suspend</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-n">User</span><span class="tok-p">.</span><span class="tok-nf">listChannels</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">context</span><span class="tok-p">.</span><span class="tok-na">messageService</span><span class="tok-p">.</span><span class="tok-na">listChannels</span><span class="tok-p">()</span>

<span class="tok-kd">suspend</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-n">User</span><span class="tok-p">.</span><span class="tok-nf">createChannel</span><span class="tok-p">(</span><span class="tok-n">channel</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">ChatChannel</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">context</span><span class="tok-p">.</span><span class="tok-na">messageService</span><span class="tok-p">.</span><span class="tok-na">createChannel</span><span class="tok-p">(</span><span class="tok-n">CreateChannelPayload</span><span class="tok-p">(</span>
<span class="tok-w">    </span><span class="tok-n">name</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">channel</span><span class="tok-p">.</span><span class="tok-na">name</span><span class="tok-p">,</span>
<span class="tok-w">    </span><span class="tok-n">participantIds</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">channel</span><span class="tok-p">.</span><span class="tok-na">participantUsers</span><span class="tok-p">.</span><span class="tok-na">map</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-nb">it</span><span class="tok-p">.</span><span class="tok-na">id</span><span class="tok-o">!!</span><span class="tok-w"> </span><span class="tok-p">}.</span><span class="tok-na">toSet</span><span class="tok-p">(),</span>
<span class="tok-w">    </span><span class="tok-n">adminIds</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">channel</span><span class="tok-p">.</span><span class="tok-na">admins</span><span class="tok-p">.</span><span class="tok-na">map</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-nb">it</span><span class="tok-p">.</span><span class="tok-na">id</span><span class="tok-o">!!</span><span class="tok-w"> </span><span class="tok-p">}.</span><span class="tok-na">toSet</span><span class="tok-p">(),</span>
<span class="tok-p">)).</span><span class="tok-na">also</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">channel</span><span class="tok-p">.</span><span class="tok-na">id</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">it</span><span class="tok-p">.</span><span class="tok-na">id</span>
<span class="tok-p">}</span>

<span class="tok-c1">// ...</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Function <code>User.listChannels</code> and <code>User.createChannel</code> are <a href="https://kotlinlang.org/docs/extensions.html#extension-functions">extension functions</a>. In Kotlin, it is <em>like</em> adding member functions to the <code>User</code> class. In underlying JVM bytecode or in Java, it is actually normal static functions with an extra <code>User</code> parameter.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Bind them to HTTP calls.</p>
</div>
<div class="listingblock">
<div class="title">/main/integration-test/src/test/kotlin/com/gtomato/server/application/messenger/integrationtest/service/MessageService.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-kd">interface</span><span class="tok-w"> </span><span class="tok-nc">MessageService</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nd">@POST</span><span class="tok-p">(</span><span class="tok-s">&quot;/channel&quot;</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-kd">suspend</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">createChannel</span><span class="tok-p">(</span><span class="tok-nd">@Body</span><span class="tok-w"> </span><span class="tok-n">payload</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">CreateChannelPayload</span><span class="tok-p">):</span><span class="tok-w"> </span><span class="tok-n">CreationResource</span>

<span class="tok-w">    </span><span class="tok-nd">@GET</span><span class="tok-p">(</span><span class="tok-s">&quot;/channel&quot;</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-kd">suspend</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">listChannels</span><span class="tok-p">():</span><span class="tok-w"> </span><span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">ChatChannelResource</span><span class="tok-o">&gt;</span>

<span class="tok-w">    </span><span class="tok-c1">// ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, we are about to start writing a test case.</p>
</div>
<div class="listingblock">
<div class="title">/main/integration-test/src/test/kotlin/com/gtomato/server/application/messenger/integrationtest/test/ChannelAndMessageTest.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-kd">class</span><span class="tok-w"> </span><span class="tok-nc">ChannelAndMessageTest</span><span class="tok-w"> </span><span class="tok-p">{</span>

<span class="tok-w">    </span><span class="tok-kd">companion</span><span class="tok-w"> </span><span class="tok-kd">object</span><span class="tok-w"> </span><span class="tok-err">{</span>
<span class="tok-w">        </span><span class="tok-nd">@JvmStatic</span>
<span class="tok-w">        </span><span class="tok-nd">@BeforeAll</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">        </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">setup</span><span class="tok-p">():</span><span class="tok-w"> </span><span class="tok-kt">Unit</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">runBlocking</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">CONTEXT</span><span class="tok-p">.</span><span class="tok-na">loginAllUsers</span><span class="tok-p">()</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-nd">@Test</span>
<span class="tok-w">    </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">`create channel, send message and receive message by other users`</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">runBlocking</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">participants</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">listOf</span><span class="tok-p">(</span><span class="tok-n">CONTEXT</span><span class="tok-p">.</span><span class="tok-na">user1</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">CONTEXT</span><span class="tok-p">.</span><span class="tok-na">user2</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">CONTEXT</span><span class="tok-p">.</span><span class="tok-na">user3</span><span class="tok-p">)</span>
<span class="tok-w">        </span><span class="tok-n">createTemporaryChatChannel</span><span class="tok-p">(</span><span class="tok-n">participants</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">participants</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">admin</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">CONTEXT</span><span class="tok-p">.</span><span class="tok-na">user1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">channel</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span><span class="tok-w"> </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">            </span><span class="tok-c1">// send some messages</span>
<span class="tok-w">            </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">messages</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-m">1.</span><span class="tok-p">.</span><span class="tok-m">4</span><span class="tok-p">).</span><span class="tok-na">map</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-s">&quot;My message </span><span class="tok-si">${</span><span class="tok-n">UUID</span><span class="tok-p">.</span><span class="tok-na">randomUUID</span><span class="tok-p">()</span><span class="tok-si">}</span><span class="tok-s">&quot;</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"> </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-w">            </span><span class="tok-n">messages</span><span class="tok-p">.</span><span class="tok-na">dropLast</span><span class="tok-p">(</span><span class="tok-m">1</span><span class="tok-p">).</span><span class="tok-na">forEach</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">message</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span>
<span class="tok-w">                </span><span class="tok-n">CONTEXT</span><span class="tok-p">.</span><span class="tok-na">user1</span><span class="tok-p">.</span><span class="tok-na">createMessage</span><span class="tok-p">(</span><span class="tok-n">channel</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">channel</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">content</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">message</span><span class="tok-p">)</span><span class="tok-w"> </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-w">            </span><span class="tok-p">}</span>
<span class="tok-w">            </span><span class="tok-n">messages</span><span class="tok-p">.</span><span class="tok-na">last</span><span class="tok-p">().</span><span class="tok-na">let</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">message</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span>
<span class="tok-w">                </span><span class="tok-n">CONTEXT</span><span class="tok-p">.</span><span class="tok-na">user2</span><span class="tok-p">.</span><span class="tok-na">createMessage</span><span class="tok-p">(</span><span class="tok-n">channel</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">channel</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">content</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">message</span><span class="tok-p">)</span><span class="tok-w"> </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-w">            </span><span class="tok-p">}</span>

<span class="tok-w">            </span><span class="tok-n">coroutineScope</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                </span><span class="tok-n">participants</span><span class="tok-p">.</span><span class="tok-na">forEach</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">u</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span><span class="tok-w"> </span><i class="conum" data-value="5"></i><b>(5)</b>
<span class="tok-w">                    </span><span class="tok-n">launch</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                        </span><span class="tok-c1">// the message order is always sorted by sent time ascending</span>
<span class="tok-w">                        </span><span class="tok-n">u</span><span class="tok-p">.</span><span class="tok-na">listMessages</span><span class="tok-p">(</span><span class="tok-n">channel</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">channel</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">timeTo</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Instant</span><span class="tok-p">.</span><span class="tok-na">now</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">size</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-m">10</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">direction</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Direction</span><span class="tok-p">.</span><span class="tok-na">DESC</span><span class="tok-p">)</span><span class="tok-w"> </span><i class="conum" data-value="5"></i><b>(5)</b>
<span class="tok-w">                            </span><span class="tok-p">.</span><span class="tok-na">also</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                                </span><span class="tok-n">assertEquals</span><span class="tok-p">(</span><span class="tok-n">messages</span><span class="tok-p">.</span><span class="tok-na">size</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-nb">it</span><span class="tok-p">.</span><span class="tok-na">size</span><span class="tok-p">)</span><span class="tok-w"> </span><i class="conum" data-value="5"></i><b>(5)</b>
<span class="tok-w">                                </span><span class="tok-n">assertEquals</span><span class="tok-p">(</span><span class="tok-n">messages</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-nb">it</span><span class="tok-p">.</span><span class="tok-na">map</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-nb">it</span><span class="tok-p">.</span><span class="tok-na">content</span><span class="tok-w"> </span><span class="tok-p">})</span><span class="tok-w"> </span><i class="conum" data-value="5"></i><b>(5)</b>
<span class="tok-w">                            </span><span class="tok-p">}</span>
<span class="tok-w">                    </span><span class="tok-p">}</span>
<span class="tok-w">                </span><span class="tok-p">}</span>
<span class="tok-w">            </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-c1">// ...</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">/main/integration-test/src/test/kotlin/com/gtomato/server/application/messenger/integrationtest/helper/ChannelHelper.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-kd">suspend</span><span class="tok-w"> </span><span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-nf">createTemporaryChatChannel</span><span class="tok-p">(</span><span class="tok-n">participants</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">User</span><span class="tok-o">&gt;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">admin</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">User</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">operation</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">suspend</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">ChatChannel</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span><span class="tok-w"> </span><span class="tok-kt">Unit</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">admin</span><span class="tok-w"> </span><span class="tok-k">!in</span><span class="tok-w"> </span><span class="tok-n">participants</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">throw</span><span class="tok-w"> </span><span class="tok-n">IllegalArgumentException</span><span class="tok-p">(</span><span class="tok-s">&quot;admin should be one of the participants&quot;</span><span class="tok-p">)</span>

<span class="tok-w">    </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">channel</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ChatChannel</span><span class="tok-p">(</span>
<span class="tok-w">        </span><span class="tok-n">name</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;Integration Test Chat Channel </span><span class="tok-si">${</span><span class="tok-n">UUID</span><span class="tok-p">.</span><span class="tok-na">randomUUID</span><span class="tok-p">()</span><span class="tok-si">}</span><span class="tok-s">&quot;</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">participantUsers</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">participants</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">admins</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">listOf</span><span class="tok-p">(</span><span class="tok-n">admin</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-n">coroutineScope</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">participants</span><span class="tok-p">.</span><span class="tok-na">forEach</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">u</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span>
<span class="tok-w">            </span><span class="tok-n">launch</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                </span><span class="tok-k">try</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                    </span><span class="tok-n">u</span><span class="tok-p">.</span><span class="tok-na">inactivateAllChannels</span><span class="tok-p">()</span><span class="tok-w"> </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">                </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">catch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">_</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">Throwable</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{}</span>
<span class="tok-w">            </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-c1">// before doing any test, inactivate all channels so that it does not affect testing result </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">    </span><span class="tok-n">coroutineScope</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">participants</span><span class="tok-p">.</span><span class="tok-na">forEach</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">u</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span>
<span class="tok-w">            </span><span class="tok-n">u</span><span class="tok-p">.</span><span class="tok-na">listChannels</span><span class="tok-p">().</span><span class="tok-na">filter</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-nb">it</span><span class="tok-p">.</span><span class="tok-na">isActive</span><span class="tok-w"> </span><span class="tok-p">}.</span><span class="tok-na">also</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                </span><span class="tok-n">assertEquals</span><span class="tok-p">(</span><span class="tok-m">0</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-nb">it</span><span class="tok-p">.</span><span class="tok-na">size</span><span class="tok-p">)</span>
<span class="tok-w">            </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-c1">// create a group channel</span>
<span class="tok-w">    </span><span class="tok-n">admin</span><span class="tok-p">.</span><span class="tok-na">createChannel</span><span class="tok-p">(</span><span class="tok-n">channel</span><span class="tok-p">)</span><span class="tok-w"> </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">    </span><span class="tok-k">try</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">coroutineScope</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">participants</span><span class="tok-p">.</span><span class="tok-na">forEach</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">u</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span>
<span class="tok-w">                </span><span class="tok-n">launch</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                    </span><span class="tok-n">u</span><span class="tok-p">.</span><span class="tok-na">listChannels</span><span class="tok-p">().</span><span class="tok-na">assertActiveChatChannelsOnlyContain</span><span class="tok-p">(</span><span class="tok-n">listOf</span><span class="tok-p">(</span><span class="tok-n">channel</span><span class="tok-p">))</span>
<span class="tok-w">                    </span><span class="tok-n">u</span><span class="tok-p">.</span><span class="tok-na">listMessages</span><span class="tok-p">(</span><span class="tok-n">channel</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">channel</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">timeTo</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Instant</span><span class="tok-p">.</span><span class="tok-na">now</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">size</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-m">10</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">direction</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Direction</span><span class="tok-p">.</span><span class="tok-na">DESC</span><span class="tok-p">)</span>
<span class="tok-w">                        </span><span class="tok-p">.</span><span class="tok-na">also</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                            </span><span class="tok-n">Assertions</span><span class="tok-p">.</span><span class="tok-na">assertEquals</span><span class="tok-p">(</span><span class="tok-m">0</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-nb">it</span><span class="tok-p">.</span><span class="tok-na">size</span><span class="tok-p">)</span><span class="tok-w"> </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">                        </span><span class="tok-p">}</span>
<span class="tok-w">                </span><span class="tok-p">}</span>
<span class="tok-w">            </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-p">}</span>

<span class="tok-w">        </span><span class="tok-n">operation</span><span class="tok-p">(</span><span class="tok-n">channel</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">finally</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">admin</span><span class="tok-p">.</span><span class="tok-na">inactivateChannel</span><span class="tok-p">(</span><span class="tok-n">channel</span><span class="tok-p">)</span><span class="tok-w"> </span><i class="conum" data-value="6"></i><b>(6)</b>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Initialize the context&#8201;&#8212;&#8201;login all the test users. It runs before all the test cases <em>in this class</em>. It is not maximally optimized, but is better than running before every test case.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Before starting the test, cleanup the environment first to ensure the test case starts at a consistent point.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Real test case begins. Create a chat channel, and verify this channel should contain no message.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Create some messages in the channel. 2 users are used to make the test case less hardcoded (although still hardcoded). The message content is not hardcoded though.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Finally, for every user in the channel, we verify if they all received the same messages in the desired order.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>After finally, remove the testing data to keep the environment still friendly to the developer and upcoming tests.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Hopefully, you have an idea about integration test now.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_concurrent_test">9.4.2. Concurrent Test</h4>
<div class="paragraph">
<p>The purpose of concurrent test is to find out possible logic bugs or trivial performance issues under a concurrent (multi-threaded and multi-process) environment.</p>
</div>
<div class="paragraph">
<p>A concurrent test case may run an integration test case using multiple threads / coroutines.</p>
</div>
<div class="listingblock">
<div class="title">/main/integration-test/src/test/kotlin/com/gtomato/server/application/messenger/integrationtest/test/concurrent/ConcurrentMessageTest.kt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-nd">@Test</span>
<span class="tok-kd">fun</span><span class="tok-w"> </span><span class="tok-err">`</span><span class="tok-nf">concurrent</span><span class="tok-w"> </span><span class="tok-n">send</span><span class="tok-w"> </span><span class="tok-m">10</span><span class="tok-w"> </span><span class="tok-err"></span><span class="tok-w"> </span><span class="tok-m">10</span><span class="tok-w"> </span><span class="tok-n">messages</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">should</span><span class="tok-w"> </span><span class="tok-n">receive</span><span class="tok-w"> </span><span class="tok-n">back</span><span class="tok-w"> </span><span class="tok-m">100</span><span class="tok-w"> </span><span class="tok-n">messages</span><span class="tok-err">`</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">runBlocking</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">users</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">CONTEXT</span><span class="tok-p">.</span><span class="tok-na">allUsers</span><span class="tok-p">.</span><span class="tok-na">take</span><span class="tok-p">(</span><span class="tok-m">10</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-n">assertEquals</span><span class="tok-p">(</span><span class="tok-m">10</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">users</span><span class="tok-p">.</span><span class="tok-na">size</span><span class="tok-p">)</span>

<span class="tok-w">    </span><span class="tok-n">createTemporaryChatChannel</span><span class="tok-p">(</span><span class="tok-n">participants</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">users</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">admin</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">users</span><span class="tok-p">.</span><span class="tok-na">last</span><span class="tok-p">())</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">channel</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span>
<span class="tok-w">        </span><span class="tok-c1">// initially there is no message in the new channel</span>
<span class="tok-w">        </span><span class="tok-n">users</span><span class="tok-p">.</span><span class="tok-na">first</span><span class="tok-p">().</span><span class="tok-na">listMessages</span><span class="tok-p">(</span><span class="tok-n">channel</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">channel</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">timeTo</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Instant</span><span class="tok-p">.</span><span class="tok-na">now</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">size</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-m">10</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">direction</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Direction</span><span class="tok-p">.</span><span class="tok-na">DESC</span><span class="tok-p">)</span>
<span class="tok-w">            </span><span class="tok-p">.</span><span class="tok-na">also</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">result</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span>
<span class="tok-w">                </span><span class="tok-n">assertEquals</span><span class="tok-p">(</span><span class="tok-m">0</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">result</span><span class="tok-p">.</span><span class="tok-na">size</span><span class="tok-p">)</span>
<span class="tok-w">            </span><span class="tok-p">}</span>

<span class="tok-w">        </span><span class="tok-c1">// send 10 * 10 messages</span>
<span class="tok-w">        </span><span class="tok-n">coroutineScope</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">            </span><span class="tok-n">users</span><span class="tok-p">.</span><span class="tok-na">forEachIndexed</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">userIndex</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">user</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span>
<span class="tok-w">                </span><span class="tok-p">(</span><span class="tok-m">0.</span><span class="tok-p">.</span><span class="tok-m">9</span><span class="tok-p">).</span><span class="tok-na">forEach</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">messageIndex</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span>
<span class="tok-w">                    </span><span class="tok-n">launch</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">                        </span><span class="tok-kd">val</span><span class="tok-w"> </span><span class="tok-nv">message</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;Concurrent message </span><span class="tok-si">${</span><span class="tok-n">messageIndex</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-m">1</span><span class="tok-si">}</span><span class="tok-s"> from user #</span><span class="tok-si">${</span><span class="tok-n">userIndex</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-m">1</span><span class="tok-si">}</span><span class="tok-s">&quot;</span>
<span class="tok-w">                        </span><span class="tok-n">println</span><span class="tok-p">(</span><span class="tok-s">&quot;Send message: </span><span class="tok-si">$</span><span class="tok-n">message</span><span class="tok-s">&quot;</span><span class="tok-p">)</span>
<span class="tok-w">                        </span><span class="tok-n">user</span><span class="tok-p">.</span><span class="tok-na">createMessage</span><span class="tok-p">(</span><span class="tok-n">channel</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">channel</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">content</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">message</span><span class="tok-p">)</span>
<span class="tok-w">                    </span><span class="tok-p">}</span>
<span class="tok-w">                </span><span class="tok-p">}</span>
<span class="tok-w">            </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-p">}</span>

<span class="tok-w">        </span><span class="tok-c1">// retrieve back messages for each user</span>
<span class="tok-w">        </span><span class="tok-n">coroutineScope</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">users</span><span class="tok-p">.</span><span class="tok-na">forEach</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">user</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span>
<span class="tok-w">                </span><span class="tok-n">launch</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                    </span><span class="tok-n">user</span><span class="tok-p">.</span><span class="tok-na">listMessages</span><span class="tok-p">(</span><span class="tok-n">channel</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">channel</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">timeTo</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Instant</span><span class="tok-p">.</span><span class="tok-na">now</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">size</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-m">10</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-m">10</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-m">5</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">direction</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Direction</span><span class="tok-p">.</span><span class="tok-na">DESC</span><span class="tok-p">)</span>
<span class="tok-w">                        </span><span class="tok-p">.</span><span class="tok-na">also</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">result</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span>
<span class="tok-w">                            </span><span class="tok-n">assertEquals</span><span class="tok-p">(</span><span class="tok-m">10</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-m">10</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">result</span><span class="tok-p">.</span><span class="tok-na">size</span><span class="tok-p">)</span>
<span class="tok-w">                        </span><span class="tok-p">}</span>
<span class="tok-w">                </span><span class="tok-p">}</span>
<span class="tok-w">            </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>launch {}</code> launches a new coroutine asynchronously. It is <em>like</em> launching a new thread in Java. A coroutine is similar to a thread, but is light-weight.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>coroutineScope {}</code> waits for all children coroutines to complete before continue. If there is an exception, the whole coroutineScope would be cancelled.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Learn more about Kotlin coroutines in <a href="https://kotlinlang.org/docs/coroutines-basics.html">Kotlin official documentation</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_testing_stack">9.4.3. Testing Stack</h4>
<div class="ulist">
<ul>
<li>
<p>Kotlin 1.8</p>
</li>
<li>
<p>Java 17</p>
</li>
<li>
<p>JUnit</p>
</li>
<li>
<p>Kotlinx Coroutines</p>
</li>
<li>
<p>Retrofit</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Spring is intentionally excluded to keep the test lightweight and easier to maintain, although this means we cannot reuse Spring Cloud OpenFeign.</p>
</div>
</div>
<div class="sect3">
<h4 id="_dependencies_and_other_gradle_configuration">9.4.4. Dependencies and Other Gradle Configuration</h4>
<div class="paragraph">
<p>DRY. We will not repeat the request and response payload models. Just include the <code>*-transport</code> modules as dependencies to import those models.</p>
</div>
<div class="listingblock">
<div class="title">/main/integration-test/build.gradle.kts</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-n">plugins</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">id</span><span class="tok-p">(</span><span class="tok-s">&quot;messenger.kotlin&quot;</span><span class="tok-p">)</span>
<span class="tok-p">}</span>

<span class="tok-n">dependencies</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">testImplementation</span><span class="tok-p">(</span><span class="tok-n">project</span><span class="tok-p">(</span><span class="tok-s">&quot;:profile-transport&quot;</span><span class="tok-p">))</span>
<span class="tok-w">    </span><span class="tok-n">testImplementation</span><span class="tok-p">(</span><span class="tok-n">project</span><span class="tok-p">(</span><span class="tok-s">&quot;:message-transport&quot;</span><span class="tok-p">))</span>
<span class="tok-w">    </span><span class="tok-n">testImplementation</span><span class="tok-p">(</span><span class="tok-n">project</span><span class="tok-p">(</span><span class="tok-s">&quot;:file-transport&quot;</span><span class="tok-p">))</span>
<span class="tok-w">    </span><span class="tok-c1">// ...</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Configure JUnit to output passed tests and error logs, so that we know the tests are really executed and passed or not.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The <code>test</code> gradle tasks and its variants are all cacheable. If you do not <code>clean</code>, the second <code>test</code> run succeeds but actually does nothing.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">/main/buildSrc/src/main/kotlin/messenger.kotlin.gradle.kts</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="kotlin"><span></span><span class="tok-n">tasks</span><span class="tok-p">.</span><span class="tok-na">withType</span><span class="tok-o">&lt;</span><span class="tok-n">Test</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">useJUnitPlatform</span><span class="tok-p">()</span>
<span class="tok-w">    </span><span class="tok-n">testLogging</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">events</span><span class="tok-p">(</span><span class="tok-s">&quot;passed&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;skipped&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;failed&quot;</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_load_test">9.5. Load Test</h3>
<div class="paragraph">
<p>We carry out load tests is to identify and fix issues under an expected high volume of loads. Commonly found issues include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Too slow to respond or never respond&#8201;&#8212;&#8201;check if database indexes are missing, and if there is a loop of I/O calls</p>
</li>
<li>
<p>Crash&#8201;&#8212;&#8201;out of memory</p>
</li>
<li>
<p>Misbehave&#8201;&#8212;&#8201;improper or missing concurrent handling causes data loss or incorrect data state, e.g. two customers pay at the same time, but only one of them receive the product</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Concurrent handling tests should be implemented in unit tests or integration tests.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We can use <a href="https://jmeter.apache.org/"><strong>JMeter</strong></a> to carry out load tests.</p>
</div>
<div class="paragraph">
<p>Discuss with PM (and the client) and QA about the scope, expected input and output.</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. Example Load Test Requirements</div>
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Test Input</p>
<div class="ulist">
<ul>
<li>
<p>Number of <em>concurrent connections</em>: 300</p>
</li>
<li>
<p>300 different user accounts</p>
</li>
<li>
<p>Any other testing data to be created beforehand?</p>
</li>
</ul>
</div>
</li>
<li>
<p>Expected result / Passing line</p>
<div class="ulist">
<ul>
<li>
<p>95% of requests are responded within 3 seconds</p>
</li>
<li>
<p>Error rate is within 0.5% (excluding intended and network errors)</p>
</li>
<li>
<p>Does not apply to file uploads and downloads, which are affected by network bandwidth and file size. They should have different passing lines:</p>
<div class="ulist">
<ul>
<li>
<p>For file size &lt; 5 MB</p>
<div class="ulist">
<ul>
<li>
<p>Error rate is within 5%</p>
</li>
<li>
<p>95% of requests are responded within 15 seconds</p>
</li>
</ul>
</div>
</li>
<li>
<p>For file size  5 MB and  30 MB</p>
<div class="ulist">
<ul>
<li>
<p>Error rate is within 15%</p>
</li>
<li>
<p>90% of requests are responded within 50 seconds</p>
</li>
</ul>
</div>
</li>
<li>
<p>For file size &gt; 30 MB</p>
<div class="ulist">
<ul>
<li>
<p>Unsupported</p>
</li>
</ul>
</div>
</li>
<li>
<p>Above assumes all the networks involved are stable and have a bandwidth of at least 2 Gbps</p>
</li>
</ul>
</div>
</li>
<li>
<p>The time should exclude third party&#8217;s execution time, or carry out a multiple-party load tests with lower expectations</p>
</li>
</ul>
</div>
</li>
<li>
<p>Scope</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>App Launch &#8594; Login with username &amp; password &#8594; List Message Channels</p>
</li>
<li>
<p>App Launch &#8594; Login with refresh token &#8594; List Message Channels &#8594; List Messages of a channel &#8594; Send Message &#8594; List Messages of the same channel</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Number of concurrent connections and number of concurrently active users are completely different concepts.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Number of concurrent connections</dt>
<dd>
<p>Number of concurrent threads calling APIs without delays</p>
</dd>
<dt class="hdlist1">Number of concurrently active users</dt>
<dd>
<p>Number of active users at a time. Like a real user, they do not non-stop call APIs, but with some delays.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Usually, the client only discusses the maximum number of concurrently active users. Developers have to convert this number into maximum number of concurrent connections. This conversion involves considerations of application usage, may be 5% of maximum number of concurrently active users. For an application requiring frequently polling, it could be 20%. For lucky draw promotions that every user will rush in at the same moment, it could be 80% or more.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The required bandwidth can be calculated:</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{align*}
300 \text{ concurrent connections } \times \frac{30 \text{ MB }}{50 \text{ seconds }} \\
&amp;= 180 \text{ MB/s} \\
&amp;= 0.18 \text{ GB/s} \\
&amp;= 1.38 \text{ Gbps}
\end{align*}\]
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The interested area of the test output is in aggregate reports. An aggregate report looks like this:</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="https://jmetervn.com/2016/10/10/analyze-the-aggregate-report-in-jmeter/"><img src="images/jmeter-aggregate-report.png" alt="jmeter aggregate report"></a>
</div>
<div class="title">Figure 2. Sample Aggregate Report</div>
</div>
<div class="paragraph">
<p>Load tests should be run multiple times:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>at the end of the development stage</p>
</li>
<li>
<p>at the end of UAT (because bug fixes can create new performance issues)</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_stress_test">9.6. Stress Test</h3>
<div class="paragraph">
<p>It is similar to load tests. The difference is stress test looks for the maximum capacity limit of the system, by repeatedly carrying out load tests with incremental higher number of concurrent connections. Stress tests do not have a passing line as well.</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="https://queue-it.com/blog/load-vs-stress-testing/"><img src="images/load-testing-vs-stress-testing.png" alt="load testing vs stress testing"></a>
</div>
<div class="title">Figure 3. Difference between load test and stress test</div>
</div>
<div class="paragraph">
<p>We can still use JMeter to carry out stress tests.</p>
</div>
<div class="paragraph">
<p>Stress tests can be run at the end of UAT, after passing load tests.</p>
</div>
</div>
<div class="sect2">
<h3 id="_recommendations_for_development_phase_tests">9.7. Recommendations for Development-phase Tests</h3>
<div class="paragraph">
<p>To test correctness of utility functions or classes,</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Unit Test &gt; Integration Test &gt; Spring Boot Test</p>
</div>
</div>
</div>
<div class="paragraph">
<p>To test functionalities,</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Integration Test &gt; Unit Test &gt; Spring Boot Test</p>
</div>
</div>
</div>
<div class="paragraph">
<p>To test business journeys,</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Integration Test &gt; Load Test</p>
</div>
</div>
</div>
<div class="paragraph">
<p>To test for race conditions,</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Integration Test / Spring Boot Test &gt; Load Test</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_getting_started">10. Getting Started</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_run_a_local_cluster">10.1. Run a local cluster</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start Docker Desktop</p>
</li>
<li>
<p>Run <code>./rebuild-and-up.sh</code></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_run_unit_tests_spring_boot_tests">10.2. Run unit tests / Spring Boot tests</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Run <code>cd ./main &amp;&amp; ./gradlew :&lt;module-name&gt;:clean :&lt;module-name&gt;:test</code></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_run_integration_tests">10.3. Run integration tests</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#_run_a_local_cluster">Run a local cluster</a> and wait for everything is up</p>
</li>
<li>
<p>Run <code>cd ./main &amp;&amp; ./gradlew :integration-test:clean :integration-test:test</code></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_run_all_the_tests">10.4. Run all the tests</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#_run_a_local_cluster">Run a local cluster</a> and wait for everything is up</p>
</li>
<li>
<p>Run <code>cd ./main &amp;&amp; ./gradlew cleanTest cleanCheck check</code></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_generate_documentation">10.5. Generate Documentation</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Grab a docker image containing both <code>asciidoctor</code> and <code>mermaid-cli</code></p>
</li>
<li>
<p>Run:</p>
</li>
</ol>
</div>
<div class="literalblock">
<div class="content">
<pre>cd ./manual
./generate.sh</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2024-03-20 08:26:13 UTC
</div>
</div>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains("stemblock")) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</body>
</html>